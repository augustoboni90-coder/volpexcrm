<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VOLPEX CRM</title>

<!-- FONT + RESET -->
<style>
    :root {
      --bg: #f3f4f8;
      --bg-alt: #e5e7f0;
      --card: #ffffff;
      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.12);
      --text: #111827;
      --text-soft: #6b7280;
      --border: #d1d5db;
      --success:#22c55e;
      --danger:#ef4444;
      --sidebar-width:240px;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e5e7f5 0,#f9fafb 40%,#eef2ff 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      font-size:14px;
    }

    a { color:var(--accent); text-decoration:none; }
    .layout { display:flex; width:100%; }

    /* SIDEBAR */
    .sidebar {
      width:var(--sidebar-width);
      background:linear-gradient(180deg,#e5e7f5,#f9fafb);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      padding:16px 12px;
      gap:16px;
    }

    .logo {
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#ffffff;
      box-shadow:0 4px 10px rgba(148,163,184,0.25);
    }

    .logo-icon {
      width:32px; height:32px; border-radius:999px;
      background:conic-gradient(from 210deg,#fb923c,#fbbf24,#22c55e,#06b6d4,#6366f1,#fb923c);
      display:flex; align-items:center; justify-content:center;
      font-weight:800; color:white; font-size:14px;
      box-shadow:0 0 0 2px #fff;
    }
    .logo-text-main { font-weight:700; letter-spacing:0.06em; text-transform:uppercase; font-size:13px; }
    .logo-text-sub { font-size:11px; color:var(--text-soft); }

    .sidebar-section-title {
      font-size:11px; text-transform:uppercase; letter-spacing:0.12em;
      color:var(--text-soft); margin:10px 4px 4px;
    }

    .nav { display:flex; flex-direction:column; gap:4px; }

    .nav-btn {
      width:100%; border:none; text-align:left;
      padding:8px 10px; border-radius:999px;
      background:transparent; color:var(--text-soft);
      display:flex; align-items:center; gap:8px;
      cursor:pointer; transition:0.15s; font-size:13px;
    }
    .nav-btn.active, .nav-btn:hover {
      background:rgba(249,115,22,0.08);
      color:#111827;
    }

    .sidebar-footer {
      margin-top:auto; font-size:11px; color:var(--text-soft);
      border-top:1px solid var(--border); padding-top:10px;
    }

    .badge {
      display:inline-flex; align-items:center; gap:4px;
      padding:2px 6px; border-radius:999px;
      background:rgba(148,163,184,0.2);
      font-size:10px; margin-top:4px;
    }
    .badge span.dot {
      width:6px; height:6px; border-radius:999px;
      background:#22c55e;
    }

    /* MAIN LAYOUT */
    .main {
      flex:1; display:flex; flex-direction:column;
      padding:16px 18px; gap:12px;
    }
    .top-bar {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .top-title {
      font-size:18px; font-weight:600;
      display:flex; align-items:baseline; gap:8px;
    }
    .top-sub { font-size:12px; color:var(--text-soft); }

    .btn-primary {
      border:none; padding:6px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,#fb923c,#f97316);
      color:#fff; font-size:13px; font-weight:600;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(249,115,22,0.4);
    }

    .btn-outline {
      border-radius:999px; padding:5px 10px;
      border:1px solid var(--border);
      background:#fff; color:var(--text-soft);
      font-size:12px; cursor:pointer;
    }

    .btn-outline:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:#fff7ed;
    }

    .btn-success {
      padding:6px 12px;
      border-radius:999px;
      background:#22c55e;
      border:none;
      color:#fff;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
    }

    .section { display:none; }
    .section.active { display:block; }

    .card {
      background:white;
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      box-shadow:0 10px 25px rgba(148,163,184,0.18);
      margin-bottom:12px;
    }

    .card-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:6px;
    }
    .card-title { text-transform:uppercase; font-size:13px; font-weight:600; letter-spacing:0.04em; }
    .card-subtitle { font-size:11px; color:var(--text-soft); }

    .table-wrapper {
      border-radius:10px; border:1px solid var(--border);
      background:white; overflow-y:auto; max-height:240px;
    }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { padding:4px 6px; border-bottom:1px solid #e5e7eb; }
    th { background:#f3f4f6; font-weight:500; color:var(--text-soft); }
    tr:hover { background:#f9fafb; cursor:pointer; }
</style>

<!-- PAPA PARSE (PER IMPORT CSV) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

</head>
<body>
<div class="layout">
<!-- SIDEBAR -->
<aside class="sidebar">

    <div class="logo">
        <div class="logo-icon">V</div>
        <div>
            <div class="logo-text-main">VOLPEX</div>
            <div class="logo-text-sub">CRM Google Sheets</div>
        </div>
    </div>

    <div class="sidebar-section-title">Navigazione</div>

    <div class="nav">
        <button class="nav-btn active" data-target="sec-dashboard" onclick="switchSection('sec-dashboard')">
            <span class="icon">üè†</span>
            <span>Dashboard</span>
        </button>

        <button class="nav-btn" data-target="sec-nuovo" onclick="switchSection('sec-nuovo')">
            <span class="icon">üìÑ</span>
            <span>Nuovo contratto</span>
        </button>

        <button class="nav-btn" data-target="sec-device" onclick="switchSection('sec-device')">
            <span class="icon">üì±</span>
            <span>Vendita device</span>
        </button>

        <button class="nav-btn" data-target="sec-riparazioni" onclick="switchSection('sec-riparazioni')">
            <span class="icon">üõ†Ô∏è</span>
            <span>Riparazioni</span>
        </button>

        <button class="nav-btn" data-target="sec-import" onclick="switchSection('sec-import')">
            <span class="icon">‚¨ÜÔ∏è</span>
            <span>Import CSV</span>
        </button>

        <button class="nav-btn" data-target="sec-report" onclick="switchSection('sec-report')">
            <span class="icon">üìä</span>
            <span>Report</span>
        </button>
    </div>

    <div class="sidebar-section-title">Info</div>

    <div class="sidebar-footer">
        <div>VOLPEX CRM collegato a Google Sheets</div>
        <div class="badge">
            <span class="dot"></span>
            <span>Online</span>
        </div>
    </div>

</aside>

<!-- MAIN -->
<main class="main">

    <div class="top-bar">
        <div>
            <div class="top-title">
                VOLPEX CRM
                <span class="top-sub">Gestione clienti, contratti, device e riparazioni</span>
            </div>
        </div>

        <div class="top-actions">
            <div class="pill">Foglio: <strong>VOLPEX</strong></div>
            <button type="button" class="btn-outline" onclick="refreshAll()">Aggiorna dati</button>
        </div>
    </div>

    <div class="content">
        <div class="left-column">
<!-- DASHBOARD -->
<section class="section active" id="sec-dashboard">

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Riepilogo veloce
            </div>
            <div class="card-subtitle">
                Panoramica clienti, contratti e attivit√† oggi
            </div>
        </div>

        <div class="grid grid-3">

            <div class="kpi-card">
                <div class="kpi-label">Clienti totali</div>
                <div class="kpi-value" id="kpiTotClienti">-</div>
                <div class="kpi-tag">Anagrafica</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Contratti totali</div>
                <div class="kpi-value" id="kpiTotContratti">-</div>
                <div class="kpi-tag">Mobile / Fisso</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Device venduti</div>
                <div class="kpi-value" id="kpiTotDevice">-</div>
                <div class="kpi-tag">Vendite terminali</div>
            </div>

        </div>

        <div class="grid grid-3" style="margin-top:8px;">

            <div class="kpi-card">
                <div class="kpi-label">Riparazioni totali</div>
                <div class="kpi-value" id="kpiTotRiparazioni">-</div>
                <div class="kpi-tag">Assistenza tecnica</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Compleanni oggi</div>
                <div class="kpi-value" id="kpiCompleanniOggi">-</div>
                <div class="kpi-tag">Da contattare</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Scadenze mese</div>
                <div class="kpi-value" id="kpiScadenzeMese">-</div>
                <div class="kpi-tag">Fine vincoli offerte</div>
            </div>

        </div>
    </div>

</section>


<!-- NUOVO CLIENTE + CONTRATTO -->
<section class="section" id="sec-nuovo">

    <div class="card">

        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Nuovo cliente + contratto
            </div>
            <div class="card-subtitle">
                Se il cliente non esiste viene creato in automatico dal codice fiscale.
            </div>
        </div>

        <form id="formNewClienteContratto">
            <div class="section-body">

                <!-- DATI CLIENTE -->
                <div class="badge-soft">Dati cliente</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Nome</label>
                        <input id="nc_nome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Cognome</label>
                        <input id="nc_cognome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Telefono</label>
                        <input id="nc_telefono_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Email</label>
                        <input id="nc_email_cliente" type="email" />
                    </div>

                    <div class="form-field">
                        <label>Codice fiscale *</label>
                        <input id="nc_cf_cliente" type="text" required />
                    </div>

                    <div class="form-field">
                        <label>Data nascita</label>
                        <input id="nc_data_nascita_cliente" type="date" />
                    </div>

                    <div class="form-field" style="grid-column: span 2;">
                        <label>Note cliente</label>
                        <input id="nc_note_cliente" type="text" />
                    </div>

                </div>

                <!-- DATI CONTRATTO -->
                <div class="badge-soft" style="margin-top:6px;">Dati contratto</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Data contratto</label>
                        <input id="nc_data_contratto" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Tipo cliente</label>
                        <select id="nc_tipo_cliente">
                            <option value="">Seleziona</option>
                            <option value="Privato">Privato</option>
                            <option value="Azienda">Azienda</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Tipo attivazione</label>
                        <select id="nc_tipo_attivazione">
                            <option value="">Seleziona</option>
                            <option value="Mobile">Mobile</option>
                            <option value="Fisso">Fisso</option>
                            <option value="Luce">Luce</option>
                            <option value="Gas">Gas</option>
                            <option value="TV">TV</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Tecnologia</label>
                        <select id="nc_tecnologia">
                            <option value="">Seleziona</option>
                            <option value="SIM">SIM</option>
                            <option value="FTTC">FTTC</option>
                            <option value="FTTH">FTTH</option>
                            <option value="ADSL">ADSL</option>
                            <option value="FWA">FWA</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Compagnia</label>
                        <input id="nc_compagnia" type="text" placeholder="Vodafone, TIM..." />
                    </div>

                    <div class="form-field">
                        <label>Convergenza</label>
                        <select id="nc_convergenza">
                            <option value="">Seleziona</option>
                            <option value="NO">No</option>
                            <option value="SI">S√¨</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>MNP</label>
                        <select id="nc_mnp">
                            <option value="">Seleziona</option>
                            <option value="NO">No</option>
                            <option value="SI">S√¨</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>ICCID vecchio</label>
                        <input id="nc_iccid_vecchio" type="text" />
                    </div>

                    <div class="form-field">
                        <label>ICCID nuovo</label>
                        <input id="nc_iccid_nuovo" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Data attivazione</label>
                        <input id="nc_data_attivazione" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Data portabilit√†</label>
                        <input id="nc_data_portabilita" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Numero lavorato</label>
                        <input id="nc_numero_lavorato" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Nome offerta</label>
                        <input id="nc_nome_offerta" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Costo offerta ‚Ç¨</label>
                        <input id="nc_costo_offerta" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Vincolo offerta (mesi)</label>
                        <input id="nc_vincolo_offerta_mesi" type="number" />
                    </div>

                    <div class="form-field">
                        <label>Telefono incluso</label>
                        <select id="nc_telefono_incluso">
                            <option value="">Seleziona</option>
                            <option value="NO">No</option>
                            <option value="SI">S√¨</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>IMEI telefono</label>
                        <input id="nc_imei" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Modello telefono</label>
                        <input id="nc_modello" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Tipo pagamento</label>
                        <select id="nc_tipo_pagamento">
                            <option value="">Seleziona</option>
                            <option value="Contanti">Contanti</option>
                            <option value="Carta">Carta</option>
                            <option value="Addebito in conto">Addebito in conto</option>
                            <option value="Finanziamento">Finanziamento</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Mesi vincolo telefono</label>
                        <input id="nc_mesi_vincolo_telefono" type="number" />
                    </div>

                    <div class="form-field">
                        <label>Fine vincolo offerta</label>
                        <input id="nc_data_fine_vincolo_offerta" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Fine vincolo telefono</label>
                        <input id="nc_data_fine_vincolo_telefono" type="date" />
                    </div>

                </div>

                <div class="form-actions">
                    <button class="btn-primary" type="submit">
                        <span id="nc_submit_label">Salva cliente + contratto</span>
                    </button>
                </div>

            </div>
        </form>

    </div>

</section>
<!-- VENDITA DEVICE -->
<section class="section" id="sec-device">

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Vendita device
            </div>
            <div class="card-subtitle">
                Il cliente viene creato in automatico se non esiste.
            </div>
        </div>

        <form id="formDevice">
            <div class="section-body">

                <!-- DATI CLIENTE -->
                <div class="badge-soft">Dati cliente</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Codice fiscale *</label>
                        <input id="dv_cf_cliente" type="text" required />
                    </div>

                    <div class="form-field">
                        <label>Nome</label>
                        <input id="dv_nome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Cognome</label>
                        <input id="dv_cognome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Telefono</label>
                        <input id="dv_telefono_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Email</label>
                        <input id="dv_email_cliente" type="email" />
                    </div>

                </div>

                <!-- DATI DEVICE -->
                <div class="badge-soft" style="margin-top:6px;">Dati device</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Data vendita</label>
                        <input id="dv_data_vendita" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Marca</label>
                        <input id="dv_marca" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Modello</label>
                        <input id="dv_modello" type="text" />
                    </div>

                    <div class="form-field">
                        <label>IMEI</label>
                        <input id="dv_imei" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Prezzo ‚Ç¨</label>
                        <input id="dv_prezzo" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Tipo pagamento</label>
                        <select id="dv_tipo_pagamento">
                            <option value="">Seleziona</option>
                            <option value="Contanti">Contanti</option>
                            <option value="Carta">Carta</option>
                            <option value="Finanziamento">Finanziamento</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Durata finanziamento (mesi)</label>
                        <input id="dv_durata_finanziamento" type="number" />
                    </div>

                    <div class="form-field">
                        <label>Anticipo ‚Ç¨</label>
                        <input id="dv_anticipo" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Costo rata ‚Ç¨</label>
                        <input id="dv_costo_rata" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Fine finanziamento</label>
                        <input id="dv_data_fine_finanziamento" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Garanzia (mesi)</label>
                        <input id="dv_garanzia_mesi" type="number" />
                    </div>

                    <div class="form-field">
                        <label>Fine garanzia</label>
                        <input id="dv_data_fine_garanzia" type="date" />
                    </div>

                    <div class="form-field" style="grid-column: span 2;">
                        <label>Note</label>
                        <input id="dv_note" type="text" />
                    </div>

                </div>

                <div class="form-actions">
                    <button class="btn-primary" type="submit">
                        Salva vendita device
                    </button>
                </div>

            </div>
        </form>

    </div>

</section>



<!-- RIPARAZIONI -->
<section class="section" id="sec-riparazioni">

    <div class="card">

        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Nuova riparazione
            </div>
            <div class="card-subtitle">
                Gestione assistenze con stato e costi.
            </div>
        </div>

        <form id="formRiparazione">
            <div class="section-body">

                <!-- DATI CLIENTE -->
                <div class="badge-soft">Dati cliente</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Codice fiscale *</label>
                        <input id="rp_cf_cliente" type="text" required />
                    </div>

                    <div class="form-field">
                        <label>Nome</label>
                        <input id="rp_nome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Cognome</label>
                        <input id="rp_cognome_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Telefono</label>
                        <input id="rp_telefono_cliente" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Email</label>
                        <input id="rp_email_cliente" type="email" />
                    </div>

                </div>

                <!-- DATI RIPARAZIONE -->
                <div class="badge-soft" style="margin-top:6px;">Dati riparazione</div>

                <div class="form-grid">

                    <div class="form-field">
                        <label>Data apertura</label>
                        <input id="rp_data_apertura" type="date" />
                    </div>

                    <div class="form-field">
                        <label>Marca</label>
                        <input id="rp_marca" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Modello</label>
                        <input id="rp_modello" type="text" />
                    </div>

                    <div class="form-field">
                        <label>IMEI</label>
                        <input id="rp_imei" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Tipo guasto</label>
                        <input id="rp_tipo_guasto" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Stato</label>
                        <select id="rp_stato">
                            <option value="">Seleziona</option>
                            <option value="Aperta">Aperta</option>
                            <option value="In lavorazione">In lavorazione</option>
                            <option value="Chiusa">Chiusa</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label>Costo previsto ‚Ç¨</label>
                        <input id="rp_costo_previsto" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Costo effettivo ‚Ç¨</label>
                        <input id="rp_costo_effettivo" type="number" step="0.01" />
                    </div>

                    <div class="form-field">
                        <label>Data chiusura</label>
                        <input id="rp_data_chiusura" type="date" />
                    </div>

                    <div class="form-field" style="grid-column: span 2;">
                        <label>Note</label>
                        <input id="rp_note" type="text" />
                    </div>

                </div>

                <div class="form-actions">
                    <button class="btn-primary" type="submit">
                        Salva riparazione
                    </button>
                </div>

            </div>
        </form>

    </div>

</section>
<!-- IMPORT CSV -->
<section class="section" id="sec-import">

    <!-- ====== BLOCCO MAPPATURA CSV ====== -->
    <div id="csv-mapping" class="card" style="margin-top:20px; display:none;">
        
        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Mappatura colonne CSV
            </div>
            <div class="card-subtitle">
                Associa ogni campo del CRM alla colonna del tuo file CSV.
            </div>
        </div>

        <div class="card-body">

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Campo CRM</th>
                        <th>Colonna CSV</th>
                    </tr>
                </thead>
                <tbody id="mapping-container"></tbody>
            </table>

            <button class="btn-primary" style="margin-top:10px;" onclick="confirmCsvMapping()">
                Salva Mappatura
            </button>

        </div>
    </div>

    <!-- ======= BLOCCO IMPORT PRINCIPALE ======= -->
    <div class="card">

        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Import CSV clienti + contratti
            </div>

            <div class="card-subtitle">
                Puoi INCOLLARE o CARICARE un file CSV.  
                Il sistema riconosce automaticamente quasi ogni formato.
            </div>

            <!-- FILE UPLOAD -->
            <div style="margin-top:10px;">
                <label for="importFile"><strong>Carica file CSV</strong></label>
                <input type="file" id="importFile" accept=".csv" onchange="importCsvFile(event)">
            </div>
        </div>

        <div class="section-body">

            <!-- TEXTAREA INCOLLA CSV -->
            <div class="form-field">
                <label>Incolla qui i dati CSV (con intestazione)</label>
                <textarea id="csvRaw" rows="6" placeholder="Incolla qui..."></textarea>
            </div>

            <div class="form-actions">
                <button class="btn-outline" type="button" onclick="previewImport()">Anteprima</button>
                <button class="btn-primary" type="button" onclick="runImport()">Importa CSV</button>
            </div>

            <div style="font-size:12px; color:var(--text-soft);" id="importSummary">Nessuna importazione eseguita.</div>

            <!-- PROGRESS BAR -->
            <div class="progress-bar-container">
                <div id="importProgress" class="progress-bar"></div>
            </div>

            <!-- ANTEPRIMA CSV -->
            <div class="table-wrapper" style="max-height:200px; margin-top:10px;">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Telefono</th>
                            <th>Codice fiscale</th>
                            <th>Data contratto</th>
                            <th>Compagnia</th>
                            <th>Tecnologia</th>
                            <th>Numero</th>
                            <th>Offerta</th>
                        </tr>
                    </thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
            </div>

            <hr style="margin:15px 0;">

            <!-- BUTTON IMPORT SMART 100% -->
            <button class="btn-success" style="margin-top:10px;" onclick="doSmartImport()">
                IMPORT SMART COMPLETO ‚úîÔ∏è
            </button>

        </div>
    </div>

</section>
<!-- REPORT & SCADENZE -->
<section class="section" id="sec-report">

    <div class="card">

        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Report & Scadenze
            </div>
            <div class="card-subtitle">
                Compleanni, filtri contratti, scadenze vincoli, export CSV.
            </div>
        </div>

        <div class="section-body">

            <!-- COMPLEANNI OGGI -->
            <div class="badge-soft">Compleanni di oggi</div>

            <div class="table-wrapper" style="max-height:120px;">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Telefono</th>
                            <th>CF</th>
                            <th>Data nascita</th>
                        </tr>
                    </thead>
                    <tbody id="tabCompleanni"></tbody>
                </table>
            </div>

            <!-- CONTRATTI PER COMPAGNIA / TECNOLOGIA -->
            <div class="badge-soft" style="margin-top:12px;">Contratti per compagnia / tecnologia</div>

            <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">

                <div class="form-field">
                    <label>Compagnia</label>
                    <select id="rep_compagnia">
                        <option value="">Tutte</option>
                    </select>
                </div>

                <div class="form-field">
                    <label>Tecnologia</label>
                    <select id="rep_tecnologia">
                        <option value="">Tutte</option>
                    </select>
                </div>

                <div class="form-field">
                    <label>&nbsp;</label>
                    <button class="btn-outline" type="button" onclick="applyContrattiFiltro()">
                        Applica filtro
                    </button>
                </div>
            </div>

            <div class="table-wrapper" style="max-height:140px;">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>CF</th>
                            <th>Compagnia</th>
                            <th>Tecnologia</th>
                            <th>Numero</th>
                        </tr>
                    </thead>
                    <tbody id="tabContrattiFiltro"></tbody>
                </table>
            </div>

            <!-- SCADENZE VINCOLI -->
            <div class="badge-soft" style="margin-top:12px;">Scadenze vincoli offerta (mese/anno)</div>

            <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">

                <div class="form-field">
                    <label>Mese</label>
                    <select id="rep_mese">
                        <option value="">Seleziona</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>

                <div class="form-field">
                    <label>Anno</label>
                    <select id="rep_anno">
                        <option value="">Seleziona</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                    </select>
                </div>

                <div class="form-field">
                    <label>&nbsp;</label>
                    <button class="btn-outline" type="button" onclick="applyScadenzeFiltro()">
                        Mostra scadenze
                    </button>
                </div>

            </div>

            <div class="table-wrapper" style="max-height:150px;">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>CF</th>
                            <th>Compagnia</th>
                            <th>Offerta</th>
                            <th>Fine vincolo</th>
                        </tr>
                    </thead>
                    <tbody id="tabScadenze"></tbody>
                </table>
            </div>

            <!-- ESPORTA PER PERIODO -->
            <div class="badge-soft" style="margin-top:12px;">
                Esporta CSV contratti per periodo (Data contratto)
            </div>

            <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">

                <div class="form-field">
                    <label>Dal</label>
                    <input id="rep_exp_da" type="date" />
                </div>

                <div class="form-field">
                    <label>Al</label>
                    <input id="rep_exp_a" type="date" />
                </div>

                <div class="form-field">
                    <label>&nbsp;</label>
                    <button class="btn-outline" type="button" onclick="exportContrattiPeriodo()">
                        Esporta CSV
                    </button>
                </div>

            </div>

        </div>
    </div>

</section>
<!-- COLONNA DESTRA: CLIENTI & STORICO -->
<div class="right-column">

    <section class="card">

        <div class="card-header">
            <div class="card-title">
                <span class="card-title-dot"></span>
                Clienti & storico
            </div>
            <div class="card-subtitle">
                Seleziona un cliente per vedere contratti, device e riparazioni.
            </div>
        </div>

        <!-- üîç RICERCA CLIENTE -->
        <div class="form-field" style="margin-bottom:6px;">
            <label>Ricerca cliente</label>
            <input id="searchClienteTerm" placeholder="Nome, cognome, CF o telefono" type="text" />
        </div>

        <!-- üìã LISTA CLIENTI -->
        <div class="table-wrapper" style="max-height:180px;margin-bottom:6px;">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Telefono</th>
                        <th>CF</th>
                    </tr>
                </thead>
                <tbody id="tabClienti"></tbody>
            </table>
        </div>

        <div id="noClienteSelezionato" style="font-size:12px;color:var(--text-soft);">
            Seleziona un cliente per vedere i dettagli.
        </div>

        <!-- üìå CARD DETTAGLIO CLIENTE -->
        <div class="card hidden" id="clienteCard" style="margin-top:6px;padding:8px;">

            <div class="card-header" style="margin-bottom:4px;">
                <div class="card-title">
                    <span class="card-title-dot"></span> Anagrafica cliente
                </div>
            </div>

            <!-- üîé INFO CLIENTE -->
            <div class="cliente-summary">

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Nome</div>
                    <div id="detNome"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Cognome</div>
                    <div id="detCognome"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Telefono</div>
                    <div id="detTelefono"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Email</div>
                    <div id="detEmail"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Cod. fiscale</div>
                    <div id="detCF"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Data nascita</div>
                    <div id="detNascita"></div>
                </div>

                <div class="cliente-summary-row">
                    <div class="cliente-summary-label">Note</div>
                    <div id="detNote"></div>
                </div>
            </div>

            <!-- üîß AZIONI CLIENTE -->
            <div class="form-actions" style="justify-content:flex-start;margin-top:6px;">

                <button class="btn-outline" type="button" onclick="openEditCliente()">
                    Modifica cliente
                </button>

                <button class="btn-outline" type="button" onclick="openWhatsappForSelected()">
                    WhatsApp
                </button>

                <button class="btn-outline" type="button" onclick="exportClientePDF()">
                    Esporta PDF
                </button>

            </div>

            <!-- ‚úèÔ∏è FORM PER MODIFICA CLIENTE -->
            <div class="section-body hidden" id="editClienteForm" style="margin-top:4px;">

                <div class="form-grid">

                    <div class="form-field">
                        <label>Nome</label>
                        <input id="ec_nome" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Cognome</label>
                        <input id="ec_cognome" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Telefono</label>
                        <input id="ec_telefono" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Email</label>
                        <input id="ec_email" type="email" />
                    </div>

                    <div class="form-field">
                        <label>Codice fiscale</label>
                        <input id="ec_cf" type="text" />
                    </div>

                    <div class="form-field">
                        <label>Data nascita</label>
                        <input id="ec_data_nascita" type="date" />
                    </div>

                    <div class="form-field" style="grid-column: span 2;">
                        <label>Note</label>
                        <input id="ec_note" type="text" />
                    </div>

                </div>

                <div class="form-actions" style="margin-top:4px;">

                    <button class="btn-outline" type="button" onclick="cancelEditCliente()">
                        Annulla
                    </button>

                    <button class="btn-primary" type="button" onclick="saveEditCliente()">
                        Salva modifiche
                    </button>

                </div>
            </div>

            <!-- üìö STORICO CONTRATTI -->
            <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico contratti
            </div>

            <div class="table-wrapper" style="max-height:110px;margin-top:2px;">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Compagnia</th>
                            <th>Tecnologia</th>
                            <th>Numero</th>
                        </tr>
                    </thead>
                    <tbody id="tabContrattiCliente"></tbody>
                </table>
            </div>

            <!-- üì± STORICO DEVICE -->
            <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico device
            </div>

            <div class="table-wrapper" style="max-height:110px;margin-top:2px;">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Modello</th>
                            <th>IMEI</th>
                        </tr>
                    </thead>
                    <tbody id="tabDeviceCliente"></tbody>
                </table>
            </div>

            <!-- üõ† STORICO RIPARAZIONI -->
            <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico riparazioni
            </div>

            <div class="table-wrapper" style="max-height:110px;margin-top:2px;">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Modello</th>
                            <th>Guasto</th>
                        </tr>
                    </thead>
                    <tbody id="tabRiparazioniCliente"></tbody>
                </table>
            </div>

        </div>

    </section>

</div> <!-- fine right-column -->
<script>
<!-- ===============================
     PARTE 10 - IMPORT CSV AVANZATO + IMPORT SMART
     =============================== -->

<script>

/* ====================================================
   SUPPORTO LETTURA CSV (incolla nel textarea)
   ==================================================== */

function parseImportText() {
    const raw = document.getElementById("csvRaw").value || "";
    const lines = raw
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l.length > 0);

    if (lines.length < 2) return [];

    function splitLine(line) {
        if (line.indexOf("\t") !== -1) return line.split("\t");
        if (line.indexOf(";") !== -1) return line.split(";");
        return line.split(",");
    }

    const header = splitLine(lines[0]);
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
        const cols = splitLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => {
            obj[h.trim()] = cols[idx] || "";
        });
        rows.push(obj);
    }
    return rows;
}


/* ====================================================
   ANTEPRIMA CSV BASE
   ==================================================== */

function previewImport() {
    const rows = parseImportText();
    importRows = rows;

    const tbody = document.getElementById("csvPreviewBody");
    const summary = document.getElementById("importSummary");
    const bar = document.getElementById("importProgress");

    if (tbody) tbody.innerHTML = "";
    if (bar) bar.style.width = "0%";

    if (!rows.length) {
        if (summary) summary.textContent = "CSV vuoto o non valido.";
        return;
    }

    rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${r["Nome"] || ""}</td>
            <td>${r["Cognome"] || ""}</td>
            <td>${r["Telefono"] || ""}</td>
            <td>${r["Codice fiscale"] || ""}</td>
            <td>${r["Data contratto"] || ""}</td>
            <td>${r["Compagnia"] || ""}</td>
            <td>${r["Tecnologia"] || ""}</td>
            <td>${r["Numero lavorato"] || ""}</td>
            <td>${r["Nome offerta"] || ""}</td>`;
        tbody.appendChild(tr);
    });

    if (summary) {
        summary.textContent = `Anteprima: ${rows.length} righe pronte.`;
    }
}


/* ====================================================
   UTILITY DI MAPPATURA CSV SMART
   ==================================================== */

function smartDate(val) {
    if (!val) return "";
    val = val.toString().trim();

    if (!isNaN(val) && val.length < 6) {
        let origin = new Date(1899, 11, 30);
        let d = new Date(origin.getTime() + val * 86400000);
        return d.toISOString().split("T")[0];
    }

    if (/^[0-9]{1,2}[\/\-][0-9]{1,2}[\/\-][0-9]{2,4}$/.test(val)) {
        let parts = val.includes("/") ? val.split("/") : val.split("-");
        let d = parts[0].padStart(2, "0");
        let m = parts[1].padStart(2, "0");
        let y = parts[2];
        if (y.length === 2) y = "20" + y;
        return `${y}-${m}-${d}`;
    }

    if (/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/.test(val)) return val;

    return "";
}

function toNumber(val) {
    if (!val) return 0;
    return parseFloat(val.toString().replace(",", ".").replace("‚Ç¨", "")) || 0;
}


/* ====================================================
   GENERATORI RECORD SMART
   ==================================================== */

function generateCliente(row) {
    return {
        nome: row["Nome"] || "",
        cognome: row["Cognome"] || "",
        telefono: row["Telefono"] || "",
        email: row["Email"] || "",
        cf: (row["Codice fiscale"] || row["CF"] || "").toUpperCase(),
        dataNascita: "",
        note: ""
    };
}

function generateContratto(row) {
    return {
        dataContratto: smartDate(row["Data contratto"]),
        compagnia: row["Compagnia"] || "",
        tipoCliente: row["Tipo cliente"] || "",
        tipoContratto: row["Tipo attivazione"] || "",
        mnp: row["MNP"] || "",
        tariffa: row["Nome offerta"] || "",
        numero: row["Numero lavorato"] || "",
        costo: toNumber(row["Costo offerta"]),
        vincolo: toNumber(row["Vincolo"]),
        dataFineVincolo: smartDate(row["Data fine vincolo"]),
        dataPortabilita: smartDate(row["Data portabilit√†"]),
        tecnologia: row["Tecnologia"] || "",
        iccid: row["ICCID nuovo"] || "",
        dataAttivazione: smartDate(row["Data attivazione"]),
        note: ""
    };
}

function generateDevice(row) {
    if (!row["IMEI"]) return null;
    return {
        dataVendita: smartDate(row["Data contratto"]),
        nomeDevice: row["Modello"] || "",
        tipoDevice: row["Tecnologia"] || "",
        imei: row["IMEI"] || "",
        tipoPagamento: row["Tipo pagamento"] || "",
        durataPagamento: toNumber(row["Durata pagamento"]),
        valoreCliente: 0,
        note: ""
    };
}


/* ====================================================
   IMPORT SMART COMPLETO
   ==================================================== */

function doSmartImport() {

    if (!importRows.length) {
        alert("Nessun dato da importare!");
        return;
    }

    const records = importRows.map(row => ({
        cliente: generateCliente(row),
        contratto: generateContratto(row),
        vendita: generateDevice(row)
    }));

    fetch(API_BASE, {
        method: "POST",
        body: JSON.stringify({
            action: "importSmart",
            records: records
        })
    })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                alert("IMPORT SMART COMPLETATO ‚úîÔ∏è\nRighe importate: " + res.count);
                refreshAll();
            } else {
                alert("Errore IMPORT SMART: " + res.error);
            }
        })
        .catch(err => {
            alert("Errore durante l'import: " + err);
        });
}


/* ====================================================
   AVVIO AUTOMATICO PAGINA
   ==================================================== */

document.addEventListener("DOMContentLoaded", function () {
    switchSection("sec-dashboard");
    setupForms();
    refreshAll();
});
</script>

</body>
</html>
