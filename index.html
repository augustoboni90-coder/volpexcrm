<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VOLPEX CRM ‚Äì PRO Dashboard (CRUD + CSV + PDF + Grafici)</title>
  <style>

    :root{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6e9f0;

      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --primary-soft:#eff6ff;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --shadow: 0 10px 25px rgba(15, 23, 42, .06);
      --shadow-sm: 0 6px 16px rgba(15, 23, 42, .05);

      --radius:16px;
      --radius-sm:12px;
      --ring: 0 0 0 4px rgba(37, 99, 235, .12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    a{color:inherit}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:290px;
      background:linear-gradient(180deg,#0b1220 0%, #0b1220 55%, #0d172a 100%);
      color:#e5e7eb;
      padding:16px;
      position:sticky;top:0;height:100vh;overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    .main{flex:1;display:flex;flex-direction:column;min-width:0}

    .content{
      max-width:1320px;
      margin:0 auto;
      width:100%;
      padding:0 18px;
    }

    /* Sidebar header */
    .logo{
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoMark{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(37,99,235,.18);
      border:1px solid rgba(37,99,235,.35);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      font-weight:950;
      color:#bfdbfe;
    }
    .sub{color:rgba(229,231,235,.7);font-size:12px;margin:8px 0 12px}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      font-size:11px;border:1px solid rgba(191,219,254,.35);
      background:rgba(37,99,235,.12);
      color:#bfdbfe;padding:3px 10px;border-radius:999px;font-weight:900;
      margin-left:auto;
    }

    /* Sidebar nav */
    .nav{margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .nav button{
      width:100%;
      padding:10px 12px;
      border:none;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      text-align:left;
      cursor:pointer;
      color:rgba(229,231,235,.85);
      display:flex;
      gap:10px;
      align-items:center;
      transition: .15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      background:rgba(255,255,255,.06);
      border-color: rgba(191,219,254,.25);
    }
    .nav button.active{
      background:rgba(37,99,235,.14);
      border-color: rgba(191,219,254,.35);
      color:#bfdbfe;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      position:relative;
    }
    .nav button.active::before{
      content:"";
      position:absolute;
      left:-16px;
      top:10px;
      bottom:10px;
      width:3px;
      border-radius:999px;
      background:#60a5fa;
    }

    .sideCard{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      background:rgba(255,255,255,.03);
      backdrop-filter: blur(8px);
    }
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:rgba(229,231,235,.75);margin-top:8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(245,247,251,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px 0;
    }
    .topbarInner{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #pageTitle{margin:0;font-size:16px;letter-spacing:-.2px}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Views */
    .view{display:none;padding:18px 0}
    .view.active{display:block}

    /* Cards */
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow-sm);
    }
    .card h3{margin:0 0 8px 0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .smallNote{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:12px 0}

    /* KPI */
    .kpi-label{font-size:12px;color:var(--muted)}
    .kpi-value{font-size:30px;font-weight:950;letter-spacing:-.7px;line-height:1.05}
    .kpi-sub{font-size:12px;color:var(--muted);margin-top:2px}

    /* Inputs */
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--text);
      outline:none;
      transition:.12s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--ring);
    }
    textarea{min-height:88px;resize:vertical}

    /* Buttons */
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: .12s ease;
      box-shadow:none;
    }
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-2);transform:translateY(-1px)}
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .btn.secondary:hover{transform:translateY(-1px)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.danger:hover{transform:translateY(-1px)}
    .btn.small{padding:8px 12px;font-size:12px}

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{
      color:var(--muted);
      text-align:left;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      position:sticky;
      top:0;
      background:#fff;
      z-index:2;
    }
    tbody tr:hover{background:#f7f9ff}
    tbody tr:nth-child(even){background:rgba(241,245,249,.35)}
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: var(--radius);
    }
    .tableWrap table{border-radius: var(--radius);}

    /* Badges */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      background:var(--primary-soft);
      color:#1d4ed8;
      font-weight:900;
      border:1px solid #c7d2fe
    }
    .badge.good{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .badge.warn{background:#fef9c3;color:#854d0e;border-color:#fde68a}
    .badge.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    /* Timeline */
    .timeline{border-left:3px solid var(--border);padding-left:14px}
    .tItem{margin:12px 0}
    .tTitle{font-weight:950}
    .tMeta{color:var(--muted);font-size:12px;margin-top:3px}

    /* Charts */
    canvas{width:100%;height:260px;border:1px solid var(--border);border-radius:14px;background:#fff}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:50;
      background:#0f172a;color:#fff;padding:10px 12px;border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.15);max-width:520px;display:none
    }
    .toast.show{display:block}

    /* Print */
    @media print{
      .sidebar,.topbar,.btn,.toolbar input[type="file"]{display:none!important}
      .view{display:block!important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #ddd}
      th{position:static}
      canvas{height:220px}
    }

    /* Responsive */
    @media (max-width: 980px){
      .sidebar{position:fixed;left:-320px;top:0;bottom:0;z-index:40;transition:.2s ease}
      .sidebar.open{left:0}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .content{padding:0 14px}
    }

  
/* === UX v16 (ordine/leggibilit√†) === */
body{line-height:1.35}
.view{padding-bottom:28px}
.card{border:1px solid rgba(2,6,23,.08); box-shadow:0 6px 18px rgba(2,6,23,.06)}
.hr{margin:14px 0}
.toolbar{gap:10px; flex-wrap:wrap}
.toolbar .right{gap:8px; flex-wrap:wrap}
input,select,textarea{
  font-size:14px;
  min-height:38px;
  padding:8px 10px;
  border-radius:10px;
}
input::placeholder, textarea::placeholder{color:rgba(15,23,42,.55)}
select{background-color:#fff}
.grid{gap:10px}
.grid.grid-4{grid-template-columns:repeat(4,minmax(180px,1fr))}
@media (max-width:1100px){.grid.grid-4{grid-template-columns:repeat(2,minmax(180px,1fr))}}
@media (max-width:720px){.grid.grid-4{grid-template-columns:1fr}}
.btn{border-radius:10px}
.btn.small{padding:7px 10px}
.muted{font-size:12.5px}
.hint{
  background:rgba(37,99,235,.07);
  border:1px solid rgba(37,99,235,.18);
  padding:10px 12px;
  border-radius:12px;
  color:#0f172a;
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.hint b{white-space:nowrap}
.hint .steps{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.10);
  font-size:12.5px;
}
.table{border-radius:14px; overflow:hidden}
table{border-collapse:separate; border-spacing:0}
thead th{
  position:sticky; top:0;
  background:rgba(248,250,252,.98);
  backdrop-filter:saturate(120%) blur(6px);
  z-index:2;
}
tbody tr:nth-child(odd){background:rgba(2,6,23,.02)}
tbody tr:hover{background:rgba(37,99,235,.06)}
/* CTA area */
.actions-bar{
  display:flex; gap:8px; flex-wrap:wrap;
  align-items:center;
  margin-top:10px;
}

</style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo">VOLPEX CRM <span class="pill">PRO</span></div>
    <div class="sub">CRUD ‚Ä¢ Import CSV smart ‚Ä¢ Export CSV/PDF ‚Ä¢ Report ‚Ä¢ Grafici ‚Ä¢ Timeline</div>

    <div class="nav">
      <button class="active" data-view="dashboard">üìä Dashboard</button>
      <button data-view="console30">üñ• Console 30 giorni</button>
      <button data-view="anagrafica">üë§ Anagrafica (CRUD)</button>
      <button data-view="contratti">üìÑ Contratti (CRUD completo)</button>
      <button data-view="device">üì± Device (CRUD)</button>
      <button data-view="riparazioni">üõ† Riparazioni (CRUD)</button>
      <button data-view="report">üìà Report avanzati</button>
      <button data-view="timeline">üïí Timeline cliente</button>
      <button data-view="importexport">‚¨ÜÔ∏è‚¨áÔ∏è Import / Export</button>
    </div>

    <div class="sideCard">
      <div class="muted">Stato ambiente</div>
      <div class="kv"><span>Modalit√†</span><b id="envMode">DEMO (localStorage)</b></div>
      <div class="kv"><span>Ultimo refresh</span><b id="lastSync" class="mono">‚Äî</b></div>
      <div class="kv"><span>Record totali</span><b id="totalRecords">‚Äî</b></div>
      <div class="kv"><span>PK/FK</span><span class="muted">CF = chiave</span></div>
    </div>

    <div class="sideCard">
      <div class="muted">Azioni rapide</div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary small" id="btnResetDemo">Reset demo</button>
        <button class="btn primary small" id="btnSaveNow">Salva</button>
      </div>
      <div class="smallNote" style="margin-top:8px">
        Salvataggio automatico su localStorage. Reset = ripristina i dati fittizi.
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="content">
    <header class="topbar"><div class="content topbarInner">
      <b id="pageTitle">Dashboard</b>
      <div class="right">
        <button class="btn secondary small" id="btnRefresh">‚Üª Refresh</button>
        <button class="btn secondary small" id="btnPrint">Stampa / PDF</button>
      </div>
    </div></header>

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view active">
      <div class="grid grid-4">
        <div class="card">
          <div class="kpi-label">Contratti ultimi 30gg</div>
          <div class="kpi-value" id="kpiContratti30">‚Äî</div>
          <div class="kpi-sub" id="kpiContrattiSub">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-label">Device venduti ultimi 30gg</div>
          <div class="kpi-value" id="kpiDevice30">‚Äî</div>
          <div class="kpi-sub" id="kpiDeviceSub">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-label">Riparazioni ultimi 30gg</div>
          <div class="kpi-value" id="kpiRip30">‚Äî</div>
          <div class="kpi-sub" id="kpiRipSub">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-label">Clienti (Anagrafica)</div>
          <div class="kpi-value" id="kpiClienti">‚Äî</div>
          <div class="kpi-sub" id="kpiClientiSub">‚Äî</div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:14px">
        <div class="card">
          <h3>Grafico a torta: attivit√† 30gg per tipo</h3>
          <div class="muted">Torta = distribuzione tra contratti, device e riparazioni negli ultimi 30 giorni.</div>
          <canvas id="chartDaily"></canvas>
        </div>

        <div class="card">
          <h3>Grafico a torta: Top venditori (30gg)</h3>
          <div class="muted">Torta = quota di contratti + device per venditore negli ultimi 30 giorni.</div>
          <canvas id="chartSellers"></canvas>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:14px">
        <div class="card">
          <h3>Grafico a torta: contratti per compagnia (30gg)</h3>
          <div class="muted">Torta = quota contratti per compagnia negli ultimi 30 giorni.</div>
          <canvas id="chartCompanies"></canvas>
        </div>

        <div class="card">
          <h3>Riepilogo economico (30gg)</h3>
          <div class="muted">Somme su device venduti + riparazioni (se presenti prezzo/costo).</div>
          <div class="grid grid-2" style="margin-top:10px">
            <div class="card" style="border-style:dashed">
              <div class="kpi-label">Totale ‚Ç¨ Device</div>
              <div class="kpi-value" id="kpiDeviceEur">‚Äî</div>
            </div>
            <div class="card" style="border-style:dashed">
              <div class="kpi-label">Totale ‚Ç¨ Riparazioni</div>
              <div class="kpi-value" id="kpiRipEur">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONSOLE 30 -->
    <section id="view-console30" class="view">
      <div class="card">
        <h3>Console ultimi 30 giorni</h3>
        <div class="muted">Vista completa: contratti, device, riparazioni negli ultimi 30gg.</div>
      </div>

      <div class="grid grid-3" style="margin-top:14px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3>üìÑ Contratti (30gg)</h3>
            <span class="badge" id="badgeContratti30">‚Äî</span>
          </div>
          <div class="tableWrap">
            <table id="tblContratti30">
              <thead><tr><th>Data</th><th>ID</th><th>CF</th><th>Cliente</th><th>Compagnia</th><th>Offerta</th><th>Tecnologia</th><th>MNP</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3>üì± Device (30gg)</h3>
            <span class="badge good" id="badgeDevice30">‚Äî</span>
          </div>
          <div class="tableWrap">
            <table id="tblDevice30">
              <thead><tr><th>Data</th><th>ID</th><th>CF</th><th>Cliente</th><th>Modello</th><th>IMEI</th><th>Prezzo</th><th>Venditore</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3>üõ† Riparazioni (30gg)</h3>
            <span class="badge warn" id="badgeRip30">‚Äî</span>
          </div>
          <div class="tableWrap">
            <table id="tblRip30">
              <thead><tr><th>Ingresso</th><th>ID</th><th>CF</th><th>Cliente</th><th>Modello</th><th>Problema</th><th>Stato</th><th>Costo</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ANAGRAFICA CRUD -->
    <section id="view-anagrafica" class="view">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Anagrafica clienti (PK = CF)</h3>
            <span class="muted">Inserisci/Modifica/Elimina</span>
          </div>
          <div class="right">
            <input id="searchAnag" placeholder="Cerca (CF / nome / telefono / email / citt√†)" style="min-width:280px"/>
            <button class="btn secondary small" id="btnExportAnagCsv">Export CSV</button>
          </div>
        </div>
        <div class="hr"></div>

        <div class="grid grid-4">
          <input id="a_cf" placeholder="Codice Fiscale *"/>
          <input id="a_nome" placeholder="Nome *"/>
          <input id="a_cognome" placeholder="Cognome *"/>
          <input id="a_citta" placeholder="Citt√†"/>
          <input id="a_telefono" placeholder="Telefono"/>
          <input id="a_email" placeholder="Email"/>
          <input id="a_indirizzo" placeholder="Indirizzo"/>
          <input id="a_data_nascita" type="date" placeholder="Data nascita"/>
          <select id="a_tipo">
            <option value="">Tipo cliente</option>
            <option>PRIVATO</option>
            <option>BUSINESS</option>
          </select>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnSaveAnag">Salva (Upsert)</button>
          <button class="btn secondary" id="btnClearAnag">Pulisci</button>
          <span class="muted">* obbligatori ‚Ä¢ CF viene normalizzato in MAIUSCOLO</span>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <h3>Clienti</h3>
        <table id="tblAnag">
          <thead>
            <tr>
              <th>CF</th><th>Nome</th><th>Cognome</th><th>Tipo</th><th>Telefono</th><th>Email</th><th>Citt√†</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    
      <div class="card" id="clientSheetCard">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Scheda Cliente (azioni rapide)</h3>
            <span class="muted">Cerca CF e inserisci operazioni senza uscire dalla scheda</span>
          </div>
          <div class="right">
            <input id="cs_search_cf" placeholder="Inserisci CF e premi Cerca" style="min-width:260px"/>
            <button class="btn primary small" id="btnClientLoad">Cerca</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="cs_summary" class="muted">Nessun cliente selezionato.</div>
        <div class="row" style="margin-top:10px">
          <a id="cs_whatsapp" class="btn secondary small" target="_blank" rel="noopener" style="text-decoration:none;display:none">üí¨ WhatsApp</a>
          <button class="btn secondary small" id="btnClientGoTimeline" style="display:none">üïí Apri Timeline</button>
        </div>

        <div class="hr"></div>

        <div class="grid grid-3">
          <div class="card" style="border-style:dashed">
            <h3>+ Nuovo Contratto</h3>
            <div class="grid grid-2">
              <input id="cs_c_id" placeholder="ID contratto (auto)"/>
              <input id="cs_c_data" type="date"/>
              <input id="cs_c_compagnia" placeholder="Compagnia"/>
              <input id="cs_c_offerta" placeholder="Nome offerta"/>
              <input id="cs_c_numero" placeholder="Numero lavorato"/>
              <select id="cs_c_mnp">
                <option value="">MNP</option>
                <option>SI</option>
                <option>NO</option>
              </select>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnCS_SaveCon">Salva</button>
              <button class="btn secondary small" id="btnCS_OpenCon">Apri modulo completo</button>
            </div>
          </div>

          <div class="card" style="border-style:dashed">
            <h3>+ Nuovo Device</h3>
            <div class="grid grid-2">
              <input id="cs_d_id" placeholder="ID device (auto)"/>
              <input id="cs_d_data" type="date"/>
              <input id="cs_d_modello" placeholder="Modello *"/>
              <input id="cs_d_imei" placeholder="IMEI"/>
              <input id="cs_d_prezzo" type="number" step="0.01" placeholder="Prezzo (‚Ç¨)"/>
              <input id="cs_d_venditore" placeholder="Venditore"/>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnCS_SaveDev">Salva</button>
              <button class="btn secondary small" id="btnCS_OpenDev">Apri modulo completo</button>
            </div>
          </div>

          <div class="card" style="border-style:dashed">
            <h3>+ Nuova Riparazione</h3>
            <div class="grid grid-2">
              <input id="cs_r_id" placeholder="ID riparazione (auto)"/>
              <input id="cs_r_data" type="date"/>
              <input id="cs_r_modello" placeholder="Modello *"/>
              <input id="cs_r_imei" placeholder="IMEI"/>
              <input id="cs_r_problema" placeholder="Problema"/>
              <select id="cs_r_stato">
                <option value="">Stato</option>
                <option>APERTA</option>
                <option>IN LAVORAZIONE</option>
                <option>PRONTA</option>
                <option>CONSEGNATA</option>
              </select>
              <input id="cs_r_costo" type="number" step="0.01" placeholder="Costo (‚Ç¨)"/>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnCS_SaveRip">Salva</button>
              <button class="btn secondary small" id="btnCS_OpenRip">Apri modulo completo</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid grid-3">
          <div class="card">
            <h3>Ultimi contratti cliente</h3>
            <div class="tableWrap">
              <table id="cs_tbl_con">
                <thead><tr><th>Data</th><th>Compagnia</th><th>Offerta</th><th>MNP</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h3>Ultimi device cliente</h3>
            <div class="tableWrap">
              <table id="cs_tbl_dev">
                <thead><tr><th>Data</th><th>Modello</th><th>IMEI</th><th>Prezzo</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h3>Ultime riparazioni cliente</h3>
            <div class="tableWrap">
              <table id="cs_tbl_rip">
                <thead><tr><th>Ingresso</th><th>Modello</th><th>Stato</th><th>Costo</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

</section>

    <!-- CONTRATTI CRUD COMPLETO -->
    <section id="view-contratti" class="view">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Contratti (FK = CF) ‚Äì CRUD completo</h3>
            <span class="muted">Tutti i campi del tuo Google Sheet</span>
          </div>
          <div class="right">
            <input id="searchCon" placeholder="Cerca (CF / compagnia / offerta / IMEI / ICCID / numero / MNP)" style="min-width:340px"/>
            <button class="btn secondary small" id="btnExportConCsv">Export CSV</button>
          </div>
        </div>

        <div class="hr"></div>

<div class="hint" style="margin-top:10px">
  <b>Come si usa:</b>
  <div class="steps">
    <span class="chip">1) Inserisci CF</span>
    <span class="chip">2) Premi ‚ÄúCerca cliente‚Äù</span>
    <span class="chip">3) Se non esiste ‚Üí compila Anagrafica veloce</span>
    <span class="chip">4) Compila i dati operazione</span>
    <span class="chip">5) Salva ‚Üí Stampa / WhatsApp</span>
  </div>
</div>


        <div class="hint">
          Suggerimento: i campi <b>SI/NO</b> e le dropdown sono gi√† ‚Äúguidate‚Äù. Tutto viene salvato in MAIUSCOLO (dove sensato).
        </div>

        <div class="hr"></div>
        <div class="grid grid-4">
          <input id="c_id" placeholder="ID contratto (auto se vuoto)"/>
          <input id="c_id_cliente" placeholder="ID cliente (es. C001)"/>
          <div>
            <div class="muted">Codice fiscale *</div>
            <div class="row" style="flex-wrap:nowrap">
              <input id="c_cf" placeholder="Codice fiscale *"/>
              <button class="btn secondary small" id="btnConFindClient" type="button">Cerca cliente</button>
            </div>
            <div id="c_cf_status" class="smallNote" style="margin-top:6px">Inserisci CF e premi ‚ÄúCerca cliente‚Äù.</div>
          </div>
          <input id="c_data_contratto" type="date"/>

          <select id="c_tipo_cliente">
            <option value="">Tipo cliente</option>
            <option>PRIVATO</option>
            <option>BUSINESS</option>
          </select>

          <select id="c_tipo_attivazione">
            <option value="">Tipo attivazione</option>
            <option>NUOVA</option>
            <option>MNP</option>
            <option>SUBENTRO</option>
            <option>MIGRAZIONE</option>
            <option>UPGRADE</option>
          </select>

          <select id="c_tecnologia">
            <option value="">Tecnologia</option>
            <option>SIM</option>
            <option>FTTH</option>
            <option>FWA</option>
            <option>ADSL</option>
          </select>

          <select id="c_convergenza">
            <option value="">Convergenza</option>
            <option>SI</option>
            <option>NO</option>
          </select>

          <select id="c_mnp">
            <option value="">MNP</option>
            <option>SI</option>
            <option>NO</option>
          </select>

          <input id="c_data_attivazione" type="date"/>
          <input id="c_data_portabilita" type="date"/>
          <input id="c_numero_lavorato" placeholder="Numero lavorato"/>

          <input id="c_nome_offerta" placeholder="Nome offerta"/>
          <input id="c_costo_offerta" type="number" step="0.01" placeholder="Costo offerta (‚Ç¨/mese)"/>
          <input id="c_vincolo_offerta_mesi" type="number" step="1" placeholder="Vincolo offerta (mesi)"/>

          <select id="c_telefono_incluso">
            <option value="">Telefono incluso</option>
            <option>SI</option>
            <option>NO</option>
          </select>

          <input id="c_imei" placeholder="IMEI"/>
          <input id="c_modello" placeholder="Modello"/>
          <select id="c_tipo_pagamento">
            <option value="">Tipo pagamento</option>
            <option>CARTA</option>
            <option>BANCOMAT</option>
            <option>CONTANTI</option>
            <option>FATTURA</option>
            <option>FINANZIAMENTO</option>
          </select>

          <input id="c_mesi_vincolo_telefono" type="number" step="1" placeholder="Mesi vincolo telefono"/>
          <input id="c_data_fine_vincolo_offerta" type="date"/>
          <input id="c_data_fine_vincolo_telefono" type="date"/>

          <input id="c_compagnia" placeholder="Compagnia (es. VODAFONE)"/>
          <input id="c_iccid_vecchio" placeholder="ICCID_vecchio"/>
          <input id="c_iccid_nuovo" placeholder="ICCID_nuovo"/>

          <input id="c_created_at" placeholder="created_at (opzionale)"/>
          <input id="c_updated_at" placeholder="updated_at (opzionale)"/>
        </div>
        <div id="conQuickAnag" class="card" style="border-style:dashed; display:none; margin-top:12px">
          <h3>Cliente non trovato: inserisci Anagrafica (veloce)</h3>
          <div class="muted">Verr√† creato il cliente e poi potrai salvare subito il contratto.</div>
          <div class="grid grid-4" style="margin-top:10px">
            <input id="qa_cf" placeholder="Codice fiscale *" disabled/>
            <input id="qa_nome" placeholder="Nome *"/>
            <input id="qa_cognome" placeholder="Cognome *"/>
            <select id="qa_tipo">
              <option value="">Tipo cliente</option>
              <option>PRIVATO</option>
              <option>BUSINESS</option>
            </select>
            <input id="qa_telefono" placeholder="Telefono"/>
            <input id="qa_email" placeholder="Email"/>
            <input id="qa_citta" placeholder="Citt√†"/>
            <input id="qa_indirizzo" placeholder="Indirizzo"/>
            <input id="qa_data_nascita" type="date" placeholder="Data nascita"/>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary small" id="btnQASave">Crea cliente</button>
            <button class="btn secondary small" id="btnQACancel">Annulla</button>
          </div>
        </div>


        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnSaveCon">Salva</button>
          <button class="btn secondary" id="btnClearCon">Pulisci</button>
          <span class="muted">FK: il CF deve esistere in Anagrafica</span>
        </div>

        <div id="devQuickAnag" class="card" style="border-style:dashed; display:none; margin-top:12px">
          <h3>Cliente non trovato: inserisci Anagrafica (veloce)</h3>
          <div class="muted">Verr√† creato il cliente e poi potrai salvare subito la vendita device.</div>
          <div class="grid grid-4" style="margin-top:10px">
            <input id="qd_cf" placeholder="Codice fiscale *" disabled/>
            <input id="qd_nome" placeholder="Nome *"/>
            <input id="qd_cognome" placeholder="Cognome *"/>
            <select id="qd_tipo">
              <option value="">Tipo cliente</option>
              <option>PRIVATO</option>
              <option>BUSINESS</option>
            </select>

            <input id="qd_telefono" placeholder="Telefono"/>
            <input id="qd_email" placeholder="Email"/>
            <input id="qd_citta" placeholder="Citt√†"/>
            <input id="qd_indirizzo" placeholder="Indirizzo"/>

            <input id="qd_data_nascita" type="date" placeholder="Data nascita"/>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnQDSave" type="button">Crea cliente</button>
            <button class="btn secondary" id="btnQDCancel" type="button">Annulla</button>
          </div>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <h3>Contratti</h3>
        <table id="tblCon">
          <thead>
            <tr>
              <th>ID</th><th>ID cliente</th><th>Data</th><th>CF</th><th>Cliente</th><th>Compagnia</th><th>Offerta</th><th>Tecnologia</th><th>MNP</th><th>Numero</th><th>IMEI</th><th>ICCID nuovo</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DEVICE CRUD -->
    <section id="view-device" class="view">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Vendita Device (FK = CF)</h3>
            <span class="muted">Prezzo incluso nei grafici/metriche</span>
          </div>
          <div class="right">
            <input id="searchDev" placeholder="Cerca (CF / modello / IMEI / venditore)" style="min-width:320px"/>
            <button class="btn secondary small" id="btnExportDevCsv">Export CSV</button>
          </div>
        </div>
        <div class="hr"></div>

<div class="hint" style="margin-top:10px">
  <b>Come si usa:</b>
  <div class="steps">
    <span class="chip">1) Inserisci CF</span>
    <span class="chip">2) Premi ‚ÄúCerca cliente‚Äù</span>
    <span class="chip">3) Se non esiste ‚Üí compila Anagrafica veloce</span>
    <span class="chip">4) Compila i dati operazione</span>
    <span class="chip">5) Salva ‚Üí Stampa / WhatsApp</span>
  </div>
</div>



        <div class="grid grid-4">
          <input id="d_id" placeholder="ID device (auto se vuoto)"/>
          <div>
            <div class="muted">Codice fiscale *</div>
            <div class="row" style="flex-wrap:nowrap">
              <input id="d_cf" placeholder="Codice fiscale *"/>
              <button class="btn secondary small" id="btnDevFindClient" type="button">Cerca cliente</button>
            </div>
            <div id="d_cf_status" class="smallNote" style="margin-top:6px">Inserisci CF e premi ‚ÄúCerca cliente‚Äù.</div>
          </div>
          <input id="d_data" type="date"/>
          <input id="d_modello" placeholder="Modello *"/>
          <input id="d_imei" placeholder="IMEI"/>
          <input id="d_prezzo" type="number" step="0.01" placeholder="Prezzo (‚Ç¨)"/>
          <input id="d_venditore" placeholder="Venditore"/>
          <select id="d_pagamento">
            <option value="">Tipo pagamento</option>
            <option>CARTA</option>
            <option>BANCOMAT</option>
            <option>CONTANTI</option>
            <option>FATTURA</option>
          </select>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnSaveDev">Salva</button>
          <button class="btn secondary" id="btnClearDev">Pulisci</button>
          <span class="muted">FK: il CF deve esistere in Anagrafica</span>
        </div>

        <div id="ripQuickAnag" class="card" style="border-style:dashed; display:none; margin-top:12px">
          <h3>Cliente non trovato: inserisci Anagrafica (veloce)</h3>
          <div class="muted">Verr√† creato il cliente e poi potrai salvare subito la riparazione.</div>
          <div class="grid grid-4" style="margin-top:10px">
            <input id="qr_cf" placeholder="Codice fiscale *" disabled/>
            <input id="qr_nome" placeholder="Nome *"/>
            <input id="qr_cognome" placeholder="Cognome *"/>
            <select id="qr_tipo">
              <option value="">Tipo cliente</option>
              <option>PRIVATO</option>
              <option>BUSINESS</option>
            </select>

            <input id="qr_telefono" placeholder="Telefono"/>
            <input id="qr_email" placeholder="Email"/>
            <input id="qr_citta" placeholder="Citt√†"/>
            <input id="qr_indirizzo" placeholder="Indirizzo"/>

            <input id="qr_data_nascita" type="date" placeholder="Data nascita"/>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnQRSave" type="button">Crea cliente</button>
            <button class="btn secondary" id="btnQRCancel" type="button">Annulla</button>
          </div>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <h3>Device venduti</h3>
        <table id="tblDev">
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>CF</th><th>Cliente</th><th>Modello</th><th>IMEI</th><th>Prezzo</th><th>Venditore</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RIPARAZIONI CRUD -->
    <section id="view-riparazioni" class="view">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Riparazioni (FK = CF)</h3>
            <span class="muted">Stati + costi per report</span>
          </div>
          <div class="right">
            <input id="searchRip" placeholder="Cerca (CF / modello / problema / stato / IMEI)" style="min-width:340px"/>
            <button class="btn secondary small" id="btnExportRipCsv">Export CSV</button>
          </div>
        </div>
        <div class="hr"></div>

<div class="hint" style="margin-top:10px">
  <b>Come si usa:</b>
  <div class="steps">
    <span class="chip">1) Inserisci CF</span>
    <span class="chip">2) Premi ‚ÄúCerca cliente‚Äù</span>
    <span class="chip">3) Se non esiste ‚Üí compila Anagrafica veloce</span>
    <span class="chip">4) Compila i dati operazione</span>
    <span class="chip">5) Salva ‚Üí Stampa / WhatsApp</span>
  </div>
</div>



        <div class="grid grid-4">
          <input id="r_id" placeholder="ID riparazione (auto se vuoto)"/>
          <div>
            <div class="muted">Codice fiscale *</div>
            <div class="row" style="flex-wrap:nowrap">
              <input id="r_cf" placeholder="Codice fiscale *"/>
              <button class="btn secondary small" id="btnRipFindClient" type="button">Cerca cliente</button>
            </div>
            <div id="r_cf_status" class="smallNote" style="margin-top:6px">Inserisci CF e premi ‚ÄúCerca cliente‚Äù.</div>
          </div>
          <input id="r_ingresso" type="date"/>
          <input id="r_modello" placeholder="Modello *"/>
          <input id="r_imei" placeholder="IMEI"/>
          <input id="r_problema" placeholder="Problema"/>
          <select id="r_stato">
            <option value="">Stato</option>
            <option>APERTA</option>
            <option>IN LAVORAZIONE</option>
            <option>PRONTA</option>
            <option>CONSEGNATA</option>
          </select>
          <input id="r_costo" type="number" step="0.01" placeholder="Costo (‚Ç¨)"/>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnSaveRip">Salva</button>
          <button class="btn secondary" id="btnClearRip">Pulisci</button>
          <span class="muted">FK: il CF deve esistere in Anagrafica</span>
        </div>
      </div>

      <div class="card" style="overflow:auto">
        <h3>Riparazioni</h3>
        <table id="tblRip">
          <thead>
            <tr>
              <th>ID</th><th>Ingresso</th><th>CF</th><th>Cliente</th><th>Modello</th><th>Problema</th><th>Stato</th><th>Costo</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- REPORT -->
    <section id="view-report" class="view">
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Report avanzati (super filtri)</h3>
            <span class="muted">Unifica Anagrafica + Contratti + Device + Riparazioni</span>
          </div>
          <div class="right">
            <button class="btn secondary small" id="btnResetReport">Reset</button>
            <button class="btn primary small" id="btnRunReport">Applica filtri</button>
            <button class="btn secondary small" id="btnExportReportCsv">Export CSV</button>
            <button class="btn secondary small" id="btnExportReportPdf">Export PDF</button>
          </div>
        </div>

        <div class="grid grid-4" style="margin-top:10px">
          <select id="f_tipo">
            <option value="">Tipo: Tutti</option>
            <option value="CONTRATTO">Contratti</option>
            <option value="DEVICE">Device</option>
            <option value="RIPARAZIONE">Riparazioni</option>
          </select>
          <input id="f_cf" placeholder="Codice Fiscale"/>
          <input id="f_nome" placeholder="Nome/Cognome"/>
          <input id="f_contatto" placeholder="Telefono/Email"/>
        </div>

        <div class="grid grid-4" style="margin-top:10px">
          <input id="f_citta" placeholder="Citt√†"/>
          <input id="f_compagnia" placeholder="Compagnia (contratti)"/>
          <input id="f_offerta" placeholder="Offerta (contratti)"/>
          <input id="f_tecnologia" placeholder="Tecnologia (SIM/FTTH/FWA)"/>
        </div>

        <div class="grid grid-4" style="margin-top:10px">
          <input id="f_tipo_attivazione" placeholder="Tipo attivazione (NUOVA/MNP/...)"/>
          <input id="f_convergenza" placeholder="Convergenza (SI/NO)"/>
          <input id="f_mnp" placeholder="MNP (SI/NO)"/>
          <input id="f_imei_iccid" placeholder="IMEI/ICCID"/>
        </div>

        <div class="grid grid-4" style="margin-top:10px">
          <input id="f_stato_rip" placeholder="Stato riparazione"/>
          <input id="f_venditore" placeholder="Venditore (device)"/>
          <input id="f_query" placeholder="Testo libero (modello, note, problema...)"/>
          <div></div>
        </div>

        <div class="grid grid-4" style="margin-top:10px">
          <div>
            <div class="muted">Data da</div>
            <input id="f_from" type="date"/>
          </div>
          <div>
            <div class="muted">Data a</div>
            <input id="f_to" type="date"/>
          </div>
          <div>
            <div class="muted">Prezzo min (device)</div>
            <input id="f_price_min" type="number" step="0.01" placeholder="0"/>
          </div>
          <div>
            <div class="muted">Prezzo max (device)</div>
            <input id="f_price_max" type="number" step="0.01" placeholder="9999"/>
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h3>Totali report</h3>
          <div class="row" style="gap:18px;flex-wrap:wrap;margin-top:10px">
            <div><div class="kpi-label">Righe</div><div class="kpi-value" id="rep_total">0</div></div>
            <div><div class="kpi-label">‚Ç¨ Device (somma)</div><div class="kpi-value" id="rep_sum_dev">0</div></div>
            <div><div class="kpi-label">‚Ç¨ Riparazioni (somma)</div><div class="kpi-value" id="rep_sum_rip">0</div></div>
          </div>
          <div class="smallNote" style="margin-top:8px">Export PDF crea una pagina stampabile con grafici+tabelle.</div>
        </div>

        <div class="card">
          <h3>Grafico report (per tipo)</h3>
          <div class="muted">Barre = conteggio risultati nel report</div>
          <canvas id="chartReportTypes"></canvas>
          <div class="muted mono" style="margin-top:10px" id="dbg">‚Äî</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;overflow:auto">
        <h3>Risultati</h3>
        <table id="tblReport">
          <thead>
            <tr>
              <th>Tipo</th><th>Data</th><th>CF</th><th>Cliente</th><th>Contatto</th><th>Citt√†</th><th>Descrizione</th><th>Extra</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    
      <div class="card" id="cardBirthdays">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Report Compleanni</h3>
            <span class="muted">Da Data Nascita (se presente) oppure decodificata da Codice Fiscale</span>
          </div>
          <div class="right">
            <select id="b_month">
              <option value="">Tutti i mesi</option>
              <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option>
              <option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option>
              <option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
            </select>
            <input id="b_days" type="number" min="1" value="30" style="max-width:120px" placeholder="Prossimi gg"/>
            <button class="btn primary small" id="btnRunBirthdays">Aggiorna</button>
            <button class="btn secondary small" id="btnExportBirthdaysCsv">Export CSV</button>
          </div>
        </div>

        <div class="hr"></div>
        <div id="b_summary" class="muted">‚Äî</div>

        <div style="margin-top:12px;overflow:auto">
          <table id="tblBirthdays">
            <thead>
              <tr>
                <th>Prossimo</th><th>Giorni</th><th>CF</th><th>Cliente</th><th>Nascita</th><th>Telefono</th><th>WhatsApp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      
      <div class="card" id="cardDeadlines">
        <div class="toolbar">
          <div class="left">
            <h3 style="margin:0">Report Scadenze / Rinnovi</h3>
            <span class="muted">Vincolo offerta / vincolo telefono (prossimi giorni) + WhatsApp automatico</span>
          </div>
          <div class="right">
            <input id="s_days" type="number" min="1" value="60" style="max-width:120px" placeholder="Prossimi gg"/>
            <select id="s_tipo">
              <option value="">Tutte</option>
              <option value="OFFERTA">Vincolo Offerta</option>
              <option value="TELEFONO">Vincolo Telefono</option>
            </select>
            <button class="btn primary small" id="btnRunScadenze">Aggiorna</button>
            <button class="btn secondary small" id="btnExportScadenzeCsv">Export CSV</button>
          </div>
        </div>

        <div class="hr"></div>
        <div id="s_summary" class="muted">‚Äî</div>

        <div style="margin-top:12px;overflow:auto">
          <table id="tblScadenze">
            <thead>
              <tr>
                <th>Scadenza</th><th>Tipo</th><th>Giorni</th><th>CF</th><th>Cliente</th><th>Numero</th><th>Compagnia</th><th>Offerta</th><th>WhatsApp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="smallNote" style="margin-top:10px">
          Suggerimento: usa questo report ogni mattina per richiamare i clienti in scadenza e chiudere rinnovi/upgrade.
        </div>
      </div>

</div>


      <div class="grid grid-2" style="margin-top:14px">
        <div class="card">
          <div class="toolbar">
            <div class="left">
              <h3 style="margin:0">Report intelligente: suggerimenti ricontatto</h3>
              <span class="muted">Winback ‚Ä¢ VIP ‚Ä¢ Upsell ‚Ä¢ Rinnovi ‚Äî con WhatsApp pronto</span>
            </div>
            <div class="right">
              <select id="smartSeg" style="min-width:180px">
                <option value="">Tutti i segmenti</option>
                <option value="RINNOVO">Rinnovo imminente</option>
                <option value="WINBACK">Inattivo (winback)</option>
                <option value="VIP">Cliente affezionato</option>
                <option value="UPSELL">Upsell / follow-up</option>
              </select>
              <input id="smartInactiveDays" type="number" min="0" value="90" placeholder="Inattivo >= gg" style="max-width:160px"/>
              <input id="smartNextDays" type="number" min="1" value="30" placeholder="Rinnovi entro gg" style="max-width:170px"/>
              <button class="btn primary small" id="btnRunSmart">Genera</button>
              <button class="btn secondary small" id="btnExportSmartCsv">Export CSV</button>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">
            Il sistema valuta <b>ultima attivit√†</b>, <b>frequenza</b>, <b>spesa stimata</b> (device/rip), <b>MNP</b> e <b>scadenze</b>.
            Usa ‚ÄúInattivo >= gg‚Äù per il winback e ‚ÄúRinnovi entro gg‚Äù per proporre rinnovi.
          </div>
        </div>

        <div class="card">
          <h3>Riepilogo suggerimenti</h3>
          <div class="row" style="gap:16px;flex-wrap:wrap;margin-top:10px">
            <div><div class="kpi-label">Totali</div><div class="kpi-value" id="smartTot">0</div></div>
            <div><div class="kpi-label">Rinnovi</div><div class="kpi-value" id="smartRen">0</div></div>
            <div><div class="kpi-label">Winback</div><div class="kpi-value" id="smartWin">0</div></div>
            <div><div class="kpi-label">VIP</div><div class="kpi-value" id="smartVip">0</div></div>
            <div><div class="kpi-label">Upsell</div><div class="kpi-value" id="smartUp">0</div></div>
          </div>
          <div class="smallNote" style="margin-top:10px">
            Suggerimento: usa i VIP per ‚Äúbuono fedelt√†‚Äù, winback per ‚Äútorna da noi‚Äù, rinnovi per ‚Äúupgrade/nuova promo‚Äù.
          </div>
        </div>
      </div>

      
      <div class="grid grid-2" style="margin-top:14px">
        <div class="card">
          <h3>Valore cliente (stima) & impostazioni</h3>
          <div class="muted">Usato per prioritizzare VIP e per ‚Äúricontatti suggeriti‚Äù.</div>
          <div class="grid grid-3" style="margin-top:10px">
            <div>
              <div class="muted">Valore contratti (mesi)</div>
              <input id="valMonths" type="number" step="1" min="1" value="12"/>
            </div>
            <div>
              <div class="muted">Margine device (%)</div>
              <input id="marginDevPct" type="number" step="1" min="0" max="100" value="15"/>
            </div>
            <div>
              <div class="muted">Margine riparazioni (%)</div>
              <input id="marginRipPct" type="number" step="1" min="0" max="100" value="40"/>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary small" id="btnSaveValueSettings">Salva impostazioni</button>
            <span class="muted">Tip: mesi=12/24, device=10‚Äì20%, rip=30‚Äì60%</span>
          </div>
        </div>

        <div class="card">
          <h3>Campagne salvate</h3>
          <div class="muted">Crea campagne dai ricontatti suggeriti e traccia gli esiti.</div>
          <div class="grid grid-3" style="margin-top:10px">
            <input id="campName" placeholder="Nome campagna (es. Winback Gennaio)"/>
            <select id="campSeg">
              <option value="">Segmento: Tutti</option>
              <option>RINNOVO</option>
              <option>WINBACK</option>
              <option>VIP</option>
              <option>UPSELL</option>
            </select>
            <button class="btn primary" id="btnCreateCampaign">Crea da lista</button>
          </div>
          <div class="row" style="margin-top:10px">
            <select id="campSelect" style="min-width:280px"></select>
            <button class="btn secondary small" id="btnExportCampaignCsv">Export CSV campagna</button>
            <button class="btn secondary small" id="btnDeleteCampaign">Elimina campagna</button>
          </div>
          <div class="smallNote" style="margin-top:10px">Dentro la campagna puoi segnare stato, esito e follow-up; WhatsApp precompilato √® gi√† pronto.</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;overflow:auto">
        <h3>Leads campagna selezionata</h3>
        <table id="tblCampaignLeads">
          <thead>
            <tr>
              <th>Score</th>
              <th>Segmento</th>
              <th>CF</th>
              <th>Cliente</th>
              <th>Valore stimato</th>
              <th>Stato</th>
              <th>Esito</th>
              <th>Follow-up</th>
              <th>Ultimo contatto</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

<div class="card" style="margin-top:14px;overflow:auto">
        <h3>Lista ricontatti suggeriti</h3>
        <table id="tblSmart">
          <thead>
            <tr>
              <th>Score</th>
              <th>Segmento</th>
              <th>CF</th>
              <th>Cliente</th>
              <th>Ultima attivit√†</th>
              <th>Giorni</th>
              <th>Motivo</th>
              <th>Proposta</th>
              <th>Valore stimato</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>

    <!-- TIMELINE -->
    <section id="view-timeline" class="view">
      <div class="card">
        <h3>Timeline cliente (stile Salesforce)</h3>
        <div class="muted">Inserisci CF e vedi eventi (Contratti/Device/Riparazioni) in ordine decrescente.</div>
        <div class="row" style="margin-top:10px">
          <div style="flex:2;min-width:260px">
            <input id="t_cf" placeholder="Codice Fiscale"/>
          </div>
          <button class="btn primary" id="btnTimeline">Carica timeline</button>
        </div>
      </div>

      <div class="card">
        <div id="timelineHeader" class="muted">‚Äî</div>
        <div id="timelineBox" class="timeline" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- IMPORT / EXPORT -->
    <section id="view-importexport" class="view">
      <div class="card">
        <h3>Import CSV (smart headers)</h3>
        <div class="muted">
          Importa direttamente dal tuo export Google Sheets (intestazioni come: <span class="mono">ID contratto</span>, <span class="mono">Codice fiscale</span>, <span class="mono">Data contratto</span>, <span class="mono">ICCID_nuovo</span>, ecc).
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div class="card" style="border-style:dashed">
            <div class="row" style="justify-content:space-between">
              <b>Import Anagrafica</b>
              <input type="file" id="fileAnag" accept=".csv" />
            </div>
            <div class="smallNote">Minimo: CF, Nome, Cognome</div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnImportAnag">Importa</button>
              <button class="btn secondary small" id="btnTplAnag">Scarica template</button>
            </div>
          </div>

          <div class="card" style="border-style:dashed">
            <div class="row" style="justify-content:space-between">
              <b>Import Contratti</b>
              <input type="file" id="fileCon" accept=".csv" />
            </div>
            <div class="smallNote">Minimo: Codice fiscale (FK). Data contratto consigliata.</div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnImportCon">Importa</button>
              <button class="btn secondary small" id="btnTplCon">Scarica template</button>
            </div>
          </div>

          <div class="card" style="border-style:dashed">
            <div class="row" style="justify-content:space-between">
              <b>Import Device</b>
              <input type="file" id="fileDev" accept=".csv" />
            </div>
            <div class="smallNote">Minimo: CF (FK) + Modello</div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnImportDev">Importa</button>
              <button class="btn secondary small" id="btnTplDev">Scarica template</button>
            </div>
          </div>

          <div class="card" style="border-style:dashed">
            <div class="row" style="justify-content:space-between">
              <b>Import Riparazioni</b>
              <input type="file" id="fileRip" accept=".csv" />
            </div>
            <div class="smallNote">Minimo: CF (FK) + Modello</div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary small" id="btnImportRip">Importa</button>
              <button class="btn secondary small" id="btnTplRip">Scarica template</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Export</h3>
        <div class="muted">CSV completi per tab + PDF ‚Äúpresentabile‚Äù (stampa browser).</div>
        <div class="row" style="margin-top:12px">
          <button class="btn secondary" id="btnExportAll">Export TUTTO (multipli CSV)</button>
          <button class="btn secondary" id="btnExportAnagAll">Export Anagrafica</button>
          <button class="btn secondary" id="btnExportConAll">Export Contratti</button>
          <button class="btn secondary" id="btnExportDevAll">Export Device</button>
          <button class="btn secondary" id="btnExportRipAll">Export Riparazioni</button>
          <button class="btn secondary" id="btnExportFullPdf">Export PDF (Dashboard+30gg)</button>
        </div>
        <div class="smallNote" style="margin-top:10px">
          Nota: ‚ÄúExport PDF‚Äù apre una pagina stampabile con grafici e tabelle, poi fai ‚ÄúSalva come PDF‚Äù.
        </div>
      </div>
    </section>

  </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   UTIL
========================= */
function toast(msg, ms=2400){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), ms);
}
function upper(x){ return (x ?? "").toString().trim().toUpperCase(); }

function waLink(phone){
  const digits = (phone||"").toString().replace(/[^0-9]/g,"");
  if(!digits) return "#";
  // se manca prefisso, mettiamo 39
  const d = digits.startsWith("39") ? digits : ("39"+digits);
  return "https://wa.me/" + d;
}

function waLinkText(phone, text){
  const base = waLink(phone);
  if(base === "#") return "#";
  const msg = encodeURIComponent((text||"").toString());
  return base + (msg ? ("?text=" + msg) : "");
}

function phoneByCF(cf){
  const a = anagByCF(cf);
  return a ? (a.telefono||"") : "";
}
function escapeHtml(s){
  return (s==null?"":String(s))
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/\"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function waDefaultMsg(type, rec){
  // rec is the record object in the template literal
  const base = "Ciao! ";
  if(type==="con"){
    return base + "ti confermo la registrazione del contratto ID " + (rec.id||"") + ".";
  }
  if(type==="dev"){
    return base + "ti confermo la vendita device ID " + (rec.id||"") + ".";
  }
  if(type==="rip"){
    return base + "aggiornamento riparazione ID " + (rec.id||"") + ": " + (rec.stato||"") + ".";
  }
  return base;
}

function printReceipt(type, id){
  let rec=null;
  if(type==="con") rec = contratti.find(x=>x.id===id);
  if(type==="dev") rec = devices.find(x=>x.id===id);
  if(type==="rip") rec = riparazioni.find(x=>x.id===id);
  if(!rec){ toast("Record non trovato"); return; }
  const cf = rec.cf;
  const a = anagByCF(cf) || {};
  const titolo = type==="con" ? "Ricevuta Contratto" : type==="dev" ? "Ricevuta Vendita Device" : "Ricevuta Riparazione";
  const now = new Date();
  const meta = `
    <div><b>${titolo}</b></div>
    <div class="muted">Stampata: ${now.toLocaleString()}</div>
    <div class="hr"></div>
    <div><b>ID:</b> ${escapeHtml(rec.id||"")}</div>
    <div><b>Data:</b> ${escapeHtml(toDateISO(rec.data_contratto||rec.data||rec.data_ingresso||"")||"")}</div>
  `;
  const cliente = `
    <div style="margin-top:10px"><b>Cliente</b></div>
    <div><b>CF:</b> ${escapeHtml(cf||"")}</div>
    <div><b>Nome:</b> ${escapeHtml((a.nome||"") + " " + (a.cognome||""))}</div>
    <div><b>Telefono:</b> ${escapeHtml(a.telefono||"")}</div>
    <div><b>Email:</b> ${escapeHtml(a.email||"")}</div>
    <div><b>Citt√†:</b> ${escapeHtml(a.citta||"")}</div>
  `;
  let dettagli = "";
  if(type==="con"){
    dettagli = `
      <div style="margin-top:10px"><b>Dettagli contratto</b></div>
      <div><b>Compagnia:</b> ${escapeHtml(rec.compagnia||"")}</div>
      <div><b>Offerta:</b> ${escapeHtml(rec.nome_offerta||"")}</div>
      <div><b>Tecnologia:</b> ${escapeHtml(rec.tecnologia||"")}</div>
      <div><b>MNP:</b> ${escapeHtml(rec.mnp||"")}</div>
      <div><b>Numero:</b> ${escapeHtml(rec.numero_lavorato||"")}</div>
      <div><b>IMEI:</b> ${escapeHtml(rec.imei||"")}</div>
      <div><b>ICCID nuovo:</b> ${escapeHtml(rec.iccid_nuovo||"")}</div>
    `;
  } else if(type==="dev"){
    dettagli = `
      <div style="margin-top:10px"><b>Dettagli device</b></div>
      <div><b>Modello:</b> ${escapeHtml(rec.modello||"")}</div>
      <div><b>IMEI:</b> ${escapeHtml(rec.imei||"")}</div>
      <div><b>Prezzo:</b> ${escapeHtml(toNum(rec.prezzo)!=null ? moneyFmt(toNum(rec.prezzo)) : "")}</div>
      <div><b>Venditore:</b> ${escapeHtml(rec.venditore||"")}</div>
      <div><b>Note:</b> ${escapeHtml(rec.note||"")}</div>
    `;
  } else {
    dettagli = `
      <div style="margin-top:10px"><b>Dettagli riparazione</b></div>
      <div><b>Modello:</b> ${escapeHtml(rec.modello||"")}</div>
      <div><b>IMEI:</b> ${escapeHtml(rec.imei||"")}</div>
      <div><b>Problema:</b> ${escapeHtml(rec.problema||"")}</div>
      <div><b>Stato:</b> ${escapeHtml(rec.stato||"")}</div>
      <div><b>Costo:</b> ${escapeHtml(toNum(rec.costo)!=null ? moneyFmt(toNum(rec.costo)) : "")}</div>
    `;
  }

  const html = `
<!doctype html>
<html><head><meta charset="utf-8"/>
<title>${titolo}</title>
<style>
  body{ font-family: Arial, sans-serif; margin:24px; }
  .box{ border:1px solid #ddd; padding:16px; border-radius:10px; }
  .muted{ color:#666; font-size:12px; }
  .hr{ border-top:1px solid #eee; margin:10px 0; }
  .sign{ margin-top:22px; display:flex; justify-content:space-between; gap:20px; }
  .sign > div{ flex:1; border-top:1px solid #333; padding-top:6px; font-size:12px; }
  @media print{ button{display:none} }
</style></head>
<body>
  <div class="box">
    ${meta}
    ${cliente}
    ${dettagli}
    <div class="sign">
      <div>Firma cliente</div>
      <div>Firma operatore</div>
    </div>
  </div>
  

<!-- ================= GOOGLE SHEETS SYNC (Apps Script Web App) ================= -->
<script>
  // === CONFIG ===
  const GS_URL = "https://script.google.com/macros/s/AKfycbzqjV_XrlTnfJ96ZvMdygNj53fco3u_lwk0OgQUc5YxqmScLntEr-uzoUmjl4T_rlBW/exec";
  const GS_TOKEN = "VOLPEX_SECRET_TOKEN"; // <- metti QUI lo stesso token dello script Google

  async function gsCall(action, payload = {}) {
    const res = await fetch(GS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: GS_TOKEN, action, ...payload })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Google Sync error");
    return data;
  }

  // === UI Buttons (fixed bottom-right) ===
  document.addEventListener("DOMContentLoaded", () => {
    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;bottom:12px;right:12px;z-index:99999;display:flex;gap:8px;align-items:center";
    bar.innerHTML = `
      <button id="btnGsDown" class="btn secondary small" title="Scarica dati dal Foglio Google nel CRM">‚¨áÔ∏è Google ‚Üí CRM</button>
      <button id="btnGsUp" class="btn primary small" title="Invia dati dal CRM al Foglio Google">‚¨ÜÔ∏è CRM ‚Üí Google</button>
      <button id="btnGsPing" class="btn small" title="Test collegamento">üîå Test</button>
    `;
    document.body.appendChild(bar);

    document.getElementById("btnGsUp").addEventListener("click", syncUp);
    document.getElementById("btnGsDown").addEventListener("click", syncDown);
    document.getElementById("btnGsPing").addEventListener("click", async ()=>{
      try{
        const r = await gsCall("ping");
        toast("Collegamento OK ‚úÖ " + (r.ts||""), 1600);
      }catch(e){
        alert("Test fallito: " + e.message + "\n\nControlla: token, deploy Web App (Chiunque con link), e che stai usando l'URL /exec.");
      }
    });
  });

  // === SYNC UP: CRM -> Google ===
  async function syncUp() {
    try {
      // Le variabili principali del CRM sono array: anagrafica, contratti, device, riparazioni
      await gsCall("upsertMany", { table: "clients", rows: (window.anagrafica || []) });
      await gsCall("upsertMany", { table: "contracts", rows: (window.contratti || []) });
      await gsCall("upsertMany", { table: "devices", rows: (window.device || []) });
      await gsCall("upsertMany", { table: "repairs", rows: (window.riparazioni || []) });

      toast("Sincronizzato su Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync UP: " + e.message + "\n\nSuggerimento: apri 'üîå Test' per vedere se la Web App risponde.");
    }
  }

  // === SYNC DOWN: Google -> CRM ===
  async function syncDown() {
    try {
      const a = await gsCall("getAll", { table: "clients" });
      const c = await gsCall("getAll", { table: "contracts" });
      const d = await gsCall("getAll", { table: "devices" });
      const r = await gsCall("getAll", { table: "repairs" });

      window.anagrafica = (a.rows || []);
      window.contratti = (c.rows || []);
      window.device = (d.rows || []);
      window.riparazioni = (r.rows || []);

      saveStore();
      refreshAll();
      toast("Dati scaricati da Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync DOWN: " + e.message + "\n\nControlla anche che le tab nel Foglio si chiamino: clients, contracts, devices, repairs.");
    }
  }
</script>
<!-- ========================================================================== -->

</body></html>`;
  const w = window.open("", "_blank");
  if(!w){ alert("Popup bloccato: abilita i popup per stampare."); return; }
  w.document.open(); w.document.write(html); w.document.close();
  try{ w.focus(); w.print(); }catch(e){}
}
function waPhonePretty(phone){
  return (phone||"").toString().trim();
}

function toNum(x){
  if(x===null||x===undefined) return null;
  const s=(""+x).replace(",",".").replace(/[^\d.-]/g,"").trim();
  if(!s) return null;
  const n=Number(s);
  return Number.isFinite(n)?n:null;
}
function toDateISO(x){
  if(!x) return "";
  if(typeof x==="string"){
    const t = x.trim();
    const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(m){
      const dd = m[1].padStart(2,"0");
      const mm = m[2].padStart(2,"0");
      const yyyy = m[3];
      return `${yyyy}-${mm}-${dd}`;
    }
    if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
  }
  const d=new Date(x);
  if(isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}
function moneyFmt(n){
  if(n===null||n===undefined) return "‚Äî";
  return n.toLocaleString("it-IT",{style:"currency",currency:"EUR"});
}
function lastNDays(dateISO, n=30){
  const d=new Date(dateISO);
  if(isNaN(d)) return false;
  const now=new Date();
  const diff=(now-d)/(1000*60*60*24);
  return diff>=0 && diff<=n;
}
function safeId(prefix="ID"){
  return prefix + "-" + Math.random().toString(36).slice(2,8).toUpperCase() + "-" + Date.now().toString().slice(-4);
}
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return [...document.querySelectorAll(sel)]; }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* =========================
   STORAGE
========================= */
const STORE_KEY = "VOLPEX_CRM_PRO_V3";
const VALUE_SETTINGS_KEY = "VOLPEX_VALUE_SETTINGS_V1";
const CAMPAIGNS_KEY = "VOLPEX_CAMPAIGNS_V1";

function saveStore(){
  const payload = { anagrafica, contratti, device, riparazioni };
  localStorage.setItem(STORE_KEY, JSON.stringify(payload));
}
function loadStore(){
  const raw = localStorage.getItem(STORE_KEY);
  if(!raw) return false;
  try{
    const p = JSON.parse(raw);
    if(!p) return false;
    anagrafica = Array.isArray(p.anagrafica) ? p.anagrafica : [];
    contratti = Array.isArray(p.contratti) ? p.contratti : [];
    device = Array.isArray(p.device) ? p.device : [];
    riparazioni = Array.isArray(p.riparazioni) ? p.riparazioni : [];
    return true;
  }catch(e){ return false; }
}


/* =========================
   VALUE SETTINGS + CAMPAIGNS
========================= */
function defaultValueSettings(){
  return { months: 12, marginDevPct: 15, marginRipPct: 40 };
}
function loadValueSettings(){
  try{
    const raw = localStorage.getItem(VALUE_SETTINGS_KEY);
    if(!raw) return defaultValueSettings();
    const v = JSON.parse(raw);
    const d = defaultValueSettings();
    return {
      months: Math.max(1, parseInt(v.months ?? d.months,10)),
      marginDevPct: Math.max(0, Math.min(100, parseFloat(v.marginDevPct ?? d.marginDevPct))),
      marginRipPct: Math.max(0, Math.min(100, parseFloat(v.marginRipPct ?? d.marginRipPct)))
    };
  }catch(e){ return defaultValueSettings(); }
}
function saveValueSettings(v){
  localStorage.setItem(VALUE_SETTINGS_KEY, JSON.stringify(v));
}
function loadCampaigns(){
  try{
    const raw = localStorage.getItem(CAMPAIGNS_KEY);
    return raw ? (JSON.parse(raw) || []) : [];
  }catch(e){ return []; }
}
function saveCampaigns(list){
  localStorage.setItem(CAMPAIGNS_KEY, JSON.stringify(list||[]));
}
let campaigns = loadCampaigns();
let selectedCampaignId = "";

/* =========================
   DEMO DATA
========================= */
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d.toISOString().slice(0,10); }
let anagrafica = [];
let contratti = [];
let device = [];
let riparazioni = [];
let reportRows = [];
let lastReportTypeCounts = { CONTRATTO:0, DEVICE:0, RIPARAZIONE:0 };

function seedDemo(){
  anagrafica = [
    { cf:"RSSMRA80X01H501Z", nome:"MARIO",  cognome:"ROSSI",   tipo:"PRIVATO",  telefono:"+39 3331234567", email:"mario.rossi@email.it", citta:"ROMA",   indirizzo:"VIA ROMA 1" },
    { cf:"BNCLGU85T10F205X", nome:"LUIGI",  cognome:"BIANCHI", tipo:"PRIVATO",  telefono:"+39 3339876543", email:"luigi.bianchi@email.it", citta:"MILANO", indirizzo:"VIA MILANO 22" },
    { cf:"VRDGNN90A01F839K", nome:"GIANNA", cognome:"VERDI",   tipo:"BUSINESS", telefono:"+39 3201112223", email:"gianna.verdi@email.it", citta:"TORINO", indirizzo:"CORSO TORINO 9" }
  ];

  contratti = [
    {
      id:"", id_cliente:"C001", cf:"RSSMRA80X01H501Z",
      data_contratto:"2025-12-17", tipo_cliente:"PRIVATO", tipo_attivazione:"MNP", tecnologia:"SIM",
      convergenza:"NO", mnp:"SI", data_attivazione:"2025-12-17", data_portabilita:"",
      numero_lavorato:"333123456", nome_offerta:"OFFERTA X", costo_offerta:"9.99", vincolo_offerta_mesi:"24",
      telefono_incluso:"SI", imei:"123456789012345", modello:"IPHONE 13", tipo_pagamento:"CARTA",
      mesi_vincolo_telefono:"24", data_fine_vincolo_offerta:"", data_fine_vincolo_telefono:"",
      compagnia:"VODAFONE", iccid_vecchio:"", iccid_nuovo:"", created_at:"", updated_at:""
    },
    {
      id:"C-0002", id_cliente:"C002", cf:"BNCLGU85T10F205X",
      data_contratto:daysAgo(8), tipo_cliente:"PRIVATO", tipo_attivazione:"NUOVA", tecnologia:"FTTH",
      convergenza:"SI", mnp:"NO", data_attivazione:daysAgo(7), data_portabilita:"",
      numero_lavorato:"", nome_offerta:"FIBRA 24.99", costo_offerta:"24.99", vincolo_offerta_mesi:"24",
      telefono_incluso:"NO", imei:"", modello:"", tipo_pagamento:"",
      mesi_vincolo_telefono:"", data_fine_vincolo_offerta:"", data_fine_vincolo_telefono:"",
      compagnia:"TIM", iccid_vecchio:"", iccid_nuovo:"", created_at:"", updated_at:""
    }
  ];

  device = [
    { id:"D-1001", cf:"RSSMRA80X01H501Z", data:daysAgo(10), modello:"IPHONE 13", imei:"123456789012345", prezzo:"699", venditore:"AUGUSTO", pagamento:"CARTA" },
    { id:"D-1002", cf:"BNCLGU85T10F205X", data:daysAgo(28), modello:"SAMSUNG A54", imei:"351111222233334", prezzo:"349", venditore:"AUGUSTO", pagamento:"BANCOMAT" }
  ];

  riparazioni = [
    { id:"R-9001", cf:"BNCLGU85T10F205X", data_ingresso:daysAgo(3), modello:"SAMSUNG A52", problema:"DISPLAY ROTTO", stato:"PRONTA", costo:"59", imei:"351010101010101" },
    { id:"R-9002", cf:"RSSMRA80X01H501Z", data_ingresso:daysAgo(12), modello:"IPHONE 13", problema:"BATTERIA", stato:"IN LAVORAZIONE", costo:"89", imei:"123456789012345" }
  ];
}

/* =========================
   NAV
========================= */
const pageTitle = document.getElementById("pageTitle");
qsa("[data-view]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    qsa("[data-view]").forEach(x=>x.classList.remove("active"));
    qsa(".view").forEach(v=>v.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("view-"+btn.dataset.view).classList.add("active");
    pageTitle.textContent = btn.textContent.replace(/^.[^ ]* /,'').trim();
  });
});
document.getElementById("btnPrint").addEventListener("click", ()=>window.print());

/* =========================
   LOOKUP & VALIDATION
========================= */
function anagByCF(cf){
  const key = upper(cf);
  return anagrafica.find(a => upper(a.cf) === key) || null;
}
function clienteNome(cf){
  const a = anagByCF(cf);
  if(!a) return "";
  return [a.nome, a.cognome].filter(Boolean).join(" ").trim();
}
function contattoStr(cf){
  const a = anagByCF(cf);
  if(!a) return "";
  return [a.telefono, a.email].filter(Boolean).join(" ‚Ä¢ ");
}
function mustHaveFK(cf){ return !!anagByCF(cf); }
/* =========================
   Contratti: cerca cliente prima di inserire
========================= */
function conFindClient(){
  const cf = upper(qs("#c_cf").value);
  const status = qs("#c_cf_status");
  if(!cf){ status.textContent = "Inserisci un CF."; status.style.color=""; return; }

  const a = anagByCF(cf);
  if(a){
    status.innerHTML = `Cliente trovato: <b>${clienteNome(cf)}</b> ‚Ä¢ ${contattoStr(cf) || ""}`;
    status.style.color = "#166534";
    qs("#conQuickAnag").style.display = "none";
  }else{
    status.innerHTML = `Cliente <b>NON trovato</b>. Inserisci l'anagrafica veloce qui sotto.`;
    status.style.color = "#991b1b";
    // prepara quick anag
    qs("#conQuickAnag").style.display = "block";
    qs("#qa_cf").value = cf;
    qs("#qa_nome").focus();
  }
}

function createClientFromQuick(){
  const cf = upper(qs("#qa_cf").value);
  const nome = upper(qs("#qa_nome").value);
  const cognome = upper(qs("#qa_cognome").value);
  if(!cf || !nome || !cognome){ toast("CF, Nome, Cognome sono obbligatori"); return; }

  const rec = {
    cf, nome, cognome,
    tipo: upper(qs("#qa_tipo").value),
    telefono: (qs("#qa_telefono").value||"").trim(),
    email: (qs("#qa_email").value||"").trim(),
    citta: upper(qs("#qa_citta").value),
    indirizzo: upper(qs("#qa_indirizzo").value),
    data_nascita: qs("#qa_data_nascita").value || ""
  };

  const idx = anagrafica.findIndex(x=>upper(x.cf)===cf);
  if(idx>=0) anagrafica[idx]=rec; else anagrafica.push(rec);

  saveStore();
  renderAnag();
  toast("Cliente creato ‚úÖ Ora puoi salvare il contratto");
  qs("#conQuickAnag").style.display = "none";
  // aggiorna status
  conFindClient();
}

function cancelQuickClient(){
  qs("#conQuickAnag").style.display = "none";
  qs("#c_cf_status").textContent = "Inserisci CF e premi ‚ÄúCerca cliente‚Äù.";
  qs("#c_cf_status").style.color = "";
}


function devFindClient(){
  const cf = upper(qs("#d_cf").value);
  const status = qs("#d_cf_status");
  if(!cf){ status.textContent = "Inserisci un CF."; status.style.color=""; return; }

  const a = anagByCF(cf);
  if(a){
    status.innerHTML = `Cliente trovato: <b>${clienteNome(cf)}</b> ‚Ä¢ ${contattoStr(cf) || ""}`;
    status.style.color = "#166534";
    qs("#devQuickAnag").style.display = "none";
  }else{
    status.innerHTML = `Cliente <b>NON trovato</b>. Inserisci l'anagrafica veloce qui sotto.`;
    status.style.color = "#991b1b";
    qs("#devQuickAnag").style.display = "block";
    qs("#qd_cf").value = cf;
    qs("#qd_nome").value = "";
    qs("#qd_cognome").value = "";
    qs("#qd_tipo").value = "";
    qs("#qd_telefono").value = "";
    qs("#qd_email").value = "";
    qs("#qd_citta").value = "";
    qs("#qd_indirizzo").value = "";
    qs("#qd_data_nascita").value = "";
  }
}

function ripFindClient(){
  const cf = upper(qs("#r_cf").value);
  const status = qs("#r_cf_status");
  if(!cf){ status.textContent = "Inserisci un CF."; status.style.color=""; return; }

  const a = anagByCF(cf);
  if(a){
    status.innerHTML = `Cliente trovato: <b>${clienteNome(cf)}</b> ‚Ä¢ ${contattoStr(cf) || ""}`;
    status.style.color = "#166534";
    qs("#ripQuickAnag").style.display = "none";
  }else{
    status.innerHTML = `Cliente <b>NON trovato</b>. Inserisci l'anagrafica veloce qui sotto.`;
    status.style.color = "#991b1b";
    qs("#ripQuickAnag").style.display = "block";
    qs("#qr_cf").value = cf;
    qs("#qr_nome").value = "";
    qs("#qr_cognome").value = "";
    qs("#qr_tipo").value = "";
    qs("#qr_telefono").value = "";
    qs("#qr_email").value = "";
    qs("#qr_citta").value = "";
    qs("#qr_indirizzo").value = "";
    qs("#qr_data_nascita").value = "";
  }
}

function createClientFromQuickDev(){
  const cf = upper(qs("#qd_cf").value);
  const nome = upper(qs("#qd_nome").value);
  const cognome = upper(qs("#qd_cognome").value);
  if(!cf || !nome || !cognome){ toast("CF, Nome, Cognome sono obbligatori"); return; }

  const rec = {
    cf, nome, cognome,
    tipo: upper(qs("#qd_tipo").value),
    telefono: (qs("#qd_telefono").value||"").trim(),
    email: (qs("#qd_email").value||"").trim(),
    citta: upper(qs("#qd_citta").value),
    indirizzo: upper(qs("#qd_indirizzo").value),
    data_nascita: qs("#qd_data_nascita").value || ""
  };

  const idx = anagrafica.findIndex(x=>upper(x.cf)===cf);
  if(idx>=0) anagrafica[idx]=rec; else anagrafica.push(rec);

  saveStore();
  renderAnag();
  toast("Cliente creato ‚úÖ Ora puoi salvare il device");
  qs("#devQuickAnag").style.display = "none";
  // aggiorna status
  qs("#d_cf_status").innerHTML = `Cliente creato: <b>${clienteNome(cf)}</b>`;
  qs("#d_cf_status").style.color = "#166534";
}

function createClientFromQuickRip(){
  const cf = upper(qs("#qr_cf").value);
  const nome = upper(qs("#qr_nome").value);
  const cognome = upper(qs("#qr_cognome").value);
  if(!cf || !nome || !cognome){ toast("CF, Nome, Cognome sono obbligatori"); return; }

  const rec = {
    cf, nome, cognome,
    tipo: upper(qs("#qr_tipo").value),
    telefono: (qs("#qr_telefono").value||"").trim(),
    email: (qs("#qr_email").value||"").trim(),
    citta: upper(qs("#qr_citta").value),
    indirizzo: upper(qs("#qr_indirizzo").value),
    data_nascita: qs("#qr_data_nascita").value || ""
  };

  const idx = anagrafica.findIndex(x=>upper(x.cf)===cf);
  if(idx>=0) anagrafica[idx]=rec; else anagrafica.push(rec);

  saveStore();
  renderAnag();
  toast("Cliente creato ‚úÖ Ora puoi salvare la riparazione");
  qs("#ripQuickAnag").style.display = "none";
  qs("#r_cf_status").innerHTML = `Cliente creato: <b>${clienteNome(cf)}</b>`;
  qs("#r_cf_status").style.color = "#166534";
}

function cancelQuickClientDev(){
  qs("#devQuickAnag").style.display = "none";
  qs("#d_cf_status").textContent = "Inserisci CF e premi ‚ÄúCerca cliente‚Äù.";
  qs("#d_cf_status").style.color = "";
}

function cancelQuickClientRip(){
  qs("#ripQuickAnag").style.display = "none";
  qs("#r_cf_status").textContent = "Inserisci CF e premi ‚ÄúCerca cliente‚Äù.";
  qs("#r_cf_status").style.color = "";
}



/* =========================
   CSV (parser)
========================= */
function detectDelimiter(line){
  const semi = (line.match(/;/g)||[]).length;
  const comma = (line.match(/,/g)||[]).length;
  return semi >= comma ? ";" : ",";
}
function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    }else if(ch === delim && !inQ){
      out.push(cur); cur = "";
    }else{
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  text = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim();
  if(!text) return { headers:[], rows:[] };
  const firstLine = text.split("\n")[0];
  const delim = detectDelimiter(firstLine);
  const lines = text.split("\n").filter(l=>l.trim().length);
  const headers = splitCSVLine(lines[0], delim).map(h=>h.trim());
  const rows = lines.slice(1).map(line=>{
    const cells = splitCSVLine(line, delim);
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (cells[i] ?? "").trim());
    return obj;
  });
  return { headers, rows };
}
async function readFileText(inputEl){
  const f = inputEl.files && inputEl.files[0];
  if(!f) throw new Error("Seleziona un file CSV");
  return await f.text();
}

/* =========================
   CSV Smart headers mapping
========================= */
function normKey(k){
  return (k ?? "")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[()]/g,"")
    .replace(/[^\w]+/g,"_")
    .replace(/^_+|_+$/g,"");
}
function mapRowSmart(row, schema){
  const out = {};
  const rawKeys = Object.keys(row||{});
  const table = new Map();
  rawKeys.forEach(k => table.set(normKey(k), row[k]));
  Object.keys(schema).forEach(canon=>{
    const aliases = schema[canon] || [];
    const all = [canon, ...aliases].map(normKey);
    let val = "";
    for(const a of all){
      if(table.has(a)){ val = (table.get(a) ?? "").toString(); break; }
    }
    out[canon] = (val ?? "").toString().trim();
  });
  return out;
}

/* =========================
   SCHEMI (con intestazioni reali)
========================= */
const SCHEMA_ANAG = {
  cf: ["codice_fiscale","codicefiscale","cf_cliente","cod_fiscale","c_f"],
  nome: ["name"],
  cognome: ["surname","cognome_cliente"],
  tipo: ["tipo_cliente","tipo cliente","tipocliente","customer_type"],
  telefono: ["cellulare","tel","telefono_cliente","phone"],
  email: ["mail","e_mail"],
  citta: ["citt√†","city","comune"],
  indirizzo: ["address","via","indirizzo_cliente"]
,
  data_nascita: ["data_nascita","data nascita","birthdate","data di nascita","nascita"]
};

const SCHEMA_CON = {
  id: ["id_contratto","id contratto","idcontract","id"],
  id_cliente: ["id_cliente","id cliente","cliente_id"],
  cf: ["codice_fiscale","codice fiscale","cf","cf_cliente"],
  data_contratto: ["data_contratto","data contratto","data","date"],
  tipo_cliente: ["tipo_cliente","tipo cliente"],
  tipo_attivazione: ["tipo_attivazione","tipo attivazione"],
  tecnologia: ["tecnologia","technology","tec"],
  convergenza: ["convergenza"],
  mnp: ["mnp"],
  data_attivazione: ["data_attivazione","data attivazione"],
  data_portabilita: ["data_portabilita","data portabilit√†","data portabilita","portabilita"],
  numero_lavorato: ["numero_lavorato","numero lavorato","numero","msisdn"],
  nome_offerta: ["nome_offerta","nome offerta","offerta","offer"],
  costo_offerta: ["costo_offerta","costo offerta","canone","prezzo_offerta"],
  vincolo_offerta_mesi: ["vincolo_offerta_mesi","vincolo offerta (mesi)","vincolo offerta mesi"],
  telefono_incluso: ["telefono_incluso","telefono incluso"],
  imei: ["imei","imei_telefono","imei telefono"],
  modello: ["modello","model"],
  tipo_pagamento: ["tipo_pagamento","tipo pagamento","payment"],
  mesi_vincolo_telefono: ["mesi_vincolo_telefono","mesi vincolo telefono"],
  data_fine_vincolo_offerta: ["data_fine_vincolo_offerta","data fine vincolo offerta"],
  data_fine_vincolo_telefono: ["data_fine_vincolo_telefono","data fine vincolo telefono"],
  compagnia: ["compagnia","operatore","carrier"],
  iccid_vecchio: ["iccid_vecchio","iccid vecchio","iccid_old"],
  iccid_nuovo: ["iccid_nuovo","iccid nuovo","iccid_new"],
  created_at: ["created_at","created at","created"],
  updated_at: ["updated_at","updated at","updated"]
};

const SCHEMA_DEV = {
  id: ["id_device","id device","id"],
  cf: ["codice_fiscale","codice fiscale","cf"],
  data: ["data_vendita","data vendita","date","data"],
  modello: ["model","modello_device","modello"],
  imei: ["imei_device","imei telefono","imei"],
  prezzo: ["price","importo","totale","prezzo"],
  venditore: ["sales","seller","agente","venditore"],
  pagamento: ["tipo_pagamento","tipo pagamento","payment","pagamento"]
};

const SCHEMA_RIP = {
  id: ["id_riparazione","id riparazione","id"],
  cf: ["codice_fiscale","codice fiscale","cf"],
  data_ingresso: ["data_ingresso","data ingresso","ingresso","data","date"],
  modello: ["device_modello","device modello","model","modello"],
  imei: ["imei_device","imei telefono","imei"],
  problema: ["guasto","difetto","descrizione_problema","problema"],
  stato: ["status","stato_riparazione","stato riparazione","stato"],
  costo: ["price","importo","totale","costo"]
};

/* =========================
   CSV Download
========================= */
function downloadCSV(filename, headers, objects){
  const lines = [];
  lines.push(headers.join(";"));
  objects.forEach(o=>{
    const row = headers.map(h=>{
      const v = (o[h] ?? "").toString().replaceAll('"','""');
      return `"${v}"`;
    }).join(";");
    lines.push(row);
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   Export per tab
========================= */
function exportAnag(){
  const headers = ["cf","nome","cognome","tipo","telefono","email","citta","indirizzo","data_nascita"];
  downloadCSV(`anagrafica_${todayISO()}.csv`, headers, anagrafica.map(a=>({
    cf:a.cf, nome:a.nome, cognome:a.cognome, tipo:a.tipo||"", telefono:a.telefono||"", email:a.email||"", citta:a.citta||"", indirizzo:a.indirizzo||"", data_nascita:a.data_nascita||""
  })));
}
function exportCon(){
  const headers = [
    "id","id_cliente","cf","data_contratto","tipo_cliente","tipo_attivazione","tecnologia","convergenza","mnp",
    "data_attivazione","data_portabilita","numero_lavorato","nome_offerta","costo_offerta","vincolo_offerta_mesi",
    "telefono_incluso","imei","modello","tipo_pagamento","mesi_vincolo_telefono",
    "data_fine_vincolo_offerta","data_fine_vincolo_telefono","compagnia","iccid_vecchio","iccid_nuovo",
    "created_at","updated_at"
  ];
  downloadCSV(`contratti_${todayISO()}.csv`, headers, contratti);
}
function exportDev(){
  const headers = ["id","cf","data","modello","imei","prezzo","venditore","pagamento"];
  downloadCSV(`device_${todayISO()}.csv`, headers, device);
}
function exportRip(){
  const headers = ["id","cf","data_ingresso","modello","imei","problema","stato","costo"];
  downloadCSV(`riparazioni_${todayISO()}.csv`, headers, riparazioni);
}
function exportReport(){
  const headers = ["tipo","date","cf","cliente","contatto","citta","descr","extra"];
  downloadCSV(`report_${todayISO()}.csv`, headers, reportRows.map(r=>({
    tipo:r.tipo, date:r.date, cf:r.cf, cliente:r.cliente, contatto:r.contatto, citta:r.citta, descr:r.descr, extra:r.extra
  })));
}

/* =========================
   CHARTS (Canvas simple)
========================= */
function drawAxes(ctx, w, h, pad=36){
  ctx.clearRect(0,0,w,h);
  ctx.lineWidth = 1;
  ctx.strokeStyle = "#e5e7eb";
  ctx.fillStyle = "#0f172a";
  ctx.font = "12px system-ui";
  ctx.beginPath();
  ctx.moveTo(pad, 10);
  ctx.lineTo(pad, h-pad);
  ctx.lineTo(w-10, h-pad);
  ctx.stroke();
  return { pad };
}
function drawLineSeries(ctx, w, h, series, labels){
  const pad = 36;
  drawAxes(ctx, w, h, pad);
  const all = series.flatMap(s=>s.data);
  const maxV = Math.max(1, ...all);
  const n = labels.length;
  const x0 = pad, y0 = h-pad, x1 = w-10, y1 = 10;
  const dx = (x1-x0) / Math.max(1, n-1);

  ctx.strokeStyle = "#eef2ff";
  for(let i=0;i<=4;i++){
    const y = y0 - (i/4)*(y0-y1);
    ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke();
    ctx.fillStyle = "#64748b";
    ctx.fillText(String(Math.round((i/4)*maxV)), 6, y+4);
  }

  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#0ea5e9","#a855f7"];
  series.forEach((s,idx)=>{
    const col = palette[idx % palette.length];
    ctx.strokeStyle = col;
    ctx.lineWidth = 2;
    ctx.beginPath();
    s.data.forEach((v,i)=>{
      const x = x0 + i*dx;
      const y = y0 - (v/maxV)*(y0-y1);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = col;
    ctx.fillRect(x0 + idx*110, 14, 10, 10);
    ctx.fillStyle = "#0f172a";
    ctx.fillText(s.name, x0 + idx*110 + 14, 24);
  });

  ctx.fillStyle = "#64748b";
  const step = Math.ceil(n / 6);
  for(let i=0;i<n;i+=step){
    const x = x0 + i*dx;
    ctx.fillText(labels[i].slice(5), x-14, h-14);
  }
}
function drawBarChart(ctx, w, h, items, title){
  const pad = 36;
  drawAxes(ctx, w, h, pad);
  const maxV = Math.max(1, ...items.map(i=>i.value));
  const x0 = pad, y0 = h-pad, x1 = w-10, y1 = 10;

  ctx.fillStyle = "#0f172a";
  ctx.font = "12px system-ui";
  if(title) ctx.fillText(title, x0, 14);

  const bw = (x1-x0) / Math.max(1, items.length);
  items.forEach((it, i)=>{
    const v = it.value;
    const barH = (v/maxV)*(y0-y1);
    const x = x0 + i*bw + 6;
    const y = y0 - barH;
    const barW = Math.max(10, bw-12);

    ctx.fillStyle = "#2563eb";
    ctx.fillRect(x, y, barW, barH);

    ctx.fillStyle = "#0f172a";
    ctx.font = "11px system-ui";
    ctx.fillText(String(v), x, y-4);

    ctx.fillStyle = "#64748b";
    const lab = (it.label||"").slice(0,12);
    ctx.fillText(lab, x, h-14);
  });
}

function drawPieChart(ctx, w, h, items, title){
  ctx.clearRect(0,0,w,h);

  const cleaned = (items||[]).map(it=>({
    label: (it.label ?? "‚Äî").toString(),
    value: Math.max(0, Number(it.value) || 0)
  }));
  const total = cleaned.reduce((s,it)=>s+it.value,0);

  if(title){
    ctx.fillStyle = "#0f172a";
    ctx.font = "13px system-ui";
    ctx.fillText(title, 12, 18);
  }

  if(total<=0){
    ctx.fillStyle = "#64748b";
    ctx.font = "14px system-ui";
    ctx.fillText("Nessun dato", 12, 44);
    return;
  }

  // spazio per legenda a sinistra
  const cx = w/2 + 40;
  const cy = h/2 + 10;
  const radius = Math.min(w,h)/2 - 46;

  const palette = ["#2563eb","#16a34a","#f59e0b","#dc2626","#0ea5e9","#a855f7","#22c55e","#f97316"];

  let start = -Math.PI/2;
  cleaned.forEach((it, idx)=>{
    const frac = it.value / total;
    const ang = frac * Math.PI * 2;
    const end = start + ang;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,start,end);
    ctx.closePath();
    ctx.fillStyle = palette[idx % palette.length];
    ctx.fill();

    start = end;
  });

  // legenda
  ctx.font = "12px system-ui";
  cleaned.forEach((it, idx)=>{
    const col = palette[idx % palette.length];
    const y = 40 + idx*18;
    ctx.fillStyle = col;
    ctx.fillRect(12, y-10, 10, 10);

    const perc = Math.round((it.value/total)*100);
    ctx.fillStyle = "#0f172a";
    ctx.fillText(`${it.label}: ${it.value} (${perc}%)`, 28, y);
  });
}


/* =========================
   Metrics + dashboard/console
========================= */
function compute30(){
  const con30 = contratti
    .map(x=>({
      ...x,
      date: toDateISO(x.data_contratto || x.data),
      cf: upper(x.cf),
      cliente: clienteNome(x.cf),
      compagnia: upper(x.compagnia),
      offerta: upper(x.nome_offerta || x.offerta),
      tecnologia: upper(x.tecnologia),
      mnp: upper(x.mnp),
      id: x.id,
      id_cliente: x.id_cliente
    }))
    .filter(x=>x.date && lastNDays(x.date,30))
    .sort((a,b)=>(b.date||"").localeCompare(a.date||""));

  const dev30 = device
    .map(x=>({
      ...x,
      date: toDateISO(x.data),
      cf: upper(x.cf),
      cliente: clienteNome(x.cf),
      modello: upper(x.modello),
      imei: upper(x.imei),
      prezzo: toNum(x.prezzo),
      venditore: upper(x.venditore||""),
      id: x.id
    }))
    .filter(x=>x.date && lastNDays(x.date,30))
    .sort((a,b)=>(b.date||"").localeCompare(a.date||""));

  const rip30 = riparazioni
    .map(x=>({
      ...x,
      date: toDateISO(x.data_ingresso),
      cf: upper(x.cf),
      cliente: clienteNome(x.cf),
      modello: upper(x.modello),
      problema: upper(x.problema),
      stato: upper(x.stato),
      costo: toNum(x.costo),
      id: x.id
    }))
    .filter(x=>x.date && lastNDays(x.date,30))
    .sort((a,b)=>(b.date||"").localeCompare(a.date||""));

  return { con30, dev30, rip30 };
}

function renderDashboardAndConsole(){
  const { con30, dev30, rip30 } = compute30();

  setText("kpiClienti", anagrafica.length);
  setText("kpiClientiSub", "Totale clienti");
  setText("kpiContratti30", con30.length);
  setText("kpiContrattiSub", "Basato su Data contratto");
  setText("kpiDevice30", dev30.length);
  setText("kpiDeviceSub", "Basato su data vendita");
  setText("kpiRip30", rip30.length);
  setText("kpiRipSub", "Basato su data ingresso");

  const sumDev = dev30.reduce((s,x)=>s+(x.prezzo||0),0);
  const sumRip = rip30.reduce((s,x)=>s+(x.costo||0),0);
  setText("kpiDeviceEur", moneyFmt(sumDev));
  setText("kpiRipEur", moneyFmt(sumRip));

  setText("badgeContratti30", con30.length + " righe");
  setText("badgeDevice30", dev30.length + " righe");
  setText("badgeRip30", rip30.length + " righe");

  qs("#tblContratti30 tbody").innerHTML = con30.map(x=>`
    <tr>
      <td>${x.date}</td>
      <td class="mono">${x.id || ""}</td>
      <td class="mono">${x.cf}</td>
      <td>${x.cliente}</td>
      <td>${x.compagnia}</td>
      <td>${x.offerta}</td>
      <td>${x.tecnologia}</td>
      <td><span class="badge ${x.mnp==="SI"?"good":"warn"}">${x.mnp||""}</span></td>
    </tr>
  `).join("") || `<tr><td colspan="8" class="muted">Nessun dato.</td></tr>`;

  qs("#tblDevice30 tbody").innerHTML = dev30.map(x=>`
    <tr>
      <td>${x.date}</td>
      <td class="mono">${x.id}</td>
      <td class="mono">${x.cf}</td>
      <td>${x.cliente}</td>
      <td>${x.modello}</td>
      <td class="mono">${x.imei}</td>
      <td>${x.prezzo!=null ? moneyFmt(x.prezzo) : "‚Äî"}</td>
      <td>${x.venditore}</td>
    </tr>
  `).join("") || `<tr><td colspan="8" class="muted">Nessun dato.</td></tr>`;

  qs("#tblRip30 tbody").innerHTML = rip30.map(x=>{
    const cls = x.stato.includes("PRON") || x.stato.includes("CONS") ? "good" : (x.stato.includes("APER") ? "warn" : "");
    return `
    <tr>
      <td>${x.date}</td>
      <td class="mono">${x.id}</td>
      <td class="mono">${x.cf}</td>
      <td>${x.cliente}</td>
      <td>${x.modello}</td>
      <td>${x.problema}</td>
      <td><span class="badge ${cls}">${x.stato}</span></td>
      <td>${x.costo!=null ? moneyFmt(x.costo) : "‚Äî"}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="8" class="muted">Nessun dato.</td></tr>`;

  setText("totalRecords", String(anagrafica.length + contratti.length + device.length + riparazioni.length));
}

/* =========================
   CRUD RENDER
========================= */
function renderAnag(){
  const q = upper(qs("#searchAnag").value);
  const rows = anagrafica
    .slice()
    .sort((a,b)=>(a.cognome||"").localeCompare(b.cognome||""))
    .filter(a=> !q ? true : upper(JSON.stringify(a)).includes(q));

  qs("#tblAnag tbody").innerHTML = rows.map(a=>`
    <tr>
      <td class="mono">${a.cf}</td>
      <td>${a.nome||""}</td>
      <td>${a.cognome||""}</td>
      <td>${a.tipo||""}</td>
      <td>${a.telefono||""}</td>
      <td>${a.email||""}</td>
      <td>${a.citta||""}</td>
      <td>
        <button class="btn secondary small" onclick="openClientSheet('${a.cf}')">Scheda</button>
        ${a.telefono ? `<a class="btn secondary small" href="${waLink(a.telefono)}" target="_blank" rel="noopener" style="text-decoration:none">üí¨ WhatsApp</a>` : ``}
        <button class="btn secondary small" onclick="editAnag('${a.cf}')">Modifica</button>
        <button class="btn danger small" onclick="deleteAnag('${a.cf}')">Elimina</button>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="8" class="muted">Nessun cliente.</td></tr>`;
}

function renderCon(){
  const q = upper(qs("#searchCon").value);
  const rows = contratti
    .slice()
    .sort((a,b)=>(toDateISO(b.data_contratto)||"").localeCompare(toDateISO(a.data_contratto)||""))
    .filter(c=> !q ? true : upper(JSON.stringify(c)).includes(q));

  qs("#tblCon tbody").innerHTML = rows.map(c=>`
    <tr>
      <td class="mono">${c.id}</td>
      <td class="mono">${c.id_cliente||""}</td>
      <td>${toDateISO(c.data_contratto)||""}</td>
      <td class="mono">${c.cf}</td>
      <td>${clienteNome(c.cf)}</td>
      <td>${c.compagnia||""}</td>
      <td>${c.nome_offerta||""}</td>
      <td>${c.tecnologia||""}</td>
      <td><span class="badge ${upper(c.mnp)==="SI"?"good":"warn"}">${c.mnp||""}</span></td>
      <td>${c.numero_lavorato||""}</td>
      <td class="mono">${c.imei||""}</td>
      <td class="mono">${c.iccid_nuovo||""}</td>
      <td>
        <button class="btn secondary small" onclick="editCon('${c.id}')">Modifica</button>
        <button class="btn danger small" onclick="deleteCon('${c.id}')">Elimina</button>
        <button class="btn secondary small" onclick="printReceipt('con','${c.id}')">Ricevuta</button>
        <a class="btn secondary small" target="_blank" href="${waLinkText(phoneByCF(c.cf), waDefaultMsg('con', c))}">WhatsApp</a>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="13" class="muted">Nessun contratto.</td></tr>`;
}

function renderDev(){
  const q = upper(qs("#searchDev").value);
  const rows = device
    .slice()
    .sort((a,b)=>(toDateISO(b.data)||"").localeCompare(toDateISO(a.data)||""))
    .filter(d=> !q ? true : upper(JSON.stringify(d)).includes(q));

  qs("#tblDev tbody").innerHTML = rows.map(d=>`
    <tr>
      <td class="mono">${d.id}</td>
      <td>${toDateISO(d.data)}</td>
      <td class="mono">${d.cf}</td>
      <td>${clienteNome(d.cf)}</td>
      <td>${d.modello||""}</td>
      <td class="mono">${d.imei||""}</td>
      <td>${toNum(d.prezzo)!=null ? moneyFmt(toNum(d.prezzo)) : "‚Äî"}</td>
      <td>${d.venditore||""}</td>
      <td>
        <button class="btn secondary small" onclick="editDev('${d.id}')">Modifica</button>
        <button class="btn danger small" onclick="deleteDev('${d.id}')">Elimina</button>
        <button class="btn secondary small" onclick="printReceipt('dev','${d.id}')">Ricevuta</button>
        <a class="btn secondary small" target="_blank" href="${waLinkText(phoneByCF(d.cf), waDefaultMsg('dev', d))}">WhatsApp</a>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="10" class="muted">Nessun device.</td></tr>`;
}

function renderRip(){
  const q = upper(qs("#searchRip").value);
  const rows = riparazioni
    .slice()
    .sort((a,b)=>(toDateISO(b.data_ingresso)||"").localeCompare(toDateISO(a.data_ingresso)||""))
    .filter(r=> !q ? true : upper(JSON.stringify(r)).includes(q));

  qs("#tblRip tbody").innerHTML = rows.map(r=>{
    const cls = (r.stato||"").includes("PRON") || (r.stato||"").includes("CONS") ? "good" : ((r.stato||"").includes("APER") ? "warn" : "");
    return `
    <tr>
      <td class="mono">${r.id}</td>
      <td>${toDateISO(r.data_ingresso)}</td>
      <td class="mono">${r.cf}</td>
      <td>${clienteNome(r.cf)}</td>
      <td>${r.modello||""}</td>
      <td>${r.problema||""}</td>
      <td><span class="badge ${cls}">${r.stato||""}</span></td>
      <td>${toNum(r.costo)!=null ? moneyFmt(toNum(r.costo)) : "‚Äî"}</td>
      <td>
        <button class="btn secondary small" onclick="editRip('${r.id}')">Modifica</button>
        <button class="btn danger small" onclick="deleteRip('${r.id}')">Elimina</button>
        <button class="btn secondary small" onclick="printReceipt('rip','${r.id}')">Ricevuta</button>
        <a class="btn secondary small" target="_blank" href="${waLinkText(phoneByCF(r.cf), waDefaultMsg('rip', r))}">WhatsApp</a>
      </td>
    </tr>`;
  }).join("") || `<tr><td colspan="10" class="muted">Nessuna riparazione.</td></tr>`;
}

/* =========================
   CRUD Actions
========================= */
function clearAnagForm(){
  ["a_cf","a_nome","a_cognome","a_tipo","a_telefono","a_email","a_citta","a_indirizzo","a_data_nascita"].forEach(id=>qs("#"+id).value="");
}
function saveAnag(){
  const cf = upper(qs("#a_cf").value);
  const nome = upper(qs("#a_nome").value);
  const cognome = upper(qs("#a_cognome").value);
  if(!cf || !nome || !cognome){ toast("CF, Nome, Cognome sono obbligatori"); return; }

  const rec = {
    cf, nome, cognome,
    tipo: upper(qs("#a_tipo").value),
    telefono: (qs("#a_telefono").value||"").trim(),
    email: (qs("#a_email").value||"").trim(),
    citta: upper(qs("#a_citta").value),
    indirizzo: upper(qs("#a_indirizzo").value),
    data_nascita: qs("#a_data_nascita").value || ""
  };

  const idx = anagrafica.findIndex(x=>upper(x.cf)===cf);
  if(idx>=0) anagrafica[idx] = rec; else anagrafica.push(rec);

  saveStore(); clearAnagForm(); refreshAll(); toast("Cliente salvato ‚úÖ");
}
function editAnag(cf){
  const a = anagByCF(cf);
  if(!a){ toast("Cliente non trovato"); return; }
  qs("#a_cf").value=a.cf; qs("#a_nome").value=a.nome; qs("#a_cognome").value=a.cognome;
  qs("#a_tipo").value=a.tipo||""; qs("#a_telefono").value=a.telefono||""; qs("#a_email").value=a.email||"";
  qs("#a_citta").value=a.citta||""; qs("#a_indirizzo").value=a.indirizzo||""; qs("#a_data_nascita").value=a.data_nascita||"";
  toast("Modifica cliente: " + a.cf);
}
function deleteAnag(cf){
  const key = upper(cf);
  const hasFK = contratti.some(x=>upper(x.cf)===key) || device.some(x=>upper(x.cf)===key) || riparazioni.some(x=>upper(x.cf)===key);
  if(hasFK){ toast("Non puoi eliminare: esistono record collegati (FK)."); return; }
  anagrafica = anagrafica.filter(x=>upper(x.cf)!==key);
  saveStore(); refreshAll(); toast("Cliente eliminato");
}

function clearConForm(){
  ["c_id","c_id_cliente","c_cf","c_data_contratto","c_tipo_cliente","c_tipo_attivazione","c_tecnologia","c_convergenza","c_mnp",
   "c_data_attivazione","c_data_portabilita","c_numero_lavorato","c_nome_offerta","c_costo_offerta","c_vincolo_offerta_mesi",
   "c_telefono_incluso","c_imei","c_modello","c_tipo_pagamento","c_mesi_vincolo_telefono","c_data_fine_vincolo_offerta","c_data_fine_vincolo_telefono",
   "c_compagnia","c_iccid_vecchio","c_iccid_nuovo","c_created_at","c_updated_at"].forEach(id=>qs("#"+id).value="");
  qs("#c_data_contratto").value = todayISO();
}
function saveCon(){
  const id = (qs("#c_id").value||"").trim() || safeId("C");
  const cf = upper(qs("#c_cf").value);
  if(!cf){ toast("CF obbligatorio"); return; }
  if(!mustHaveFK(cf)){ toast("CF non presente in Anagrafica (FK)"); return; }

  const rec = {
    id,
    id_cliente: upper(qs("#c_id_cliente").value),
    cf,
    data_contratto: qs("#c_data_contratto").value || todayISO(),
    tipo_cliente: upper(qs("#c_tipo_cliente").value),
    tipo_attivazione: upper(qs("#c_tipo_attivazione").value),
    tecnologia: upper(qs("#c_tecnologia").value),
    convergenza: upper(qs("#c_convergenza").value),
    mnp: upper(qs("#c_mnp").value),
    data_attivazione: qs("#c_data_attivazione").value || "",
    data_portabilita: qs("#c_data_portabilita").value || "",
    numero_lavorato: (qs("#c_numero_lavorato").value||"").trim(),
    nome_offerta: upper(qs("#c_nome_offerta").value),
    costo_offerta: (qs("#c_costo_offerta").value||"").trim(),
    vincolo_offerta_mesi: (qs("#c_vincolo_offerta_mesi").value||"").trim(),
    telefono_incluso: upper(qs("#c_telefono_incluso").value),
    imei: upper(qs("#c_imei").value),
    modello: upper(qs("#c_modello").value),
    tipo_pagamento: upper(qs("#c_tipo_pagamento").value),
    mesi_vincolo_telefono: (qs("#c_mesi_vincolo_telefono").value||"").trim(),
    data_fine_vincolo_offerta: qs("#c_data_fine_vincolo_offerta").value || "",
    data_fine_vincolo_telefono: qs("#c_data_fine_vincolo_telefono").value || "",
    compagnia: upper(qs("#c_compagnia").value),
    iccid_vecchio: upper(qs("#c_iccid_vecchio").value),
    iccid_nuovo: upper(qs("#c_iccid_nuovo").value),
    created_at: (qs("#c_created_at").value||"").trim(),
    updated_at: (qs("#c_updated_at").value||"").trim()
  };

  const idx = contratti.findIndex(x=>x.id===id);
  if(idx>=0) contratti[idx]=rec; else contratti.push(rec);

  saveStore(); clearConForm(); refreshAll(); toast("Contratto salvato ‚úÖ");
}
function editCon(id){
  const c = contratti.find(x=>x.id===id);
  if(!c){ toast("Contratto non trovato"); return; }
  qs("#c_id").value=c.id||"";
  qs("#c_id_cliente").value=c.id_cliente||"";
  qs("#c_cf").value=c.cf||"";
  qs("#c_data_contratto").value=toDateISO(c.data_contratto)||todayISO();
  qs("#c_tipo_cliente").value=c.tipo_cliente||"";
  qs("#c_tipo_attivazione").value=c.tipo_attivazione||"";
  qs("#c_tecnologia").value=c.tecnologia||"";
  qs("#c_convergenza").value=c.convergenza||"";
  qs("#c_mnp").value=c.mnp||"";
  qs("#c_data_attivazione").value=toDateISO(c.data_attivazione)||"";
  qs("#c_data_portabilita").value=toDateISO(c.data_portabilita)||"";
  qs("#c_numero_lavorato").value=c.numero_lavorato||"";
  qs("#c_nome_offerta").value=c.nome_offerta||"";
  qs("#c_costo_offerta").value=c.costo_offerta||"";
  qs("#c_vincolo_offerta_mesi").value=c.vincolo_offerta_mesi||"";
  qs("#c_telefono_incluso").value=c.telefono_incluso||"";
  qs("#c_imei").value=c.imei||"";
  qs("#c_modello").value=c.modello||"";
  qs("#c_tipo_pagamento").value=c.tipo_pagamento||"";
  qs("#c_mesi_vincolo_telefono").value=c.mesi_vincolo_telefono||"";
  qs("#c_data_fine_vincolo_offerta").value=toDateISO(c.data_fine_vincolo_offerta)||"";
  qs("#c_data_fine_vincolo_telefono").value=toDateISO(c.data_fine_vincolo_telefono)||"";
  qs("#c_compagnia").value=c.compagnia||"";
  qs("#c_iccid_vecchio").value=c.iccid_vecchio||"";
  qs("#c_iccid_nuovo").value=c.iccid_nuovo||"";
  qs("#c_created_at").value=c.created_at||"";
  qs("#c_updated_at").value=c.updated_at||"";
  toast("Modifica contratto: " + id);
}
function deleteCon(id){
  contratti = contratti.filter(x=>x.id!==id);
  saveStore(); refreshAll(); toast("Contratto eliminato");
}

function clearDevForm(){
  ["d_id","d_cf","d_data","d_modello","d_imei","d_prezzo","d_venditore","d_pagamento"].forEach(id=>qs("#"+id).value="");
  qs("#d_data").value = todayISO();
}
function saveDev(){
  const id = (qs("#d_id").value||"").trim() || safeId("D");
  const cf = upper(qs("#d_cf").value);
  const modello = upper(qs("#d_modello").value);
  if(!cf || !modello){ toast("CF e Modello sono obbligatori"); return; }
  if(!mustHaveFK(cf)){ toast("CF non presente in Anagrafica (FK): cerca o crea il cliente"); try{ devFindClient(); }catch(e){} return; }

  const rec = {
    id, cf,
    data: qs("#d_data").value || todayISO(),
    modello,
    imei: upper(qs("#d_imei").value),
    prezzo: (qs("#d_prezzo").value||"").trim(),
    venditore: upper(qs("#d_venditore").value),
    pagamento: upper(qs("#d_pagamento").value)
  };

  const idx = device.findIndex(x=>x.id===id);
  if(idx>=0) device[idx]=rec; else device.push(rec);
  saveStore(); clearDevForm(); refreshAll(); toast("Device salvato ‚úÖ");
}
function editDev(id){
  const d = device.find(x=>x.id===id);
  if(!d){ toast("Device non trovato"); return; }
  qs("#d_id").value=d.id; qs("#d_cf").value=d.cf; qs("#d_data").value=toDateISO(d.data)||todayISO();
  qs("#d_modello").value=d.modello||""; qs("#d_imei").value=d.imei||""; qs("#d_prezzo").value=d.prezzo||"";
  qs("#d_venditore").value=d.venditore||""; qs("#d_pagamento").value=d.pagamento||"";
  toast("Modifica device: " + id);
}
function deleteDev(id){
  device = device.filter(x=>x.id!==id);
  saveStore(); refreshAll(); toast("Device eliminato");
}

function clearRipForm(){
  ["r_id","r_cf","r_ingresso","r_modello","r_imei","r_problema","r_stato","r_costo"].forEach(id=>qs("#"+id).value="");
  qs("#r_ingresso").value = todayISO();
}
function saveRip(){
  const id = (qs("#r_id").value||"").trim() || safeId("R");
  const cf = upper(qs("#r_cf").value);
  const modello = upper(qs("#r_modello").value);
  if(!cf || !modello){ toast("CF e Modello sono obbligatori"); return; }
  if(!mustHaveFK(cf)){ toast("CF non presente in Anagrafica (FK): cerca o crea il cliente"); try{ ripFindClient(); }catch(e){} return; }

  const rec = {
    id, cf,
    data_ingresso: qs("#r_ingresso").value || todayISO(),
    modello,
    imei: upper(qs("#r_imei").value),
    problema: upper(qs("#r_problema").value),
    stato: upper(qs("#r_stato").value),
    costo: (qs("#r_costo").value||"").trim()
  };

  const idx = riparazioni.findIndex(x=>x.id===id);
  if(idx>=0) riparazioni[idx]=rec; else riparazioni.push(rec);
  saveStore(); clearRipForm(); refreshAll(); toast("Riparazione salvata ‚úÖ");
}
function editRip(id){
  const r = riparazioni.find(x=>x.id===id);
  if(!r){ toast("Riparazione non trovata"); return; }
  qs("#r_id").value=r.id; qs("#r_cf").value=r.cf; qs("#r_ingresso").value=toDateISO(r.data_ingresso)||todayISO();
  qs("#r_modello").value=r.modello||""; qs("#r_imei").value=r.imei||""; qs("#r_problema").value=r.problema||"";
  qs("#r_stato").value=r.stato||""; qs("#r_costo").value=r.costo||"";
  toast("Modifica riparazione: " + id);
}
function deleteRip(id){
  riparazioni = riparazioni.filter(x=>x.id!==id);
  saveStore(); refreshAll(); toast("Riparazione eliminata");
}

/* =========================
   REPORT (agganciato ai campi contratti completi)
========================= */
function withinRange(dateISO, fromISO, toISO){
  if(!dateISO) return false;
  if(fromISO && dateISO < fromISO) return false;
  if(toISO && dateISO > toISO) return false;
  return true;
}
function anyContains(obj, q){
  if(!q) return true;
  return upper(JSON.stringify(obj||{})).includes(upper(q));
}
function runReport(){
  const tipo = upper(qs("#f_tipo").value);
  const cf = upper(qs("#f_cf").value);
  const nome = upper(qs("#f_nome").value);
  const cont = upper(qs("#f_contatto").value);
  const citta = upper(qs("#f_citta").value);
  const comp = upper(qs("#f_compagnia").value);
  const off = upper(qs("#f_offerta").value);
  const tech = upper(qs("#f_tecnologia").value);

  const tipoAtt = upper(qs("#f_tipo_attivazione").value);
  const conv = upper(qs("#f_convergenza").value);
  const mnp = upper(qs("#f_mnp").value);

  const imeiIccid = upper(qs("#f_imei_iccid").value);
  const statoRip = upper(qs("#f_stato_rip").value);
  const vendDev = upper(qs("#f_venditore").value);

  const q = qs("#f_query").value || "";
  const from = qs("#f_from").value || "";
  const to = qs("#f_to").value || "";
  const pMin = toNum(qs("#f_price_min").value);
  const pMax = toNum(qs("#f_price_max").value);

  function passAnag(cfKey){
    const a = anagByCF(cfKey);
    if(cf && upper(cfKey) !== cf) return false;
    if(nome){
      const full = a ? upper((a.nome||"")+" "+(a.cognome||"")) : "";
      if(!full.includes(nome)) return false;
    }
    if(cont){
      const blob = a ? upper((a.telefono||"")+" "+(a.email||"")) : "";
      if(!blob.includes(cont)) return false;
    }
    if(citta){
      const cc = a ? upper(a.citta||"") : "";
      if(!cc.includes(citta)) return false;
    }
    return true;
  }

  const rows = [];

  if(!tipo || tipo==="CONTRATTO"){
    contratti.forEach(x=>{
      const date = toDateISO(x.data_contratto || x.data);
      const cfKey = upper(x.cf);
      if(!passAnag(cfKey)) return;
      if(comp && !upper(x.compagnia||"").includes(comp)) return;
      if(off && !upper(x.nome_offerta||"").includes(off)) return;
      if(tech && !upper(x.tecnologia||"").includes(tech)) return;

      if(tipoAtt && !upper(x.tipo_attivazione||"").includes(tipoAtt)) return;
      if(conv && !upper(x.convergenza||"").includes(conv)) return;
      if(mnp && !upper(x.mnp||"").includes(mnp)) return;

      if(from || to){ if(!withinRange(date, from, to)) return; }
      if(imeiIccid && !anyContains(x, imeiIccid)) return;
      if(!anyContains(x, q)) return;

      const a = anagByCF(cfKey);
      rows.push({
        tipo:"CONTRATTO",
        date,
        cf: cfKey,
        cliente: clienteNome(cfKey),
        contatto: contattoStr(cfKey),
        citta: a?.citta || "",
        descr: `${upper(x.compagnia||"")} ‚Ä¢ ${upper(x.nome_offerta||"")}`,
        extra: `ATT: ${upper(x.tipo_attivazione||"")} | TEC: ${upper(x.tecnologia||"")} | MNP: ${upper(x.mnp||"")} | NUM: ${(x.numero_lavorato||"")} | ICCID: ${upper(x.iccid_nuovo||"")}`,
        _sumDev:0,_sumRip:0
      });
    });
  }

  if(!tipo || tipo==="DEVICE"){
    device.forEach(x=>{
      const date = toDateISO(x.data);
      const cfKey = upper(x.cf);
      if(!passAnag(cfKey)) return;
      if(vendDev && !upper(x.venditore||"").includes(vendDev)) return;
      if(from || to){ if(!withinRange(date, from, to)) return; }
      const price = toNum(x.prezzo);
      if(pMin!=null && (price==null || price < pMin)) return;
      if(pMax!=null && (price==null || price > pMax)) return;
      if(imeiIccid && !anyContains(x, imeiIccid)) return;
      if(!anyContains(x, q)) return;

      const a = anagByCF(cfKey);
      rows.push({
        tipo:"DEVICE",
        date,
        cf: cfKey,
        cliente: clienteNome(cfKey),
        contatto: contattoStr(cfKey),
        citta: a?.citta || "",
        descr: `${upper(x.modello||"")}`,
        extra: `IMEI: ${upper(x.imei||"")} | ‚Ç¨ ${price!=null ? price : ""} | VEND: ${upper(x.venditore||"")} | PAY: ${upper(x.pagamento||"")}`,
        _sumDev: price||0,_sumRip:0
      });
    });
  }

  if(!tipo || tipo==="RIPARAZIONE"){
    riparazioni.forEach(x=>{
      const date = toDateISO(x.data_ingresso);
      const cfKey = upper(x.cf);
      if(!passAnag(cfKey)) return;
      if(statoRip && !upper(x.stato||"").includes(statoRip)) return;
      if(from || to){ if(!withinRange(date, from, to)) return; }
      if(!anyContains(x, q)) return;

      const cost = toNum(x.costo);
      const a = anagByCF(cfKey);
      rows.push({
        tipo:"RIPARAZIONE",
        date,
        cf: cfKey,
        cliente: clienteNome(cfKey),
        contatto: contattoStr(cfKey),
        citta: a?.citta || "",
        descr: `${upper(x.modello||"")} ‚Ä¢ ${upper(x.problema||"")}`,
        extra: `STATO: ${upper(x.stato||"")} | ‚Ç¨ ${cost!=null ? cost : ""} | IMEI: ${upper(x.imei||"")}`,
        _sumDev:0,_sumRip: cost||0
      });
    });
  }

  rows.sort((a,b)=>(b.date||"").localeCompare(a.date||""));
  reportRows = rows;

  qs("#tblReport tbody").innerHTML = rows.map(r=>{
    const badgeCls = r.tipo==="CONTRATTO" ? "" : (r.tipo==="DEVICE" ? "good" : "warn");
    return `<tr>
      <td><span class="badge ${badgeCls}">${r.tipo}</span></td>
      <td>${r.date||""}</td>
      <td class="mono">${r.cf}</td>
      <td>${r.cliente||""}</td>
      <td>${r.contatto||""}</td>
      <td>${r.citta||""}</td>
      <td>${r.descr||""}</td>
      <td>${r.extra||""}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="8" class="muted">Nessun risultato.</td></tr>`;

  const sumDev = rows.reduce((s,r)=>s+(r._sumDev||0),0);
  const sumRip = rows.reduce((s,r)=>s+(r._sumRip||0),0);
  setText("rep_total", rows.length);
  setText("rep_sum_dev", moneyFmt(sumDev));
  setText("rep_sum_rip", moneyFmt(sumRip));

  lastReportTypeCounts = {
    CONTRATTO: rows.filter(r=>r.tipo==="CONTRATTO").length,
    DEVICE: rows.filter(r=>r.tipo==="DEVICE").length,
    RIPARAZIONE: rows.filter(r=>r.tipo==="RIPARAZIONE").length
  };

  const ctx = qs("#chartReportTypes").getContext("2d");
  qs("#chartReportTypes").width = qs("#chartReportTypes").clientWidth * devicePixelRatio;
  qs("#chartReportTypes").height = qs("#chartReportTypes").clientHeight * devicePixelRatio;
  drawBarChart(ctx, qs("#chartReportTypes").width, qs("#chartReportTypes").height, [
    {label:"CONTR", value:lastReportTypeCounts.CONTRATTO},
    {label:"DEV", value:lastReportTypeCounts.DEVICE},
    {label:"RIP", value:lastReportTypeCounts.RIPARAZIONE},
  ], "");

  setText("dbg", `Report: ${rows.length} righe ‚Ä¢ Dev‚Ç¨=${sumDev} ‚Ä¢ Rip‚Ç¨=${sumRip}`);
  toast("Report aggiornato ‚úÖ");
}
function resetReport(){
  ["f_tipo","f_cf","f_nome","f_contatto","f_citta","f_compagnia","f_offerta","f_tecnologia","f_tipo_attivazione","f_convergenza","f_mnp",
   "f_imei_iccid","f_stato_rip","f_venditore","f_query","f_from","f_to","f_price_min","f_price_max"]
    .forEach(id=>qs("#"+id).value="");
  reportRows = [];
  qs("#tblReport tbody").innerHTML = "";
  setText("rep_total","0"); setText("rep_sum_dev","0"); setText("rep_sum_rip","0");
  setText("dbg","‚Äî");
  const c = qs("#chartReportTypes").getContext("2d");
  c.clearRect(0,0, qs("#chartReportTypes").width, qs("#chartReportTypes").height);
  toast("Filtri resettati");
}


/* =========================
   COMPLEANNI
========================= */
function parseBirthFromCF(cf){
  const x = upper(cf||"");
  if(x.length < 11) return null;
  // AA M GG (pos 6-10 0-index 6? In realt√†: 6=Y1? CF: 0-5 lettere, 6-7 anno, 8 mese, 9-10 giorno)
  const yy = parseInt(x.slice(6,8),10);
  const mL = x.slice(8,9);
  const ddRaw = parseInt(x.slice(9,11),10);
  if(Number.isNaN(yy) || Number.isNaN(ddRaw)) return null;
  const months = {A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
  const mm = months[mL] || null;
  if(!mm) return null;
  const dd = ddRaw>40 ? (ddRaw-40) : ddRaw;
  if(dd<1 || dd>31) return null;

  const now = new Date();
  const curYY = now.getFullYear()%100;
  const fullY = (yy <= curYY) ? (2000+yy) : (1900+yy);
  const d = new Date(fullY, mm-1, dd);
  if(Number.isNaN(d.getTime())) return null;
  return d;
}

function birthDateForClient(a){
  if(a?.data_nascita){
    const d = new Date(a.data_nascita);
    if(!Number.isNaN(d.getTime())) return d;
  }
  return parseBirthFromCF(a?.cf);
}

function nextBirthday(birth, fromDate){
  const f = fromDate || new Date();
  const year = f.getFullYear();
  const mm = birth.getMonth();
  const dd = birth.getDate();
  let next = new Date(year, mm, dd);
  // se gi√† passato quest'anno, anno prossimo
  const start = new Date(year, f.getMonth(), f.getDate());
  if(next < start) next = new Date(year+1, mm, dd);
  return next;
}

function daysBetween(a,b){
  const ms = 24*60*60*1000;
  const aa = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
  const bb = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
  return Math.round((bb-aa)/ms);
}

function runBirthdays(){
  const month = parseInt(qs("#b_month").value || "0",10);
  const days = parseInt(qs("#b_days").value || "30",10);
  const today = new Date();

  let rows = anagrafica
    .map(a=>{
      const birth = birthDateForClient(a);
      if(!birth) return null;
      const next = nextBirthday(birth, today);
      const dleft = daysBetween(today, next);
      return {a, birth, next, dleft};
    })
    .filter(Boolean);

  if(month){
    rows = rows.filter(r => (r.next.getMonth()+1)===month);
  }
  if(days && !Number.isNaN(days)){
    rows = rows.filter(r => r.dleft>=0 && r.dleft<=days);
  }

  rows.sort((x,y)=>x.dleft-y.dleft);

  qs("#b_summary").innerHTML = `<b>${rows.length}</b> compleanni trovati` + (month?` ‚Ä¢ mese ${month}`:"") + (days?` ‚Ä¢ prossimi ${days} giorni`:"");
  qs("#tblBirthdays tbody").innerHTML = rows.map(r=>{
    const phone = r.a.telefono || "";
    return `<tr>
      <td>${toDateISO(r.next)}</td>
      <td>${r.dleft}</td>
      <td class="mono">${r.a.cf}</td>
      <td>${(r.a.nome||"")+" "+(r.a.cognome||"")}</td>
      <td>${toDateISO(r.birth)}</td>
      <td>${phone}</td>
      <td>${phone ? `<a class="btn secondary small" href="${waLink(phone)}" target="_blank" rel="noopener" style="text-decoration:none">üí¨</a>` : "‚Äî"}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="7" class="muted">Nessun compleanno nel filtro.</td></tr>`;

  // salva per export
  window.__birthRows = rows.map(r=>({
    prossimo: toDateISO(r.next),
    giorni: r.dleft,
    cf: r.a.cf,
    nome: r.a.nome||"",
    cognome: r.a.cognome||"",
    data_nascita: toDateISO(r.birth),
    telefono: r.a.telefono||"",
    email: r.a.email||"",
    citta: r.a.citta||""
  }));
}

function exportBirthdaysCSV(){
  const rows = window.__birthRows || [];
  const headers = ["prossimo","giorni","cf","nome","cognome","data_nascita","telefono","email","citta"];
  downloadCSV(`compleanni_${todayISO()}.csv`, headers, rows);
}


/* =========================
   WHATSAPP TEMPLATE (eventi + scadenze)
========================= */
function clientFirstName(cf){
  const a = anagByCF(cf);
  const full = ((a?.nome||"") + " " + (a?.cognome||"")).trim();
  const first = (a?.nome||"").trim() || (full.split(" ")[0]||"");
  return first;
}
function buildWaMessageForEvent(cf, ev){
  const name = clientFirstName(cf);
  const hi = name ? `Ciao ${name}, ` : "Ciao, ";
  if(ev.type==="CONTRATTO"){
    return hi + `ti invio un riepilogo del contratto ${ev.title} del ${ev.date}. Se vuoi, posso aiutarti con dettagli, assistenza o upgrade.`;
  }
  if(ev.type==="DEVICE"){
    return hi + `grazie per l'acquisto: ${ev.title} (${ev.date}). Se ti serve supporto o accessori, sono qui.`;
  }
  if(ev.type==="RIPARAZIONE"){
    return hi + `aggiornamento riparazione: ${ev.title} (${ev.date}). Se vuoi, ti dico tempi/costi e stato lavorazione.`;
  }
  return hi + "come posso aiutarti?";
}
function buildWaMessageForDeadline(row){
  const name = clientFirstName(row.cf);
  const hi = name ? `Ciao ${name}, ` : "Ciao, ";
  const when = row.scadenza ? `il ${row.scadenza}` : "a breve";
  const what = row.tipo==="OFFERTA" ? "il vincolo dell'offerta" : "il vincolo del telefono";
  const offer = row.offerta ? ` "${row.offerta}"` : "";
  const carrier = row.compagnia ? ` con ${row.compagnia}` : "";
  return hi + `ti avviso che ${what}${offer}${carrier} scade ${when}. Vuoi che ti proponga un rinnovo/upgrade migliore?`;
}

/* =========================
   SCADENZE / RINNOVI (report)
========================= */
function parseISODateOrNull(s){
  const x = (s||"").toString().trim();
  if(!x) return null;
  const d = new Date(x);
  if(Number.isNaN(d.getTime())) return null;
  return d;
}
function runScadenze(){
  const days = parseInt(qs("#s_days").value || "60",10);
  const tipo = (qs("#s_tipo").value || "").trim(); // OFFERTA / TELEFONO / ""
  const today = new Date();
  const limit = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (Number.isNaN(days)?60:days));

  const out = [];
  contratti.forEach(c=>{
    const cf = upper(c.cf);
    if(!cf) return;

    const dOff = parseISODateOrNull(c.data_fine_vincolo_offerta);
    const dTel = parseISODateOrNull(c.data_fine_vincolo_telefono);

    if(dOff && (!tipo || tipo==="OFFERTA")){
      const left = daysBetween(today, dOff);
      if(left>=0 && dOff<=limit){
        out.push({
          scadenza: toDateISO(dOff),
          tipo: "OFFERTA",
          giorni: left,
          cf,
          cliente: clienteNome(cf),
          numero: (c.numero_lavorato||""),
          compagnia: upper(c.compagnia||""),
          offerta: upper(c.nome_offerta||""),
          telefono: contattoPhone(cf)
        });
      }
    }
    if(dTel && (!tipo || tipo==="TELEFONO")){
      const left = daysBetween(today, dTel);
      if(left>=0 && dTel<=limit){
        out.push({
          scadenza: toDateISO(dTel),
          tipo: "TELEFONO",
          giorni: left,
          cf,
          cliente: clienteNome(cf),
          numero: (c.numero_lavorato||""),
          compagnia: upper(c.compagnia||""),
          offerta: upper(c.nome_offerta||""),
          telefono: contattoPhone(cf)
        });
      }
    }
  });

  out.sort((a,b)=>a.giorni-b.giorni);

  qs("#s_summary").innerHTML = `<b>${out.length}</b> scadenze trovate ‚Ä¢ prossimi ${Number.isNaN(days)?60:days} giorni` + (tipo?` ‚Ä¢ ${tipo}`:"");
  qs("#tblScadenze tbody").innerHTML = out.map(r=>{
    const phone = r.telefono || "";
    const msg = buildWaMessageForDeadline(r);
    return `<tr>
      <td>${r.scadenza}</td>
      <td><span class="badge ${r.giorni<=7?'bad':(r.giorni<=15?'warn':'good')}">${r.tipo}</span></td>
      <td>${r.giorni}</td>
      <td class="mono">${r.cf}</td>
      <td>${r.cliente||""}</td>
      <td>${r.numero||""}</td>
      <td>${r.compagnia||""}</td>
      <td>${r.offerta||""}</td>
      <td>${phone ? `<a class="btn secondary small" href="${waLinkText(phone, msg)}" target="_blank" rel="noopener" style="text-decoration:none">üí¨</a>` : "‚Äî"}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="10" class="muted">Nessuna scadenza nel filtro.</td></tr>`;

  window.__scadRows = out;
}

function exportScadenzeCSV(){
  const rows = window.__scadRows || [];
  const headers = ["scadenza","tipo","giorni","cf","cliente","numero","compagnia","offerta","telefono"];
  downloadCSV(`scadenze_${todayISO()}.csv`, headers, rows);
}

// telefono principale per CF (anagrafica > telefono)
function contattoPhone(cf){
  const a = anagByCF(cf);
  return (a?.telefono||"").toString().trim();
}

/* =========================
   TIMELINE
========================= */
function loadTimeline(){
  const cf = upper(qs("#t_cf").value);
  if(!cf){ toast("Inserisci un CF"); return; }

  qs("#timelineHeader").textContent = `Cliente: ${clienteNome(cf) || "(non in anagrafica)"} ‚Ä¢ CF: ${cf} ‚Ä¢ Contatto: ${contattoStr(cf) || "‚Äî"}`;
  const box = qs("#timelineBox");
  const evs = [];

  contratti.forEach(x=>{
    if(upper(x.cf) !== cf) return;
    evs.push({
      type:"CONTRATTO",
      date: toDateISO(x.data_contratto || x.data),
      title:`${upper(x.compagnia||"")} ‚Äî ${upper(x.nome_offerta||"")}`,
      desc:`ATT: ${upper(x.tipo_attivazione||"")} ‚Ä¢ TEC: ${upper(x.tecnologia||"")} ‚Ä¢ MNP: ${upper(x.mnp||"")} ‚Ä¢ NUM: ${(x.numero_lavorato||"")} ‚Ä¢ ICCID: ${upper(x.iccid_nuovo||"")}`
    });
  });
  device.forEach(x=>{
    if(upper(x.cf) !== cf) return;
    evs.push({ type:"DEVICE", date: toDateISO(x.data), title:`Vendita: ${upper(x.modello||"")}`, desc:`IMEI: ${upper(x.imei||"")} ‚Ä¢ ‚Ç¨ ${toNum(x.prezzo) ?? ""} ‚Ä¢ VEND: ${upper(x.venditore||"")}` });
  });
  riparazioni.forEach(x=>{
    if(upper(x.cf) !== cf) return;
    evs.push({ type:"RIPARAZIONE", date: toDateISO(x.data_ingresso), title:`Riparazione: ${upper(x.modello||"")} (${upper(x.stato||"")})`, desc:`PROBLEMA: ${upper(x.problema||"")} ‚Ä¢ ‚Ç¨ ${toNum(x.costo) ?? ""} ‚Ä¢ IMEI: ${upper(x.imei||"")}` });
  });

  evs.sort((a,b)=>(b.date||"").localeCompare(a.date||""));
  const phone = anagByCF(cf)?.telefono || "";
  box.innerHTML = evs.map(ev=>{
    const cls = ev.type==="DEVICE" ? "good" : (ev.type==="RIPARAZIONE" ? "warn" : "");
    const msg = buildWaMessageForEvent(cf, ev);
    const waBtn = phone ? `<a class="btn secondary small" href="${waLinkText(phone, msg)}" target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin-left:8px">üí¨ WhatsApp</a>` : ``;
    return `<div class="tItem">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div><span class="badge ${cls}">${ev.type}</span> <span class="tTitle">${ev.title}</span></div>
        <div>${waBtn}</div>
      </div>
      <div class="tMeta">${ev.date || ""} ‚Ä¢ ${ev.desc || ""}</div>
    </div>`;
  }).join("") || `<div class="muted">Nessun evento.</div>`;
}


/* =========================
   Scheda Cliente (azioni rapide + liste)
========================= */
let currentClientCF = "";

function openTimeline(cf){
  const x = upper(cf||"");
  if(!x){ toast("Inserisci un CF"); return; }
  qs("#t_cf").value = x;
  // vai alla vista timeline
  qsa("[data-view]").forEach(b=>b.classList.remove("active"));
  qsa(".view").forEach(v=>v.classList.remove("active"));
  qs('[data-view="timeline"]').classList.add("active");
  qs("#view-timeline").classList.add("active");
  pageTitle.textContent = "Timeline Cliente";
  loadTimeline();
  setTimeout(()=>qs("#timelineHeader").scrollIntoView({behavior:"smooth",block:"start"}), 50);
}

function openClientSheet(cf){
  currentClientCF = upper(cf || qs("#cs_search_cf").value);
  if(!currentClientCF){ toast("Inserisci un CF"); return; }
  qs("#cs_search_cf").value = currentClientCF;

  const a = anagByCF(currentClientCF);
  const sum = qs("#cs_summary");
  const wa = qs("#cs_whatsapp");
  const btnTL = qs("#btnClientGoTimeline");

  if(a){
    sum.innerHTML = `<b>${clienteNome(currentClientCF)}</b> ‚Ä¢ CF: <span class="mono">${currentClientCF}</span> ‚Ä¢ ${contattoStr(currentClientCF) || ""} ‚Ä¢ ${a.citta || ""}`;
    if(a.telefono){
      wa.href = waLink(a.telefono);
      wa.style.display = "inline-flex";
    }else{
      wa.style.display = "none";
    }
    btnTL.style.display = "inline-flex";
  }else{
    sum.innerHTML = `Cliente non trovato per CF: <span class="mono">${currentClientCF}</span> (crealo in Anagrafica)`;
    wa.style.display="none";
    btnTL.style.display="none";
  }

  // default date
  qs("#cs_c_data").value = todayISO();
  qs("#cs_d_data").value = todayISO();
  qs("#cs_r_data").value = todayISO();

  renderClientLists();

  // porta l'utente nella vista Anagrafica e scrolla la scheda
  qsa("[data-view]").forEach(x=>x.classList.remove("active"));
  qsa(".view").forEach(v=>v.classList.remove("active"));
  qs('[data-view="anagrafica"]').classList.add("active");
  qs("#view-anagrafica").classList.add("active");
  pageTitle.textContent = "Anagrafica (CRUD)";
  setTimeout(()=>qs("#clientSheetCard").scrollIntoView({behavior:"smooth",block:"start"}), 50);
}

function renderClientLists(){
  const cf = currentClientCF;
  if(!cf){
    qs("#cs_tbl_con tbody").innerHTML = `<tr><td colspan="4" class="muted">Seleziona un cliente.</td></tr>`;
    qs("#cs_tbl_dev tbody").innerHTML = `<tr><td colspan="4" class="muted">Seleziona un cliente.</td></tr>`;
    qs("#cs_tbl_rip tbody").innerHTML = `<tr><td colspan="4" class="muted">Seleziona un cliente.</td></tr>`;
    return;
  }

  const con = contratti.filter(x=>upper(x.cf)===cf).slice().sort((a,b)=>(toDateISO(b.data_contratto||b.data)||"").localeCompare(toDateISO(a.data_contratto||a.data)||"")).slice(0,8);
  const dev = device.filter(x=>upper(x.cf)===cf).slice().sort((a,b)=>(toDateISO(b.data)||"").localeCompare(toDateISO(a.data)||"")).slice(0,8);
  const rip = riparazioni.filter(x=>upper(x.cf)===cf).slice().sort((a,b)=>(toDateISO(b.data_ingresso)||"").localeCompare(toDateISO(a.data_ingresso)||"")).slice(0,8);

  qs("#cs_tbl_con tbody").innerHTML = con.map(x=>`
    <tr><td>${toDateISO(x.data_contratto||x.data)}</td><td>${x.compagnia||""}</td><td>${x.nome_offerta||x.offerta||""}</td><td>${x.mnp||""}</td></tr>
  `).join("") || `<tr><td colspan="4" class="muted">Nessun contratto.</td></tr>`;

  qs("#cs_tbl_dev tbody").innerHTML = dev.map(x=>`
    <tr><td>${toDateISO(x.data)}</td><td>${x.modello||""}</td><td class="mono">${x.imei||""}</td><td>${toNum(x.prezzo)!=null?moneyFmt(toNum(x.prezzo)):"‚Äî"}</td></tr>
  `).join("") || `<tr><td colspan="4" class="muted">Nessun device.</td></tr>`;

  qs("#cs_tbl_rip tbody").innerHTML = rip.map(x=>`
    <tr><td>${toDateISO(x.data_ingresso)}</td><td>${x.modello||""}</td><td>${x.stato||""}</td><td>${toNum(x.costo)!=null?moneyFmt(toNum(x.costo)):"‚Äî"}</td></tr>
  `).join("") || `<tr><td colspan="4" class="muted">Nessuna riparazione.</td></tr>`;
}

function csSaveCon(){
  const cf = currentClientCF;
  if(!cf){ toast("Seleziona un cliente"); return; }
  if(!mustHaveFK(cf)){ toast("Cliente non presente in Anagrafica"); return; }

  const rec = {
    id: (qs("#cs_c_id").value||"").trim() || safeId("C"),
    id_cliente: "",
    cf,
    data_contratto: qs("#cs_c_data").value || todayISO(),
    tipo_cliente: anagByCF(cf)?.tipo || "",
    tipo_attivazione: "",
    tecnologia: "",
    convergenza: "",
    mnp: upper(qs("#cs_c_mnp").value),
    data_attivazione: "",
    data_portabilita: "",
    numero_lavorato: (qs("#cs_c_numero").value||"").trim(),
    nome_offerta: upper(qs("#cs_c_offerta").value),
    costo_offerta: "",
    vincolo_offerta_mesi: "",
    telefono_incluso: "",
    imei: "",
    modello: "",
    tipo_pagamento: "",
    mesi_vincolo_telefono: "",
    data_fine_vincolo_offerta: "",
    data_fine_vincolo_telefono: "",
    compagnia: upper(qs("#cs_c_compagnia").value),
    iccid_vecchio: "",
    iccid_nuovo: "",
    created_at: "",
    updated_at: ""
  };

  contratti.push(rec);
  saveStore();
  syncValueSettingsUI();
  bindValueSettings();
  bindCampaignUI();
  renderCampaignSelect();
  refreshAll();
  // Dopo refresh, rigenera suggerimenti per avere score aggiornati
  try{ buildSmartSuggestions(); renderCampaignSelect(); }catch(e){}
  renderClientLists();
  toast("Contratto salvato dalla scheda ‚úÖ");
  qs("#cs_c_id").value="";
  qs("#cs_c_compagnia").value="";
  qs("#cs_c_offerta").value="";
  qs("#cs_c_numero").value="";
  qs("#cs_c_mnp").value="";
}

function csSaveDev(){
  const cf = currentClientCF;
  if(!cf){ toast("Seleziona un cliente"); return; }
  if(!mustHaveFK(cf)){ toast("Cliente non presente in Anagrafica"); return; }

  const modello = upper(qs("#cs_d_modello").value);
  if(!modello){ toast("Modello obbligatorio"); return; }

  const rec = {
    id: (qs("#cs_d_id").value||"").trim() || safeId("D"),
    cf,
    data: qs("#cs_d_data").value || todayISO(),
    modello,
    imei: upper(qs("#cs_d_imei").value),
    prezzo: (qs("#cs_d_prezzo").value||"").trim(),
    venditore: upper(qs("#cs_d_venditore").value),
    pagamento: ""
  };
  device.push(rec);
  saveStore(); refreshAll(); renderClientLists();
  toast("Device salvato dalla scheda ‚úÖ");
  ["cs_d_id","cs_d_modello","cs_d_imei","cs_d_prezzo","cs_d_venditore"].forEach(id=>qs("#"+id).value="");
}

function csSaveRip(){
  const cf = currentClientCF;
  if(!cf){ toast("Seleziona un cliente"); return; }
  if(!mustHaveFK(cf)){ toast("Cliente non presente in Anagrafica"); return; }

  const modello = upper(qs("#cs_r_modello").value);
  if(!modello){ toast("Modello obbligatorio"); return; }

  const rec = {
    id: (qs("#cs_r_id").value||"").trim() || safeId("R"),
    cf,
    data_ingresso: qs("#cs_r_data").value || todayISO(),
    modello,
    imei: upper(qs("#cs_r_imei").value),
    problema: upper(qs("#cs_r_problema").value),
    stato: upper(qs("#cs_r_stato").value),
    costo: (qs("#cs_r_costo").value||"").trim()
  };
  riparazioni.push(rec);
  saveStore(); refreshAll(); renderClientLists();
  toast("Riparazione salvata dalla scheda ‚úÖ");
  ["cs_r_id","cs_r_modello","cs_r_imei","cs_r_problema","cs_r_stato","cs_r_costo"].forEach(id=>qs("#"+id).value="");
}

function csOpenFull(section){
  // prefill CF sul modulo completo e apri la vista
  if(!currentClientCF){ toast("Seleziona un cliente"); return; }
  if(section==="contratti"){
    qsa("[data-view]").forEach(x=>x.classList.remove("active"));
    qsa(".view").forEach(v=>v.classList.remove("active"));
    qs('[data-view="contratti"]').classList.add("active");
    qs("#view-contratti").classList.add("active");
    pageTitle.textContent = "Contratti (CRUD)";
    qs("#c_cf").value = currentClientCF;
    conFindClient();
    setTimeout(()=>qs("#c_cf").scrollIntoView({behavior:"smooth",block:"center"}), 50);
  }
  if(section==="device"){
    qsa("[data-view]").forEach(x=>x.classList.remove("active"));
    qsa(".view").forEach(v=>v.classList.remove("active"));
    qs('[data-view="device"]').classList.add("active");
    qs("#view-device").classList.add("active");
    pageTitle.textContent = "Device (CRUD)";
    qs("#d_cf").value = currentClientCF;
    setTimeout(()=>qs("#d_modello").focus(), 50);
  }
  if(section==="riparazioni"){
    qsa("[data-view]").forEach(x=>x.classList.remove("active"));
    qsa(".view").forEach(v=>v.classList.remove("active"));
    qs('[data-view="riparazioni"]').classList.add("active");
    qs("#view-riparazioni").classList.add("active");
    pageTitle.textContent = "Riparazioni (CRUD)";
    qs("#r_cf").value = currentClientCF;
    setTimeout(()=>qs("#r_modello").focus(), 50);
  }
}

/* =========================
   CHART DATA + DRAW
========================= */
function dateRangeLabels(days=30){
  const out = [];
  const d = new Date();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate()-(days-1));
  for(let i=0;i<days;i++){
    out.push(d.toISOString().slice(0,10));
    d.setDate(d.getDate()+1);
  }
  return out;
}
function countByDay(labels, items, dateField){
  const map = new Map(labels.map(l=>[l,0]));
  items.forEach(it=>{
    const d = toDateISO(it[dateField]);
    if(map.has(d)) map.set(d, map.get(d)+1);
  });
  return labels.map(l=>map.get(l)||0);
}
function topCounts(items, keyFn, limit=8){
  const m = new Map();
  items.forEach(it=>{
    const k = upper(keyFn(it) || "‚Äî");
    m.set(k, (m.get(k)||0)+1);
  });
  const arr = [...m.entries()].map(([label,value])=>({label,value}));
  arr.sort((a,b)=>b.value-a.value);
  return arr.slice(0,limit);
}
function drawAllCharts(){
  const { con30, dev30, rip30 } = compute30();

  // 1) Torta attivit√† 30gg per tipo
  const activities = [
    { label: "Contratti", value: con30.length },
    { label: "Device", value: dev30.length },
    { label: "Riparazioni", value: rip30.length }
  ];
  {
    const c = qs("#chartDaily");
    if(c){
      const ctx = c.getContext("2d");
      c.width = c.clientWidth * devicePixelRatio;
      c.height = c.clientHeight * devicePixelRatio;
      drawPieChart(ctx, c.width, c.height, activities, "Attivit√† 30 giorni");
    }
  }

  // 2) Torta top venditori (contratti + device ultimi 30gg)
  const sellers = topCounts([...con30, ...dev30], it => it.venditore || "SENZA VENDITORE", 8);
  {
    const c = qs("#chartSellers");
    if(c){
      const ctx = c.getContext("2d");
      c.width = c.clientWidth * devicePixelRatio;
      c.height = c.clientHeight * devicePixelRatio;
      drawPieChart(ctx, c.width, c.height, sellers, "Venditori 30 giorni");
    }
  }

  // 3) Torta contratti per compagnia (ultimi 30gg)
  const companies = topCounts(con30, it => it.compagnia || "SENZA COMPAGNIA", 8);
  {
    const c = qs("#chartCompanies");
    if(c){
      const ctx = c.getContext("2d");
      c.width = c.clientWidth * devicePixelRatio;
      c.height = c.clientHeight * devicePixelRatio;
      drawPieChart(ctx, c.width, c.height, companies, "Compagnie 30 giorni");
    }
  }
}

/* =========================
   IMPORT CSV (SMART)
========================= */
function importAnagFromRows(rows){
  let ok=0, skip=0;
  rows.forEach(r=>{
    const m = mapRowSmart(r, SCHEMA_ANAG);
    const cf = upper(m.cf);
    const nome = upper(m.nome);
    const cognome = upper(m.cognome);
    if(!cf || !nome || !cognome){ skip++; return; }
    const rec = {
      cf, nome, cognome,
      tipo: upper(m.tipo || ""),
      telefono: (m.telefono || "").trim(),
      email: (m.email || "").trim(),
      citta: upper(m.citta || ""),
      indirizzo: upper(m.indirizzo || ""),
      data_nascita: toDateISO(m.data_nascita) || ""
    };
    const idx = anagrafica.findIndex(x=>upper(x.cf)===cf);
    if(idx>=0) anagrafica[idx]=rec; else anagrafica.push(rec);
    ok++;
  });
  return {ok, skip};
}
function importConFromRows(rows){
  let ok=0, skip=0, fk=0;
  rows.forEach(r=>{
    const m = mapRowSmart(r, SCHEMA_CON);
    const cf = upper(m.cf);
    if(!cf){ skip++; return; }
    if(!mustHaveFK(cf)){ fk++; return; }

    const rec = {
      id: (m.id || "").trim() || safeId("C"),
      id_cliente: upper(m.id_cliente || ""),
      cf,
      data_contratto: toDateISO(m.data_contratto) || todayISO(),
      tipo_cliente: upper(m.tipo_cliente || ""),
      tipo_attivazione: upper(m.tipo_attivazione || ""),
      tecnologia: upper(m.tecnologia || ""),
      convergenza: upper(m.convergenza || ""),
      mnp: upper(m.mnp || ""),
      data_attivazione: toDateISO(m.data_attivazione) || "",
      data_portabilita: toDateISO(m.data_portabilita) || "",
      numero_lavorato: (m.numero_lavorato || "").trim(),
      nome_offerta: upper(m.nome_offerta || ""),
      costo_offerta: (m.costo_offerta || "").toString().replace(",",".").trim(),
      vincolo_offerta_mesi: (m.vincolo_offerta_mesi || "").toString().trim(),
      telefono_incluso: upper(m.telefono_incluso || ""),
      imei: upper(m.imei || ""),
      modello: upper(m.modello || ""),
      tipo_pagamento: upper(m.tipo_pagamento || ""),
      mesi_vincolo_telefono: (m.mesi_vincolo_telefono || "").toString().trim(),
      data_fine_vincolo_offerta: toDateISO(m.data_fine_vincolo_offerta) || "",
      data_fine_vincolo_telefono: toDateISO(m.data_fine_vincolo_telefono) || "",
      compagnia: upper(m.compagnia || ""),
      iccid_vecchio: upper(m.iccid_vecchio || ""),
      iccid_nuovo: upper(m.iccid_nuovo || ""),
      created_at: (m.created_at || "").trim(),
      updated_at: (m.updated_at || "").trim()
    };

    const idx = contratti.findIndex(x=>x.id===rec.id);
    if(idx>=0) contratti[idx]=rec; else contratti.push(rec);
    ok++;
  });
  return {ok, skip, fk};
}
function importDevFromRows(rows){
  let ok=0, skip=0, fk=0;
  rows.forEach(r=>{
    const m = mapRowSmart(r, SCHEMA_DEV);
    const cf = upper(m.cf);
    const modello = upper(m.modello);
    if(!cf || !modello){ skip++; return; }
    if(!mustHaveFK(cf)){ fk++; return; }
    const rec = {
      id: (m.id || "").trim() || safeId("D"),
      cf,
      data: toDateISO(m.data) || todayISO(),
      modello,
      imei: upper(m.imei || ""),
      prezzo: (m.prezzo || "").trim(),
      venditore: upper(m.venditore || ""),
      pagamento: upper(m.pagamento || "")
    };
    const idx = device.findIndex(x=>x.id===rec.id);
    if(idx>=0) device[idx]=rec; else device.push(rec);
    ok++;
  });
  return {ok, skip, fk};
}
function importRipFromRows(rows){
  let ok=0, skip=0, fk=0;
  rows.forEach(r=>{
    const m = mapRowSmart(r, SCHEMA_RIP);
    const cf = upper(m.cf);
    const modello = upper(m.modello);
    if(!cf || !modello){ skip++; return; }
    if(!mustHaveFK(cf)){ fk++; return; }
    const rec = {
      id: (m.id || "").trim() || safeId("R"),
      cf,
      data_ingresso: toDateISO(m.data_ingresso) || todayISO(),
      modello,
      imei: upper(m.imei || ""),
      problema: upper(m.problema || ""),
      stato: upper(m.stato || ""),
      costo: (m.costo || "").trim()
    };
    const idx = riparazioni.findIndex(x=>x.id===rec.id);
    if(idx>=0) riparazioni[idx]=rec; else riparazioni.push(rec);
    ok++;
  });
  return {ok, skip, fk};
}

/* =========================
   PDF Export (stampa)
========================= */
function canvasToImgDataUrl(id){
  const c = qs("#"+id);
  if(!c) return "";
  try{ return c.toDataURL("image/png"); }catch(e){ return ""; }
}
function buildTableHTML(headers, rows){
  const th = headers.map(h=>`<th>${h}</th>`).join("");
  const tb = rows.map(r=>{
    const tds = headers.map(h=>`<td>${(r[h]??"")}</td>`).join("");
    return `<tr>${tds}</tr>`;
  }).join("");
  return `<table><thead><tr>${th}</tr></thead><tbody>${tb || `<tr><td colspan="${headers.length}">Nessun dato</td></tr>`}</tbody></table>`;
}

/* =========================
   SMART REPORT: suggerimenti ricontatto
========================= */
let smartRows = [];

function daysBetweenISO(aISO, bISO){
  if(!aISO || !bISO) return null;
  const a = new Date(aISO);
  const b = new Date(bISO);
  if(isNaN(a) || isNaN(b)) return null;
  return Math.floor((b - a) / (1000*60*60*24));
}
function maxDateISO(arr){
  const clean = (arr||[]).filter(Boolean).map(toDateISO).filter(Boolean);
  if(!clean.length) return "";
  clean.sort();
  return clean[clean.length-1];
}
function minDateISO(arr){
  const clean = (arr||[]).filter(Boolean).map(toDateISO).filter(Boolean);
  if(!clean.length) return "";
  clean.sort();
  return clean[0];
}
function sumBy(arr, fn){
  return (arr||[]).reduce((s,x)=>s+(toNum(fn(x))||0),0);
}

function buildSmartSuggestions(){
  const inactiveMin = Math.max(0, parseInt(qs("#smartInactiveDays")?.value || "90",10));
  const nextDays = Math.max(1, parseInt(qs("#smartNextDays")?.value || "30",10));
  const segFilter = upper(qs("#smartSeg")?.value || "");
  const today = todayISO();
  const valSet = loadValueSettings();
  const monthsVal = Math.max(1, parseInt(valSet.months,10));
  const mDev = (Number(valSet.marginDevPct)||0)/100;
  const mRip = (Number(valSet.marginRipPct)||0)/100;

  const byCF = (list, cf) => list.filter(x => upper(x.cf) === cf);

  const rows = [];

  anagrafica.forEach(a=>{
    const cf = upper(a.cf);
    const cons = byCF(contratti, cf);
    const devs = byCF(device, cf);
    const rips = byCF(riparazioni, cf);

    const conDates = cons.map(c=>toDateISO(c.data_contratto || c.data));
    const devDates = devs.map(d=>toDateISO(d.data));
    const ripDates = rips.map(r=>toDateISO(r.data_ingresso));

    const last = maxDateISO([...conDates, ...devDates, ...ripDates]);
    const first = minDateISO([...conDates, ...devDates, ...ripDates]);
    if(!last) return; // nessuna attivit√†

    const daysSince = daysBetweenISO(last, today);
    const tenureDays = first ? (daysBetweenISO(first, today) ?? 0) : 0;

    // spesa stimata
    const spendDev = sumBy(devs, d=>d.prezzo);
    const spendRip = sumBy(rips, r=>r.costo);
    const spend = spendDev + spendRip;
    // valore cliente (stima)
    const mrr = cons.reduce((s,c)=> s + (toNum(c.costo_offerta ?? c.costo ?? 0) || 0), 0);
    const valueContracts = mrr * monthsVal;
    const valueMargins = (spendDev * mDev) + (spendRip * mRip);
    const valueEst = valueContracts + valueMargins;


    // ‚Äúloyalty‚Äù
    const nCon = cons.length, nDev = devs.length, nRip = rips.length;
    const loyalty = (nCon*3) + (nDev*2) + (nRip*1) + (tenureDays>180 ? 2 : 0) + (spend>=500 ? 2 : 0);

    // MNP
    const mnpYes = cons.some(c => upper(c.mnp||"") === "SI");
    const lastCon = maxDateISO(conDates);

    // Scadenze: pi√π vicina tra fine vincolo offerta/telefono
    const scads = [];
    cons.forEach(c=>{
      const d1 = toDateISO(c.data_fine_vincolo_offerta);
      const d2 = toDateISO(c.data_fine_vincolo_telefono);
      if(d1) scads.push({type:"OFFERTA", date:d1});
      if(d2) scads.push({type:"TELEFONO", date:d2});
    });
    const upcoming = scads
      .filter(s => s.date >= today && (daysBetweenISO(today, s.date) ?? 999999) <= nextDays)
      .sort((x,y)=>x.date.localeCompare(y.date))[0];

    // Priorit√†: RINNOVO > WINBACK > VIP > UPSELL
    let segment = "";
    let reason = "";
    let proposal = "";
    let score = 0;
    let msg = "";

    const nome = (a.nome||"").toString().trim() || "Ciao";
    const cliente = `${a.nome||""} ${a.cognome||""}`.trim();
    const phone = a.telefono || "";

    if(upcoming){
      segment = "RINNOVO";
      const gg = daysBetweenISO(today, upcoming.date) ?? 0;
      reason = `Scadenza vincolo ${upcoming.type} tra ${gg} gg (${upcoming.date})`;
      proposal = "Rinnovo / Upgrade con promo riservata";
      score = Math.min(100, 70 + Math.max(0, 30-gg));
      msg = `Ciao ${nome}! Ti scrivo da VOLPEX: vedo una scadenza vicina (${upcoming.date}). Se vuoi, posso riservarti una promo upgrade/rinnovo dedicata. Ti va se ti chiamo 2 minuti?`;
    } else if(daysSince != null && daysSince >= inactiveMin && nCon > 0){
      segment = "WINBACK";
      reason = `Inattivo da ${daysSince} giorni (ultima attivit√† ${last})`;
      proposal = "Offerta rientro / bonus / promo esclusiva";
      score = Math.min(100, 60 + Math.min(30, Math.floor((daysSince-inactiveMin)/3)));
      msg = `Ciao ${nome}! Sono VOLPEX üôÇ √à da un po‚Äô che non attivi con noi: posso farti una promo rientro riservata (anche con bonus). Vuoi che ti mandi 2 opzioni?`;
    } else if(valueEst >= 600 || loyalty >= 10 || nCon >= 3 || spend >= 700){
      segment = "VIP";
      reason = `Cliente affezionato: contratti=${nCon}, device=${nDev}, rip=${nRip}, spesa‚âà${spend.toFixed(0)}‚Ç¨`;
      proposal = "Buono fedelt√† / offerta esclusiva clienti top";
      score = Math.min(100, 75 + Math.min(25, Math.floor(loyalty)));
      msg = `Ciao ${nome}! Grazie per essere un nostro cliente ‚Äútop‚Äù üôå Ti posso riservare un buono fedelt√† o un‚Äôofferta esclusiva. Ti va di vedere cosa conviene di pi√π?`;
    } else {
      segment = "UPSELL";
      if(mnpYes && lastCon){
        reason = `Ha fatto MNP; ultimo contratto ${lastCon}`;
        proposal = "Follow-up: convergenza / upgrade / device a rate";
        score = Math.min(100, 55 + Math.min(30, Math.floor(loyalty)));
        msg = `Ciao ${nome}! Ti scrivo da VOLPEX: ti va una proposta upgrade (es. convergenza/fibra o device) pensata per chi ha gi√† fatto MNP? Posso mandarti 2 soluzioni rapide.`;
      } else {
        reason = `Attivit√† recente ${last} ‚Ä¢ contratti=${nCon}, device=${nDev}, rip=${nRip}`;
        proposal = "Check-up: offerta migliore / accessori / estensione garanzia";
        score = Math.min(100, 50 + Math.min(30, Math.floor(loyalty)));
        msg = `Ciao ${nome}! Ti scrivo da VOLPEX: vuoi che controlliamo se oggi c‚Äô√® un‚Äôofferta migliore per te o un upgrade utile? Ti mando 2 alternative.`;
      }
    }

    // filtro segmento
    if(segFilter && segment !== segFilter) return;

    const wa = waLinkText(phone, msg);

    
    // boost score con valore stimato
    score = Math.min(100, score + Math.min(15, Math.floor(valueEst/200)));
rows.push({
      score,
      segment,
      cf,
      cliente,
      last,
      days: daysSince ?? "",
      reason,
      proposal,
      value_est: valueEst,
      value_contracts: valueContracts,
      value_margins: valueMargins,
      wa,
      phone: phone,
      msg
    });
  });

  rows.sort((a,b)=>b.score-a.score);
  smartRows = rows;

  // counters
  const ren = rows.filter(r=>r.segment==="RINNOVO").length;
  const win = rows.filter(r=>r.segment==="WINBACK").length;
  const vip = rows.filter(r=>r.segment==="VIP").length;
  const up  = rows.filter(r=>r.segment==="UPSELL").length;

  setText("smartTot", rows.length);
  setText("smartRen", ren);
  setText("smartWin", win);
  setText("smartVip", vip);
  setText("smartUp", up);

  const tb = qs("#tblSmart tbody");
  if(!tb) return;
  tb.innerHTML = rows.map(r=>{
    const bcls = r.segment==="RINNOVO" ? "bad" : (r.segment==="WINBACK" ? "warn" : (r.segment==="VIP" ? "good" : ""));
    const waBtn = (r.wa && r.wa!=="#")
      ? `<a class="btn primary small" style="text-decoration:none;display:inline-block" href="${r.wa}" target="_blank" rel="noopener">WhatsApp</a>`
      : `<span class="muted">‚Äî</span>`;
    const viewBtn = `<button class="btn secondary small" onclick="openClientFromCF('${r.cf}')">Scheda</button>`;
    return `
      <tr>
        <td><b>${Math.round(r.score)}</b></td>
        <td><span class="badge ${bcls}">${r.segment}</span></td>
        <td class="mono">${r.cf}</td>
        <td>${r.cliente}</td>
        <td>${r.last}</td>
        <td>${r.days}</td>
        <td>${r.reason}</td>
        <td>${r.proposal}</td>
        <td>${moneyFmt(r.value_est || 0)}</td>
        <td style="white-space:nowrap;display:flex;gap:6px;align-items:center">${waBtn}${viewBtn}</td>
      </tr>`;
  }).join("") || `<tr><td colspan="10" class="muted">Nessun suggerimento con questi filtri.</td></tr>`;

  toast("Suggerimenti ricontatto aggiornati ‚úÖ");
}

function exportSmartCsv(){
  if(!smartRows.length){ toast("Nessun suggerimento da esportare"); return; }
  const headers = ["score","segment","cf","cliente","last","days","reason","proposal","value_est","phone","wa"];
  downloadCSV(`ricontatti_suggeriti_${todayISO()}.csv`, headers, smartRows.map(r=>({
    score:r.score, segment:r.segment, cf:r.cf, cliente:r.cliente, last:r.last, days:r.days, reason:r.reason, proposal:r.proposal, value_est:r.value_est, phone:r.phone, wa:r.wa
  })));
}


/* =========================
   VALUE SETTINGS UI + CAMPAIGNS UI
========================= */
function syncValueSettingsUI(){
  const v = loadValueSettings();
  if(qs("#valMonths")) qs("#valMonths").value = v.months;
  if(qs("#marginDevPct")) qs("#marginDevPct").value = v.marginDevPct;
  if(qs("#marginRipPct")) qs("#marginRipPct").value = v.marginRipPct;
}
function bindValueSettings(){
  qs("#btnSaveValueSettings")?.addEventListener("click", ()=>{
    const v = {
      months: Math.max(1, parseInt(qs("#valMonths")?.value || "12",10)),
      marginDevPct: Math.max(0, Math.min(100, parseFloat(qs("#marginDevPct")?.value || "15"))),
      marginRipPct: Math.max(0, Math.min(100, parseFloat(qs("#marginRipPct")?.value || "40")))
    };
    saveValueSettings(v);
toast("Impostazioni valore salvate ‚úÖ");
    // rigenera suggerimenti con nuovo scoring
    buildSmartSuggestions();
  });
}

function newCampaignId(){ return "CAMP-" + Math.random().toString(36).slice(2,7).toUpperCase() + "-" + Date.now().toString().slice(-5); }

function renderCampaignSelect(){
  const sel = qs("#campSelect");
  if(!sel) return;
  sel.innerHTML = "";
  if(!campaigns.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Nessuna campagna";
    sel.appendChild(opt);
    selectedCampaignId = "";
    renderCampaignLeads();
    return;
  }
  campaigns
    .slice()
    .sort((a,b)=>(b.created_at||"").localeCompare(a.created_at||""))
    .forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.name} ‚Ä¢ ${c.segment||"TUTTI"} ‚Ä¢ ${c.leads?.length||0} lead`;
      sel.appendChild(opt);
    });
  if(!selectedCampaignId || !campaigns.some(c=>c.id===selectedCampaignId)){
    selectedCampaignId = campaigns[0].id;
  }
  sel.value = selectedCampaignId;
  renderCampaignLeads();
}

function renderCampaignLeads(){
  const tb = qs("#tblCampaignLeads tbody");
  if(!tb) return;
  const camp = campaigns.find(c=>c.id===selectedCampaignId);
  if(!camp){
    tb.innerHTML = `<tr><td colspan="10" class="muted">Seleziona o crea una campagna.</td></tr>`;
    return;
  }
  const leads = (camp.leads||[]).slice().sort((a,b)=>(b.score||0)-(a.score||0));
  tb.innerHTML = leads.map(l=>{
    const status = l.status || "DA_CONTATTARE";
    const outcome = l.outcome || "";
    const fu = l.followup || "";
    const last = l.last_contact || "";
    const wa = l.wa || "#";
    const waBtn = (wa && wa!=="#")
      ? `<a class="btn primary small" style="text-decoration:none;display:inline-block" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>`
      : `<span class="muted">‚Äî</span>`;
    const viewBtn = `<button class="btn secondary small" onclick="openClientFromCF('${l.cf}')">Scheda</button>`;
    const markBtn = `<button class="btn secondary small" data-act="mark" data-cf="${l.cf}">Contattato</button>`;
    return `
      <tr>
        <td><b>${Math.round(l.score||0)}</b></td>
        <td><span class="badge">${l.segment||""}</span></td>
        <td class="mono">${l.cf}</td>
        <td>${l.cliente||""}</td>
        <td>${moneyFmt(l.value_est||0)}</td>
        <td>
          <select data-act="status" data-cf="${l.cf}">
            ${["DA_CONTATTARE","CONTATTATO","CHIUSO"].map(s=>`<option ${s===status?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td>
          <select data-act="outcome" data-cf="${l.cf}">
            ${["","NON_RISPONDE","INTERESSATO","RIFIUTA","APPUNTAMENTO","RINNOVATO"].map(s=>`<option value="${s}" ${s===outcome?"selected":""}>${s||"‚Äî"}</option>`).join("")}
          </select>
        </td>
        <td><input data-act="followup" data-cf="${l.cf}" type="date" value="${fu}"/></td>
        <td class="mono">${last}</td>
        <td style="white-space:nowrap;display:flex;gap:6px;align-items:center">${waBtn}${markBtn}${viewBtn}</td>
      </tr>`;
  }).join("") || `<tr><td colspan="10" class="muted">Campagna vuota.</td></tr>`;
}

function bindCampaignUI(){
  qs("#btnCreateCampaign")?.addEventListener("click", ()=>{
    if(!smartRows || !smartRows.length){ toast("Prima genera i ricontatti suggeriti"); return; }
    const name = (qs("#campName")?.value || "").trim() || ("Campagna " + new Date().toLocaleDateString("it-IT"));
    const seg = upper(qs("#campSeg")?.value || "");
    const leads = smartRows
      .filter(r=> !seg ? true : r.segment===seg)
      .slice(0, 300)
      .map(r=>({
        cf: r.cf,
        cliente: r.cliente,
        segment: r.segment,
        score: r.score,
        value_est: r.value_est || 0,
        reason: r.reason,
        proposal: r.proposal,
        wa: r.wa,
        phone: r.phone || "",
        msg: r.msg || "",
        status: "DA_CONTATTARE",
        outcome: "",
        followup: "",
        last_contact: ""
      }));
    const camp = {
      id: newCampaignId(),
      name,
      segment: seg || "TUTTI",
      created_at: new Date().toISOString(),
      leads
    };
    campaigns.unshift(camp);
    saveCampaigns(campaigns);
    selectedCampaignId = camp.id;
    qs("#campName").value = "";
    toast("Campagna creata ‚úÖ");
    renderCampaignSelect();
  });

  qs("#campSelect")?.addEventListener("change", (e)=>{
    selectedCampaignId = e.target.value || "";
    renderCampaignLeads();
  });

  qs("#btnDeleteCampaign")?.addEventListener("click", ()=>{
    if(!selectedCampaignId){ toast("Nessuna campagna selezionata"); return; }
    campaigns = campaigns.filter(c=>c.id!==selectedCampaignId);
    saveCampaigns(campaigns);
    selectedCampaignId = "";
    toast("Campagna eliminata");
    renderCampaignSelect();
  });

  qs("#btnExportCampaignCsv")?.addEventListener("click", ()=>{
    const camp = campaigns.find(c=>c.id===selectedCampaignId);
    if(!camp){ toast("Nessuna campagna selezionata"); return; }
    const headers = ["cf","cliente","segment","score","value_est","status","outcome","followup","last_contact","reason","proposal","phone","wa"];
    downloadCSV(`campagna_${camp.name.replace(/\s+/g,"_")}_${todayISO()}.csv`, headers, (camp.leads||[]).map(l=>({
      cf:l.cf, cliente:l.cliente, segment:l.segment, score:l.score, value_est:l.value_est,
      status:l.status, outcome:l.outcome, followup:l.followup, last_contact:l.last_contact,
      reason:l.reason, proposal:l.proposal, phone:l.phone, wa:l.wa
    })));
    toast("Export campagna avviato ‚úÖ");
  });

  // Delegation: status/outcome/followup/mark
  qs("#tblCampaignLeads")?.addEventListener("change", (e)=>{
    const act = e.target?.dataset?.act;
    const cf = upper(e.target?.dataset?.cf || "");
    if(!act || !cf) return;
    const camp = campaigns.find(c=>c.id===selectedCampaignId);
    if(!camp) return;
    const lead = (camp.leads||[]).find(l=>upper(l.cf)===cf);
    if(!lead) return;

    if(act==="status") lead.status = e.target.value;
    if(act==="outcome") lead.outcome = e.target.value;
    if(act==="followup") lead.followup = e.target.value || "";

    saveCampaigns(campaigns);
  });

  qs("#tblCampaignLeads")?.addEventListener("click", (e)=>{
    const btn = e.target?.closest("button");
    if(!btn) return;
    if(btn.dataset.act !== "mark") return;
    const cf = upper(btn.dataset.cf || "");
    const camp = campaigns.find(c=>c.id===selectedCampaignId);
    const lead = camp?.leads?.find(l=>upper(l.cf)===cf);
    if(!lead) return;

    lead.status = "CONTATTATO";
    lead.last_contact = new Date().toLocaleString("it-IT");
    // followup default: +3 giorni se vuoto
    if(!lead.followup){
      const d = new Date(); d.setDate(d.getDate()+3);
      lead.followup = d.toISOString().slice(0,10);
    }
    saveCampaigns(campaigns);
    renderCampaignLeads();
    toast("Segnato come contattato ‚úÖ");
  });
}


function openClientFromCF(cf){
  try{
    if(typeof openClientSheet === "function"){
      qs("#clientSearchCF").value = cf;
      openClientSheet();
      return;
    }
  }catch(e){}
  const btn = document.querySelector('[data-view="anagrafica"]');
  if(btn) btn.click();
  const s = qs("#searchAnag");
  if(s){ s.value = cf; renderAnag(); }
}

function exportPDFReport(){
  const repImg = canvasToImgDataUrl("chartReportTypes");
  const dailyImg = canvasToImgDataUrl("chartDaily");
  const sellersImg = canvasToImgDataUrl("chartSellers");
  const compImg = canvasToImgDataUrl("chartCompanies");

  const rows = reportRows.map(r=>({
    Tipo:r.tipo, Data:r.date, CF:r.cf, Cliente:r.cliente, Contatto:r.contatto, Citt√†:r.citta, Descrizione:r.descr, Extra:r.extra
  }));
  const htmlTable = buildTableHTML(["Tipo","Data","CF","Cliente","Contatto","Citt√†","Descrizione","Extra"], rows);

  const w = window.open("", "_blank");
  if(!w){ toast("Popup bloccato: abilita popup per export PDF"); return; }

  w.document.open();
  w.document.write(`
    <!doctype html><html><head><meta charset="utf-8"/>
    <title>VOLPEX ‚Äì Report PDF</title>
    <style>

    :root{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6e9f0;

      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --primary-soft:#eff6ff;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --shadow: 0 10px 25px rgba(15, 23, 42, .06);
      --shadow-sm: 0 6px 16px rgba(15, 23, 42, .05);

      --radius:16px;
      --radius-sm:12px;
      --ring: 0 0 0 4px rgba(37, 99, 235, .12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    a{color:inherit}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:290px;
      background:linear-gradient(180deg,#0b1220 0%, #0b1220 55%, #0d172a 100%);
      color:#e5e7eb;
      padding:16px;
      position:sticky;top:0;height:100vh;overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    .main{flex:1;display:flex;flex-direction:column;min-width:0}

    .content{
      max-width:1320px;
      margin:0 auto;
      width:100%;
      padding:0 18px;
    }

    /* Sidebar header */
    .logo{
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoMark{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(37,99,235,.18);
      border:1px solid rgba(37,99,235,.35);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      font-weight:950;
      color:#bfdbfe;
    }
    .sub{color:rgba(229,231,235,.7);font-size:12px;margin:8px 0 12px}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      font-size:11px;border:1px solid rgba(191,219,254,.35);
      background:rgba(37,99,235,.12);
      color:#bfdbfe;padding:3px 10px;border-radius:999px;font-weight:900;
      margin-left:auto;
    }

    /* Sidebar nav */
    .nav{margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .nav button{
      width:100%;
      padding:10px 12px;
      border:none;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      text-align:left;
      cursor:pointer;
      color:rgba(229,231,235,.85);
      display:flex;
      gap:10px;
      align-items:center;
      transition: .15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      background:rgba(255,255,255,.06);
      border-color: rgba(191,219,254,.25);
    }
    .nav button.active{
      background:rgba(37,99,235,.14);
      border-color: rgba(191,219,254,.35);
      color:#bfdbfe;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      position:relative;
    }
    .nav button.active::before{
      content:"";
      position:absolute;
      left:-16px;
      top:10px;
      bottom:10px;
      width:3px;
      border-radius:999px;
      background:#60a5fa;
    }

    .sideCard{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      background:rgba(255,255,255,.03);
      backdrop-filter: blur(8px);
    }
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:rgba(229,231,235,.75);margin-top:8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(245,247,251,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px 0;
    }
    .topbarInner{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #pageTitle{margin:0;font-size:16px;letter-spacing:-.2px}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Views */
    .view{display:none;padding:18px 0}
    .view.active{display:block}

    /* Cards */
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow-sm);
    }
    .card h3{margin:0 0 8px 0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .smallNote{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:12px 0}

    /* KPI */
    .kpi-label{font-size:12px;color:var(--muted)}
    .kpi-value{font-size:30px;font-weight:950;letter-spacing:-.7px;line-height:1.05}
    .kpi-sub{font-size:12px;color:var(--muted);margin-top:2px}

    /* Inputs */
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--text);
      outline:none;
      transition:.12s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--ring);
    }
    textarea{min-height:88px;resize:vertical}

    /* Buttons */
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: .12s ease;
      box-shadow:none;
    }
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-2);transform:translateY(-1px)}
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .btn.secondary:hover{transform:translateY(-1px)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.danger:hover{transform:translateY(-1px)}
    .btn.small{padding:8px 12px;font-size:12px}

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{
      color:var(--muted);
      text-align:left;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      position:sticky;
      top:0;
      background:#fff;
      z-index:2;
    }
    tbody tr:hover{background:#f7f9ff}
    tbody tr:nth-child(even){background:rgba(241,245,249,.35)}
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: var(--radius);
    }
    .tableWrap table{border-radius: var(--radius);}

    /* Badges */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      background:var(--primary-soft);
      color:#1d4ed8;
      font-weight:900;
      border:1px solid #c7d2fe
    }
    .badge.good{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .badge.warn{background:#fef9c3;color:#854d0e;border-color:#fde68a}
    .badge.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    /* Timeline */
    .timeline{border-left:3px solid var(--border);padding-left:14px}
    .tItem{margin:12px 0}
    .tTitle{font-weight:950}
    .tMeta{color:var(--muted);font-size:12px;margin-top:3px}

    /* Charts */
    canvas{width:100%;height:260px;border:1px solid var(--border);border-radius:14px;background:#fff}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:50;
      background:#0f172a;color:#fff;padding:10px 12px;border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.15);max-width:520px;display:none
    }
    .toast.show{display:block}

    /* Print */
    @media print{
      .sidebar,.topbar,.btn,.toolbar input[type="file"]{display:none!important}
      .view{display:block!important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #ddd}
      th{position:static}
      canvas{height:220px}
    }

    /* Responsive */
    @media (max-width: 980px){
      .sidebar{position:fixed;left:-320px;top:0;bottom:0;z-index:40;transition:.2s ease}
      .sidebar.open{left:0}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .content{padding:0 14px}
    }

  </style></head><body>
      <div class="noprint" style="display:flex;gap:10px;justify-content:flex-end;margin-bottom:10px">
        <button onclick="window.print()" style="padding:10px 12px;border-radius:999px;border:none;background:#2563eb;color:white;font-weight:800;cursor:pointer">Stampa / Salva PDF</button>
        <button onclick="window.close()" style="padding:10px 12px;border-radius:999px;border:1px solid #e5e7eb;background:white;font-weight:800;cursor:pointer">Chiudi</button>
      </div>
      <h1>VOLPEX ‚Äì Report</h1>
      <div class="muted">Generato: ${new Date().toLocaleString("it-IT")} ‚Ä¢ Righe: ${reportRows.length}</div>
      <div class="grid">
        <div class="card"><div class="muted">Grafico report (per tipo)</div>${repImg?`<img src="${repImg}"/>`:"<div class='muted'>‚Äî</div>"}</div>
        <div class="card"><div class="muted">Attivit√† giornaliera (30gg)</div>${dailyImg?`<img src="${dailyImg}"/>`:"<div class='muted'>‚Äî</div>"}</div>
        <div class="card"><div class="muted">Top venditori (30gg)</div>${sellersImg?`<img src="${sellersImg}"/>`:"<div class='muted'>‚Äî</div>"}</div>
        <div class="card"><div class="muted">Contratti per compagnia (30gg)</div>${compImg?`<img src="${compImg}"/>`:"<div class='muted'>‚Äî</div>"}</div>
      </div>
      <div class="card" style="margin-top:14px">
        <div class="muted">Tabella risultati</div>
        ${htmlTable}
      </div>
    
<!-- ================= GOOGLE SHEETS SYNC (Apps Script Web App) ================= -->
<script>
  // === CONFIG ===
  const GS_URL = "https://script.google.com/macros/s/AKfycbzqjV_XrlTnfJ96ZvMdygNj53fco3u_lwk0OgQUc5YxqmScLntEr-uzoUmjl4T_rlBW/exec";
  const GS_TOKEN = "VOLPEX_SECRET_TOKEN"; // <- metti QUI lo stesso token dello script Google

  async function gsCall(action, payload = {}) {
    const res = await fetch(GS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: GS_TOKEN, action, ...payload })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Google Sync error");
    return data;
  }

  // === UI Buttons (fixed bottom-right) ===
  document.addEventListener("DOMContentLoaded", () => {
    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;bottom:12px;right:12px;z-index:99999;display:flex;gap:8px;align-items:center";
    bar.innerHTML = `
      <button id="btnGsDown" class="btn secondary small" title="Scarica dati dal Foglio Google nel CRM">‚¨áÔ∏è Google ‚Üí CRM</button>
      <button id="btnGsUp" class="btn primary small" title="Invia dati dal CRM al Foglio Google">‚¨ÜÔ∏è CRM ‚Üí Google</button>
      <button id="btnGsPing" class="btn small" title="Test collegamento">üîå Test</button>
    `;
    document.body.appendChild(bar);

    document.getElementById("btnGsUp").addEventListener("click", syncUp);
    document.getElementById("btnGsDown").addEventListener("click", syncDown);
    document.getElementById("btnGsPing").addEventListener("click", async ()=>{
      try{
        const r = await gsCall("ping");
        toast("Collegamento OK ‚úÖ " + (r.ts||""), 1600);
      }catch(e){
        alert("Test fallito: " + e.message + "\n\nControlla: token, deploy Web App (Chiunque con link), e che stai usando l'URL /exec.");
      }
    });
  });

  // === SYNC UP: CRM -> Google ===
  async function syncUp() {
    try {
      // Le variabili principali del CRM sono array: anagrafica, contratti, device, riparazioni
      await gsCall("upsertMany", { table: "clients", rows: (window.anagrafica || []) });
      await gsCall("upsertMany", { table: "contracts", rows: (window.contratti || []) });
      await gsCall("upsertMany", { table: "devices", rows: (window.device || []) });
      await gsCall("upsertMany", { table: "repairs", rows: (window.riparazioni || []) });

      toast("Sincronizzato su Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync UP: " + e.message + "\n\nSuggerimento: apri 'üîå Test' per vedere se la Web App risponde.");
    }
  }

  // === SYNC DOWN: Google -> CRM ===
  async function syncDown() {
    try {
      const a = await gsCall("getAll", { table: "clients" });
      const c = await gsCall("getAll", { table: "contracts" });
      const d = await gsCall("getAll", { table: "devices" });
      const r = await gsCall("getAll", { table: "repairs" });

      window.anagrafica = (a.rows || []);
      window.contratti = (c.rows || []);
      window.device = (d.rows || []);
      window.riparazioni = (r.rows || []);

      saveStore();
      refreshAll();
      toast("Dati scaricati da Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync DOWN: " + e.message + "\n\nControlla anche che le tab nel Foglio si chiamino: clients, contracts, devices, repairs.");
    }
  }
</script>
<!-- ========================================================================== -->

</body></html>
  `);
  w.document.close();
  toast("PDF pronto ‚úÖ");
}
function exportPDFFull(){
  const dailyImg = canvasToImgDataUrl("chartDaily");
  const sellersImg = canvasToImgDataUrl("chartSellers");
  const compImg = canvasToImgDataUrl("chartCompanies");
  const { con30, dev30, rip30 } = compute30();

  const conRows = con30.map(x=>({Data:x.date, ID:x.id||"", CF:x.cf, Cliente:x.cliente, Compagnia:x.compagnia, Offerta:x.offerta, Tecnologia:x.tecnologia, MNP:x.mnp}));
  const devRows = dev30.map(x=>({Data:x.date, ID:x.id, CF:x.cf, Cliente:x.cliente, Modello:x.modello, IMEI:x.imei, Prezzo: (x.prezzo!=null?moneyFmt(x.prezzo):""), Venditore:x.venditore}));
  const ripRows = rip30.map(x=>({Ingresso:x.date, ID:x.id, CF:x.cf, Cliente:x.cliente, Modello:x.modello, Problema:x.problema, Stato:x.stato, Costo:(x.costo!=null?moneyFmt(x.costo):"")}));

  const w = window.open("", "_blank");
  if(!w){ toast("Popup bloccato: abilita popup per export PDF"); return; }

  w.document.open();
  w.document.write(`
    <!doctype html><html><head><meta charset="utf-8"/>
    <title>VOLPEX ‚Äì Dashboard PDF</title>
    <style>

    :root{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e6e9f0;

      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --primary-soft:#eff6ff;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --shadow: 0 10px 25px rgba(15, 23, 42, .06);
      --shadow-sm: 0 6px 16px rgba(15, 23, 42, .05);

      --radius:16px;
      --radius-sm:12px;
      --ring: 0 0 0 4px rgba(37, 99, 235, .12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    a{color:inherit}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:290px;
      background:linear-gradient(180deg,#0b1220 0%, #0b1220 55%, #0d172a 100%);
      color:#e5e7eb;
      padding:16px;
      position:sticky;top:0;height:100vh;overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    .main{flex:1;display:flex;flex-direction:column;min-width:0}

    .content{
      max-width:1320px;
      margin:0 auto;
      width:100%;
      padding:0 18px;
    }

    /* Sidebar header */
    .logo{
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoMark{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(37,99,235,.18);
      border:1px solid rgba(37,99,235,.35);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      font-weight:950;
      color:#bfdbfe;
    }
    .sub{color:rgba(229,231,235,.7);font-size:12px;margin:8px 0 12px}
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      font-size:11px;border:1px solid rgba(191,219,254,.35);
      background:rgba(37,99,235,.12);
      color:#bfdbfe;padding:3px 10px;border-radius:999px;font-weight:900;
      margin-left:auto;
    }

    /* Sidebar nav */
    .nav{margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .nav button{
      width:100%;
      padding:10px 12px;
      border:none;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      text-align:left;
      cursor:pointer;
      color:rgba(229,231,235,.85);
      display:flex;
      gap:10px;
      align-items:center;
      transition: .15s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      background:rgba(255,255,255,.06);
      border-color: rgba(191,219,254,.25);
    }
    .nav button.active{
      background:rgba(37,99,235,.14);
      border-color: rgba(191,219,254,.35);
      color:#bfdbfe;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      position:relative;
    }
    .nav button.active::before{
      content:"";
      position:absolute;
      left:-16px;
      top:10px;
      bottom:10px;
      width:3px;
      border-radius:999px;
      background:#60a5fa;
    }

    .sideCard{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      background:rgba(255,255,255,.03);
      backdrop-filter: blur(8px);
    }
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:rgba(229,231,235,.75);margin-top:8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(245,247,251,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      padding:14px 0;
    }
    .topbarInner{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #pageTitle{margin:0;font-size:16px;letter-spacing:-.2px}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Views */
    .view{display:none;padding:18px 0}
    .view.active{display:block}

    /* Cards */
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow-sm);
    }
    .card h3{margin:0 0 8px 0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .smallNote{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:12px 0}

    /* KPI */
    .kpi-label{font-size:12px;color:var(--muted)}
    .kpi-value{font-size:30px;font-weight:950;letter-spacing:-.7px;line-height:1.05}
    .kpi-sub{font-size:12px;color:var(--muted);margin-top:2px}

    /* Inputs */
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--text);
      outline:none;
      transition:.12s ease;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: var(--ring);
    }
    textarea{min-height:88px;resize:vertical}

    /* Buttons */
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: .12s ease;
      box-shadow:none;
    }
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-2);transform:translateY(-1px)}
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .btn.secondary:hover{transform:translateY(-1px)}
    .btn.danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn.danger:hover{transform:translateY(-1px)}
    .btn.small{padding:8px 12px;font-size:12px}

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between
    }
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{
      color:var(--muted);
      text-align:left;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      position:sticky;
      top:0;
      background:#fff;
      z-index:2;
    }
    tbody tr:hover{background:#f7f9ff}
    tbody tr:nth-child(even){background:rgba(241,245,249,.35)}
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: var(--radius);
    }
    .tableWrap table{border-radius: var(--radius);}

    /* Badges */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      background:var(--primary-soft);
      color:#1d4ed8;
      font-weight:900;
      border:1px solid #c7d2fe
    }
    .badge.good{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .badge.warn{background:#fef9c3;color:#854d0e;border-color:#fde68a}
    .badge.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca}

    /* Timeline */
    .timeline{border-left:3px solid var(--border);padding-left:14px}
    .tItem{margin:12px 0}
    .tTitle{font-weight:950}
    .tMeta{color:var(--muted);font-size:12px;margin-top:3px}

    /* Charts */
    canvas{width:100%;height:260px;border:1px solid var(--border);border-radius:14px;background:#fff}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:50;
      background:#0f172a;color:#fff;padding:10px 12px;border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.15);max-width:520px;display:none
    }
    .toast.show{display:block}

    /* Print */
    @media print{
      .sidebar,.topbar,.btn,.toolbar input[type="file"]{display:none!important}
      .view{display:block!important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #ddd}
      th{position:static}
      canvas{height:220px}
    }

    /* Responsive */
    @media (max-width: 980px){
      .sidebar{position:fixed;left:-320px;top:0;bottom:0;z-index:40;transition:.2s ease}
      .sidebar.open{left:0}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .content{padding:0 14px}
    }

  </style></head><body>
      <div class="noprint" style="display:flex;gap:10px;justify-content:flex-end;margin-bottom:10px">
        <button onclick="window.print()" style="padding:10px 12px;border-radius:999px;border:none;background:#2563eb;color:white;font-weight:800;cursor:pointer">Stampa / Salva PDF</button>
        <button onclick="window.close()" style="padding:10px 12px;border-radius:999px;border:1px solid #e5e7eb;background:white;font-weight:800;cursor:pointer">Chiudi</button>
      </div>
      <h1>VOLPEX ‚Äì Dashboard</h1>
      <div class="muted">Generato: ${new Date().toLocaleString("it-IT")}</div>

      <div class="grid">
        <div class="card"><div class="muted">Attivit√† giornaliera (30gg)</div>${dailyImg?`<img src="${dailyImg}"/>`:""}</div>
        <div class="card"><div class="muted">Top venditori (30gg)</div>${sellersImg?`<img src="${sellersImg}"/>`:""}</div>
        <div class="card"><div class="muted">Contratti per compagnia (30gg)</div>${compImg?`<img src="${compImg}"/>`:""}</div>
        <div class="card">
          <div class="muted">KPI</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <div><b>Contratti 30gg</b><div>${con30.length}</div></div>
            <div><b>Device 30gg</b><div>${dev30.length}</div></div>
            <div><b>Riparazioni 30gg</b><div>${rip30.length}</div></div>
            <div><b>Clienti</b><div>${anagrafica.length}</div></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="muted">Contratti ultimi 30gg</div>
        ${buildTableHTML(["Data","ID","CF","Cliente","Compagnia","Offerta","Tecnologia","MNP"], conRows)}
      </div>
      <div class="card" style="margin-top:14px">
        <div class="muted">Device ultimi 30gg</div>
        ${buildTableHTML(["Data","ID","CF","Cliente","Modello","IMEI","Prezzo","Venditore"], devRows)}
      </div>
      <div class="card" style="margin-top:14px">
        <div class="muted">Riparazioni ultimi 30gg</div>
        ${buildTableHTML(["Ingresso","ID","CF","Cliente","Modello","Problema","Stato","Costo"], ripRows)}
      </div>
    
<!-- ================= GOOGLE SHEETS SYNC (Apps Script Web App) ================= -->
<script>
  // === CONFIG ===
  const GS_URL = "https://script.google.com/macros/s/AKfycbzqjV_XrlTnfJ96ZvMdygNj53fco3u_lwk0OgQUc5YxqmScLntEr-uzoUmjl4T_rlBW/exec";
  const GS_TOKEN = "VOLPEX_SECRET_TOKEN"; // <- metti QUI lo stesso token dello script Google

  async function gsCall(action, payload = {}) {
    const res = await fetch(GS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: GS_TOKEN, action, ...payload })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Google Sync error");
    return data;
  }

  // === UI Buttons (fixed bottom-right) ===
  document.addEventListener("DOMContentLoaded", () => {
    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;bottom:12px;right:12px;z-index:99999;display:flex;gap:8px;align-items:center";
    bar.innerHTML = `
      <button id="btnGsDown" class="btn secondary small" title="Scarica dati dal Foglio Google nel CRM">‚¨áÔ∏è Google ‚Üí CRM</button>
      <button id="btnGsUp" class="btn primary small" title="Invia dati dal CRM al Foglio Google">‚¨ÜÔ∏è CRM ‚Üí Google</button>
      <button id="btnGsPing" class="btn small" title="Test collegamento">üîå Test</button>
    `;
    document.body.appendChild(bar);

    document.getElementById("btnGsUp").addEventListener("click", syncUp);
    document.getElementById("btnGsDown").addEventListener("click", syncDown);
    document.getElementById("btnGsPing").addEventListener("click", async ()=>{
      try{
        const r = await gsCall("ping");
        toast("Collegamento OK ‚úÖ " + (r.ts||""), 1600);
      }catch(e){
        alert("Test fallito: " + e.message + "\n\nControlla: token, deploy Web App (Chiunque con link), e che stai usando l'URL /exec.");
      }
    });
  });

  // === SYNC UP: CRM -> Google ===
  async function syncUp() {
    try {
      // Le variabili principali del CRM sono array: anagrafica, contratti, device, riparazioni
      await gsCall("upsertMany", { table: "clients", rows: (window.anagrafica || []) });
      await gsCall("upsertMany", { table: "contracts", rows: (window.contratti || []) });
      await gsCall("upsertMany", { table: "devices", rows: (window.device || []) });
      await gsCall("upsertMany", { table: "repairs", rows: (window.riparazioni || []) });

      toast("Sincronizzato su Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync UP: " + e.message + "\n\nSuggerimento: apri 'üîå Test' per vedere se la Web App risponde.");
    }
  }

  // === SYNC DOWN: Google -> CRM ===
  async function syncDown() {
    try {
      const a = await gsCall("getAll", { table: "clients" });
      const c = await gsCall("getAll", { table: "contracts" });
      const d = await gsCall("getAll", { table: "devices" });
      const r = await gsCall("getAll", { table: "repairs" });

      window.anagrafica = (a.rows || []);
      window.contratti = (c.rows || []);
      window.device = (d.rows || []);
      window.riparazioni = (r.rows || []);

      saveStore();
      refreshAll();
      toast("Dati scaricati da Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync DOWN: " + e.message + "\n\nControlla anche che le tab nel Foglio si chiamino: clients, contracts, devices, repairs.");
    }
  }
</script>
<!-- ========================================================================== -->

</body></html>
  `);
  w.document.close();
  toast("PDF Dashboard pronto ‚úÖ");
}

/* =========================
   IMPORT buttons wiring
========================= */
document.getElementById("btnImportAnag").addEventListener("click", async ()=>{
  try{
    const txt = await readFileText(document.getElementById("fileAnag"));
    const {rows} = parseCSV(txt);
    const res = importAnagFromRows(rows);
    saveStore(); refreshAll();
    toast(`Import Anagrafica: OK=${res.ok} ‚Ä¢ Skip=${res.skip}`);
  }catch(e){ toast("Errore import: " + e.message); }
});
document.getElementById("btnImportCon").addEventListener("click", async ()=>{
  try{
    const txt = await readFileText(document.getElementById("fileCon"));
    const {rows} = parseCSV(txt);
    const res = importConFromRows(rows);
    saveStore(); refreshAll();
    toast(`Import Contratti: OK=${res.ok} ‚Ä¢ Skip=${res.skip} ‚Ä¢ FK fail=${res.fk}`);
  }catch(e){ toast("Errore import: " + e.message); }
});
document.getElementById("btnImportDev").addEventListener("click", async ()=>{
  try{
    const txt = await readFileText(document.getElementById("fileDev"));
    const {rows} = parseCSV(txt);
    const res = importDevFromRows(rows);
    saveStore(); refreshAll();
    toast(`Import Device: OK=${res.ok} ‚Ä¢ Skip=${res.skip} ‚Ä¢ FK fail=${res.fk}`);
  }catch(e){ toast("Errore import: " + e.message); }
});
document.getElementById("btnImportRip").addEventListener("click", async ()=>{
  try{
    const txt = await readFileText(document.getElementById("fileRip"));
    const {rows} = parseCSV(txt);
    const res = importRipFromRows(rows);
    saveStore(); refreshAll();
    toast(`Import Riparazioni: OK=${res.ok} ‚Ä¢ Skip=${res.skip} ‚Ä¢ FK fail=${res.fk}`);
  }catch(e){ toast("Errore import: " + e.message); }
});

/* =========================
   Templates (CSV)
========================= */
document.getElementById("btnTplAnag").addEventListener("click", ()=>{
  downloadCSV("template_anagrafica.csv",
    ["Codice fiscale","Nome","Cognome","Tipo cliente","Telefono","Email","Citt√†","Indirizzo"],
    [{"Codice fiscale":"RSSMRA80X01H501Z","Nome":"Mario","Cognome":"Rossi","Tipo cliente":"PRIVATO","Telefono":"+39 333...","Email":"mario@email.it","Citt√†":"Roma","Indirizzo":"Via Roma 1"}]
  );
});
document.getElementById("btnTplCon").addEventListener("click", ()=>{
  downloadCSV("template_contratti.csv",
    ["ID contratto","ID cliente","Codice fiscale","Data contratto","Tipo cliente","Tipo attivazione","Tecnologia","Convergenza","MNP","Data attivazione","Data portabilit√†","Numero lavorato","Nome offerta","Costo offerta","Vincolo offerta (mesi)","Telefono incluso","IMEI","Modello","Tipo pagamento","Mesi vincolo telefono","Data fine vincolo offerta","Data fine vincolo telefono","Compagnia","ICCID_vecchio","ICCID_nuovo","created_at","updated_at"],
    [{
      "ID contratto":"C-0001","ID cliente":"C001","Codice fiscale":"RSSMRA80X01H501Z","Data contratto":todayISO(),
      "Tipo cliente":"PRIVATO","Tipo attivazione":"MNP","Tecnologia":"SIM","Convergenza":"NO","MNP":"SI",
      "Data attivazione":todayISO(),"Data portabilit√†":"","Numero lavorato":"333123456","Nome offerta":"OFFERTA X","Costo offerta":"9.99",
      "Vincolo offerta (mesi)":"24","Telefono incluso":"SI","IMEI":"123456789012345","Modello":"IPHONE 13","Tipo pagamento":"CARTA",
      "Mesi vincolo telefono":"24","Data fine vincolo offerta":"","Data fine vincolo telefono":"","Compagnia":"VODAFONE","ICCID_vecchio":"","ICCID_nuovo":"",
      "created_at":"","updated_at":""
    }]
  );
});
document.getElementById("btnTplDev").addEventListener("click", ()=>{
  downloadCSV("template_device.csv",
    ["ID","Codice fiscale","Data vendita","Modello","IMEI","Prezzo","Venditore","Tipo pagamento"],
    [{"ID":"D-1001","Codice fiscale":"RSSMRA80X01H501Z","Data vendita":todayISO(),"Modello":"IPHONE 13","IMEI":"123456789012345","Prezzo":"699","Venditore":"AUGUSTO","Tipo pagamento":"CARTA"}]
  );
});
document.getElementById("btnTplRip").addEventListener("click", ()=>{
  downloadCSV("template_riparazioni.csv",
    ["ID","Codice fiscale","Data ingresso","Modello","IMEI","Problema","Stato riparazione","Costo"],
    [{"ID":"R-9001","Codice fiscale":"RSSMRA80X01H501Z","Data ingresso":todayISO(),"Modello":"IPHONE 13","IMEI":"123456789012345","Problema":"BATTERIA","Stato riparazione":"APERTA","Costo":"49"}]
  );
});

/* =========================
   EXPORT buttons wiring
========================= */
document.getElementById("btnExportAll").addEventListener("click", ()=>{ exportAnag(); exportCon(); exportDev(); exportRip(); toast("Export avviato (CSV multipli) ‚úÖ"); });
document.getElementById("btnExportAnagAll").addEventListener("click", exportAnag);
document.getElementById("btnExportConAll").addEventListener("click", exportCon);
document.getElementById("btnExportDevAll").addEventListener("click", exportDev);
document.getElementById("btnExportRipAll").addEventListener("click", exportRip);
document.getElementById("btnExportFullPdf").addEventListener("click", exportPDFFull);

document.getElementById("btnExportAnagCsv").addEventListener("click", exportAnag);

// Scheda cliente
document.getElementById("btnClientLoad").addEventListener("click", ()=>openClientSheet());
document.getElementById("btnClientGoTimeline").addEventListener("click", ()=>{
  if(!currentClientCF){ toast("Seleziona un cliente"); return; }
  openTimeline(currentClientCF);
});
document.getElementById("btnCS_SaveCon").addEventListener("click", csSaveCon);
document.getElementById("btnCS_SaveDev").addEventListener("click", csSaveDev);
document.getElementById("btnCS_SaveRip").addEventListener("click", csSaveRip);
document.getElementById("btnCS_OpenCon").addEventListener("click", ()=>csOpenFull("contratti"));
document.getElementById("btnCS_OpenDev").addEventListener("click", ()=>csOpenFull("device"));
document.getElementById("btnCS_OpenRip").addEventListener("click", ()=>csOpenFull("riparazioni"));
qs("#cs_search_cf").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); openClientSheet(); }});

document.getElementById("btnExportConCsv").addEventListener("click", exportCon);
document.getElementById("btnExportDevCsv").addEventListener("click", exportDev);
document.getElementById("btnExportRipCsv").addEventListener("click", exportRip);

document.getElementById("btnExportReportCsv").addEventListener("click", ()=>{
  if(!reportRows.length){ toast("Nessun report da esportare"); return; }
  exportReport();
});
document.getElementById("btnExportReportPdf").addEventListener("click", ()=>{
  if(!reportRows.length){ toast("Prima genera il report (Applica filtri)"); return; }
  exportPDFReport();
});


document.getElementById("btnRunSmart")?.addEventListener("click", buildSmartSuggestions);
document.getElementById("btnExportSmartCsv")?.addEventListener("click", exportSmartCsv);


/* =========================
   Search filters
========================= */
document.getElementById("searchAnag").addEventListener("input", renderAnag);
document.getElementById("searchCon").addEventListener("input", renderCon);
document.getElementById("searchDev").addEventListener("input", renderDev);
document.getElementById("searchRip").addEventListener("input", renderRip);

/* =========================
   Buttons CRUD
========================= */
document.getElementById("btnSaveAnag").addEventListener("click", saveAnag);
document.getElementById("btnClearAnag").addEventListener("click", clearAnagForm);

document.getElementById("btnSaveCon").addEventListener("click", saveCon);
document.getElementById("btnClearCon").addEventListener("click", clearConForm);

document.getElementById("btnConFindClient").addEventListener("click", conFindClient);
document.getElementById("btnQASave").addEventListener("click", createClientFromQuick);
document.getElementById("btnQACancel").addEventListener("click", cancelQuickClient);

document.getElementById("btnDevFindClient").addEventListener("click", devFindClient);
document.getElementById("btnQDSave").addEventListener("click", createClientFromQuickDev);
document.getElementById("btnQDCancel").addEventListener("click", cancelQuickClientDev);

document.getElementById("btnRipFindClient").addEventListener("click", ripFindClient);
document.getElementById("btnQRSave").addEventListener("click", createClientFromQuickRip);
document.getElementById("btnQRCancel").addEventListener("click", cancelQuickClientRip);

qs("#c_cf").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); conFindClient(); }});


document.getElementById("btnSaveDev").addEventListener("click", saveDev);
document.getElementById("btnClearDev").addEventListener("click", clearDevForm);

document.getElementById("btnSaveRip").addEventListener("click", saveRip);
document.getElementById("btnClearRip").addEventListener("click", clearRipForm);

document.getElementById("btnRunReport").addEventListener("click", runReport);

// Compleanni
document.getElementById("btnRunBirthdays").addEventListener("click", runBirthdays);
document.getElementById("btnExportBirthdaysCsv").addEventListener("click", exportBirthdaysCSV);

// Scadenze
document.getElementById("btnRunScadenze").addEventListener("click", runScadenze);
document.getElementById("btnExportScadenzeCsv").addEventListener("click", exportScadenzeCSV);

document.getElementById("btnResetReport").addEventListener("click", resetReport);
document.getElementById("btnTimeline").addEventListener("click", loadTimeline);

/* =========================
   Top actions
========================= */
function setLastSync(){ setText("lastSync", new Date().toLocaleString("it-IT")); }
function refreshAll(){
  setLastSync();
  renderDashboardAndConsole();
  renderAnag();
  renderCon();
  renderDev();
  renderRip();
  drawAllCharts();
  try{ runBirthdays(); }catch(e){}
  try{ runScadenze(); }catch(e){}
  toast("Refresh completato ‚úÖ", 1200);
}
document.getElementById("btnRefresh").addEventListener("click", ()=>{ saveStore(); refreshAll(); });
document.getElementById("btnSaveNow").addEventListener("click", ()=>{ saveStore(); toast("Salvato ‚úÖ"); });
document.getElementById("btnResetDemo").addEventListener("click", ()=>{
  seedDemo(); saveStore(); refreshAll(); toast("Demo ripristinata ‚úÖ");
});

/* =========================
   BOOT
========================= */
(function boot(){
  const ok = loadStore();
  if(!ok){ seedDemo(); saveStore(); }
  qs("#c_data_contratto").value = todayISO();
  qs("#d_data").value = todayISO();
  qs("#r_ingresso").value = todayISO();
  syncValueSettingsUI();
  bindValueSettings();
  bindCampaignUI();
  renderCampaignSelect();
  refreshAll();
  // Dopo refresh, rigenera suggerimenti per avere score aggiornati
  try{ buildSmartSuggestions(); renderCampaignSelect(); }catch(e){}
})();
</script>

<!-- ================= GOOGLE SHEETS SYNC (Apps Script Web App) ================= -->
<script>
  // === CONFIG ===
  const GS_URL = "https://script.google.com/macros/s/AKfycbzqjV_XrlTnfJ96ZvMdygNj53fco3u_lwk0OgQUc5YxqmScLntEr-uzoUmjl4T_rlBW/exec";
  const GS_TOKEN = "VOLPEX_SECRET_TOKEN"; // <- metti QUI lo stesso token dello script Google

  async function gsCall(action, payload = {}) {
    const res = await fetch(GS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: GS_TOKEN, action, ...payload })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Google Sync error");
    return data;
  }

  // === UI Buttons (fixed bottom-right) ===
  document.addEventListener("DOMContentLoaded", () => {
    const bar = document.createElement("div");
    bar.style.cssText = "position:fixed;bottom:12px;right:12px;z-index:99999;display:flex;gap:8px;align-items:center";
    bar.innerHTML = `
      <button id="btnGsDown" class="btn secondary small" title="Scarica dati dal Foglio Google nel CRM">‚¨áÔ∏è Google ‚Üí CRM</button>
      <button id="btnGsUp" class="btn primary small" title="Invia dati dal CRM al Foglio Google">‚¨ÜÔ∏è CRM ‚Üí Google</button>
      <button id="btnGsPing" class="btn small" title="Test collegamento">üîå Test</button>
    `;
    document.body.appendChild(bar);

    document.getElementById("btnGsUp").addEventListener("click", syncUp);
    document.getElementById("btnGsDown").addEventListener("click", syncDown);
    document.getElementById("btnGsPing").addEventListener("click", async ()=>{
      try{
        const r = await gsCall("ping");
        toast("Collegamento OK ‚úÖ " + (r.ts||""), 1600);
      }catch(e){
        alert("Test fallito: " + e.message + "\n\nControlla: token, deploy Web App (Chiunque con link), e che stai usando l'URL /exec.");
      }
    });
  });

  // === SYNC UP: CRM -> Google ===
  async function syncUp() {
    try {
      // Le variabili principali del CRM sono array: anagrafica, contratti, device, riparazioni
      await gsCall("upsertMany", { table: "clients", rows: (window.anagrafica || []) });
      await gsCall("upsertMany", { table: "contracts", rows: (window.contratti || []) });
      await gsCall("upsertMany", { table: "devices", rows: (window.device || []) });
      await gsCall("upsertMany", { table: "repairs", rows: (window.riparazioni || []) });

      toast("Sincronizzato su Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync UP: " + e.message + "\n\nSuggerimento: apri 'üîå Test' per vedere se la Web App risponde.");
    }
  }

  // === SYNC DOWN: Google -> CRM ===
  async function syncDown() {
    try {
      const a = await gsCall("getAll", { table: "clients" });
      const c = await gsCall("getAll", { table: "contracts" });
      const d = await gsCall("getAll", { table: "devices" });
      const r = await gsCall("getAll", { table: "repairs" });

      window.anagrafica = (a.rows || []);
      window.contratti = (c.rows || []);
      window.device = (d.rows || []);
      window.riparazioni = (r.rows || []);

      saveStore();
      refreshAll();
      toast("Dati scaricati da Google ‚úÖ", 1600);
    } catch (e) {
      alert("Errore sync DOWN: " + e.message + "\n\nControlla anche che le tab nel Foglio si chiamino: clients, contracts, devices, repairs.");
    }
  }
</script>
<!-- ========================================================================== -->

</body>
