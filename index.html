<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>VOLPEX CRM</title>
<style>
    :root {
      --bg: #f3f4f8;
      --bg-alt: #e5e7f0;
      --card: #ffffff;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --text: #111827;
      --text-soft: #6b7280;
      --border: #d1d5db;
      --danger: #ef4444;
      --success: #22c55e;
      --sidebar-width: 240px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5e7f5 0, #f9fafb 40%, #eef2ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      font-size: 14px;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    .layout {
      display: flex;
      width: 100%;
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #e5e7f5, #f9fafb);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 16px 12px;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.25);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #fb923c, #fbbf24, #22c55e, #06b6d4, #6366f1, #fb923c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #ffffff;
      font-size: 14px;
      box-shadow: 0 0 0 2px #ffffff;
    }

    .logo-text-main {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 13px;
      color: #111827;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin: 10px 4px 4px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-btn {
      width: 100%;
      border: none;
      text-align: left;
      padding: 8px 10px;
      border-radius: 999px;
      background: transparent;
      color: var(--text-soft);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.15s;
    }

    .nav-btn span.icon {
      width: 18px;
      text-align: center;
      opacity: 0.85;
    }

    .nav-btn.active,
    .nav-btn:hover {
      background: rgba(249, 115, 22, 0.08);
      color: #111827;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-soft);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      font-size: 10px;
      margin-top: 4px;
      color: #111827;
    }

    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 18px;
      gap: 12px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .top-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 8px;
      color: #111827;
    }

    .top-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ffffff;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    .btn-primary {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #fb923c, #f97316);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(249, 115, 22, 0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-outline {
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-soft);
      font-size: 12px;
      cursor: pointer;
    }

    .btn-outline:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: #fff7ed;
    }

    /* CONTENT */
    .content {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 0;
    }

    .left-column {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    .right-column {
      flex: 1.2;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 260px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.18);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .grid {
      display: grid;
      gap: 8px;
    }

    .grid-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .kpi-card {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .kpi-tag {
      font-size: 10px;
      color: var(--accent);
      margin-top: 2px;
    }

    .news-frame {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
      height: 280px;
      background: #ffffff;
    }

    .news-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* TABLES & SCROLL */
    .table-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 260px;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    th {
      text-align: left;
      font-weight: 500;
      color: var(--text-soft);
    }

    tbody tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-body {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* FORM */
    .form-grid {
      display: grid;
      gap: 6px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-field label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 7px;
      padding: 4px 6px;
      color: var(--text);
      font-size: 12px;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.3);
    }

    .form-field textarea {
      resize: vertical;
      min-height: 50px;
    }

    .form-actions {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .badge-soft {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .cliente-summary {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .cliente-summary-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .cliente-summary-label {
      color: var(--text-soft);
      min-width: 80px;
    }

    .hidden {
      display: none !important;
    }

    /* TOAST */
    #toastContainer {
      position: fixed;
      bottom: 16px;
      left: calc(var(--sidebar-width) + 16px);
      z-index: 9999;
    }

    .toast {
      background: #ffffff;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 8px 20px rgba(148, 163, 184, 0.4);
      margin-top: 6px;
    }

    .toast.info {
      border-color: var(--accent);
    }

    .toast.error {
      border-color: var(--danger);
      color: #b91c1c;
    }

    .toast.success {
      border-color: var(--success);
      color: #166534;
    }

    /* PROGRESS BAR */
    .progress-bar-container {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-top: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #f97316);
      transition: width 0.15s linear;
    }

    @media (max-width: 960px) {
      body {
        font-size: 13px;
      }
      .sidebar {
        display: none;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .content {
        flex-direction: column;
      }
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      #toastContainer {
        left: 16px;
        right: 16px;
      }
    }
  </style>
</head>
<body>
<div class="layout">
<aside class="sidebar">
<div class="logo">
<div class="logo-icon">V</div>
<div>
<div class="logo-text-main">VOLPEX</div>
<div class="logo-text-sub">CRM Google Sheets</div>
</div>
</div>
<div class="sidebar-section-title">Navigazione</div>
<div class="nav">
<button class="nav-btn active" data-target="sec-dashboard" onclick="switchSection('sec-dashboard')">
<span class="icon">üè†</span>
<span>Dashboard</span>
</button>
<button class="nav-btn" data-target="sec-nuovo" onclick="switchSection('sec-nuovo')">
<span class="icon">üìÑ</span>
<span>Nuovo contratto</span>
</button>
<button class="nav-btn" data-target="sec-device" onclick="switchSection('sec-device')">
<span class="icon">üì±</span>
<span>Vendita device</span>
</button>
<button class="nav-btn" data-target="sec-riparazioni" onclick="switchSection('sec-riparazioni')">
<span class="icon">üõ†Ô∏è</span>
<span>Riparazioni</span>
</button>
<button class="nav-btn" data-target="sec-import" onclick="switchSection('sec-import')">
<span class="icon">‚¨ÜÔ∏è</span>
<span>Import CSV</span>
</button>
<button class="nav-btn" data-target="sec-report" onclick="switchSection('sec-report')">
<span class="icon">üìä</span>
<span>Report &amp; Scadenze</span>
</button>
</div>
<div class="sidebar-section-title">Info</div>
<div class="sidebar-footer">
<div>VOLPEX CRM collegato a Google Sheets</div>
<div class="badge">
<span class="dot"></span>
<span>Online</span>
</div>
</div>
</aside>
<main class="main">
<div class="top-bar">
<div>
<div class="top-title">
            VOLPEX CRM
            <span class="top-sub">
              Gestione clienti, contratti, device &amp; riparazioni
            </span>
</div>
</div>
<div class="top-actions">
<div class="pill">Foglio: <strong>VOLPEX</strong></div>
<button class="btn-outline" onclick="refreshAll()" type="button">
            Aggiorna dati
          </button>
</div>
</div>
<div class="content">
<div class="left-column">
<!-- DASHBOARD -->
<section class="section active" id="sec-dashboard">
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Riepilogo veloce
                </div>
<div class="card-subtitle">
                  Panoramica clienti, contratti e attivit√† oggi
                </div>
</div>
<div class="grid grid-3">
<div class="kpi-card">
<div class="kpi-label">Clienti totali</div>
<div class="kpi-value" id="kpiTotClienti">-</div>
<div class="kpi-tag">Anagrafica</div>
</div>
<div class="kpi-card">
<div class="kpi-label">Contratti totali</div>
<div class="kpi-value" id="kpiTotContratti">-</div>
<div class="kpi-tag">Mobile / Fisso</div>
</div>
<div class="kpi-card">
<div class="kpi-label">Device venduti</div>
<div class="kpi-value" id="kpiTotDevice">-</div>
<div class="kpi-tag">Vendite terminali</div>
</div>
</div>
<div class="grid grid-3" style="margin-top:8px;">
<div class="kpi-card">
<div class="kpi-label">Riparazioni totali</div>
<div class="kpi-value" id="kpiTotRiparazioni">-</div>
<div class="kpi-tag">Assistenza tecnica</div>
</div>
<div class="kpi-card">
<div class="kpi-label">Compleanni oggi</div>
<div class="kpi-value" id="kpiCompleanniOggi">-</div>
<div class="kpi-tag">Da contattare</div>
</div>
<div class="kpi-card">
<div class="kpi-label">Scadenze mese</div>
<div class="kpi-value" id="kpiScadenzeMese">-</div>
<div class="kpi-tag">Fine vincoli offerte</div>
</div>
</div>
</div>
</section>
<!-- NUOVO CLIENTE + CONTRATTO -->
<section class="section" id="sec-nuovo">
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Nuovo cliente + contratto
                </div>
<div class="card-subtitle">
                  Se il cliente non esiste viene creato in automatico dal codice fiscale.
                </div>
</div>
<form id="formNewClienteContratto">
<div class="section-body">
<div class="badge-soft">Dati cliente</div>
<div class="form-grid">
<div class="form-field">
<label>Nome</label>
<input id="nc_nome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Cognome</label>
<input id="nc_cognome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Telefono</label>
<input id="nc_telefono_cliente" type="text"/>
</div>
<div class="form-field">
<label>Email</label>
<input id="nc_email_cliente" type="email"/>
</div>
<div class="form-field">
<label>Codice fiscale *</label>
<input id="nc_cf_cliente" required="" type="text"/>
</div>
<div class="form-field">
<label>Data nascita</label>
<input id="nc_data_nascita_cliente" type="date"/>
</div>
<div class="form-field" style="grid-column: span 2;">
<label>Note cliente</label>
<input id="nc_note_cliente" type="text"/>
</div>
</div>
<div class="badge-soft" style="margin-top:6px;">Dati contratto</div>
<div class="form-grid">
<div class="form-field">
<label>Data contratto</label>
<input id="nc_data_contratto" type="date"/>
</div>
<div class="form-field">
<label>Tipo cliente</label>
<select id="nc_tipo_cliente">
<option value="">Seleziona</option>
<option value="Privato">Privato</option>
<option value="Azienda">Azienda</option>
</select>
</div>
<div class="form-field">
<label>Tipo attivazione</label>
<select id="nc_tipo_attivazione">
<option value="">Seleziona</option>
<option value="Mobile">Mobile</option>
<option value="Fisso">Fisso</option>
<option value="Luce">Luce</option>
<option value="Gas">Gas</option>
<option value="TV">TV</option>
</select>
</div>
<div class="form-field">
<label>Tecnologia</label>
<select id="nc_tecnologia">
<option value="">Seleziona</option>
<option value="SIM">SIM</option>
<option value="FTTC">FTTC</option>
<option value="FTTH">FTTH</option>
<option value="ADSL">ADSL</option>
<option value="FWA">FWA</option>
</select>
</div>
<div class="form-field">
<label>Compagnia</label>
<input id="nc_compagnia" placeholder="es. Vodafone, TIM..." type="text"/>
</div>
<div class="form-field">
<label>Convergenza</label>
<select id="nc_convergenza">
<option value="">Seleziona</option>
<option value="NO">No</option>
<option value="SI">S√¨</option>
</select>
</div>
<div class="form-field">
<label>MNP</label>
<select id="nc_mnp">
<option value="">Seleziona</option>
<option value="NO">No</option>
<option value="SI">S√¨</option>
</select>
</div>
<div class="form-field">
<label>ICCID vecchio</label>
<input id="nc_iccid_vecchio" type="text"/>
</div>
<div class="form-field">
<label>ICCID nuovo</label>
<input id="nc_iccid_nuovo" type="text"/>
</div>
<div class="form-field">
<label>Data attivazione</label>
<input id="nc_data_attivazione" type="date"/>
</div>
<div class="form-field">
<label>Data portabilit√†</label>
<input id="nc_data_portabilita" type="date"/>
</div>
<div class="form-field">
<label>Numero lavorato</label>
<input id="nc_numero_lavorato" type="text"/>
</div>
<div class="form-field">
<label>Nome offerta</label>
<input id="nc_nome_offerta" type="text"/>
</div>
<div class="form-field">
<label>Costo offerta ‚Ç¨</label>
<input id="nc_costo_offerta" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Vincolo offerta (mesi)</label>
<input id="nc_vincolo_offerta_mesi" type="number"/>
</div>
<div class="form-field">
<label>Telefono incluso</label>
<select id="nc_telefono_incluso">
<option value="">Seleziona</option>
<option value="NO">No</option>
<option value="SI">S√¨</option>
</select>
</div>
<div class="form-field">
<label>IMEI telefono</label>
<input id="nc_imei" type="text"/>
</div>
<div class="form-field">
<label>Modello telefono</label>
<input id="nc_modello" type="text"/>
</div>
<div class="form-field">
<label>Tipo pagamento</label>
<select id="nc_tipo_pagamento">
<option value="">Seleziona</option>
<option value="Contanti">Contanti</option>
<option value="Carta">Carta</option>
<option value="Addebito in conto">Addebito in conto</option>
<option value="Finanziamento">Finanziamento</option>
</select>
</div>
<div class="form-field">
<label>Mesi vincolo telefono</label>
<input id="nc_mesi_vincolo_telefono" type="number"/>
</div>
<div class="form-field">
<label>Fine vincolo offerta</label>
<input id="nc_data_fine_vincolo_offerta" type="date"/>
</div>
<div class="form-field">
<label>Fine vincolo telefono</label>
<input id="nc_data_fine_vincolo_telefono" type="date"/>
</div>
</div>
<div class="form-actions">
<button class="btn-primary" type="submit">
<span id="nc_submit_label">Salva cliente + contratto</span>
</button>
</div>
</div>
</form>
</div>
</section>
<!-- VENDITA DEVICE -->
<section class="section" id="sec-device">
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Vendita device
                </div>
<div class="card-subtitle">
                  Il cliente viene creato in automatico se non esiste.
                </div>
</div>
<form id="formDevice">
<div class="section-body">
<div class="badge-soft">Dati cliente</div>
<div class="form-grid">
<div class="form-field">
<label>Codice fiscale *</label>
<input id="dv_cf_cliente" required="" type="text"/>
</div>
<div class="form-field">
<label>Nome</label>
<input id="dv_nome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Cognome</label>
<input id="dv_cognome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Telefono</label>
<input id="dv_telefono_cliente" type="text"/>
</div>
<div class="form-field">
<label>Email</label>
<input id="dv_email_cliente" type="email"/>
</div>
</div>
<div class="badge-soft" style="margin-top:6px;">Dati device</div>
<div class="form-grid">
<div class="form-field">
<label>Data vendita</label>
<input id="dv_data_vendita" type="date"/>
</div>
<div class="form-field">
<label>Marca</label>
<input id="dv_marca" type="text"/>
</div>
<div class="form-field">
<label>Modello</label>
<input id="dv_modello" type="text"/>
</div>
<div class="form-field">
<label>IMEI</label>
<input id="dv_imei" type="text"/>
</div>
<div class="form-field">
<label>Prezzo ‚Ç¨</label>
<input id="dv_prezzo" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Tipo pagamento</label>
<select id="dv_tipo_pagamento">
<option value="">Seleziona</option>
<option value="Contanti">Contanti</option>
<option value="Carta">Carta</option>
<option value="Finanziamento">Finanziamento</option>
</select>
</div>
<div class="form-field">
<label>Durata finanziamento (mesi)</label>
<input id="dv_durata_finanziamento" type="number"/>
</div>
<div class="form-field">
<label>Anticipo ‚Ç¨</label>
<input id="dv_anticipo" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Costo rata ‚Ç¨</label>
<input id="dv_costo_rata" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Fine finanziamento</label>
<input id="dv_data_fine_finanziamento" type="date"/>
</div>
<div class="form-field">
<label>Garanzia (mesi)</label>
<input id="dv_garanzia_mesi" type="number"/>
</div>
<div class="form-field">
<label>Fine garanzia</label>
<input id="dv_data_fine_garanzia" type="date"/>
</div>
<div class="form-field" style="grid-column: span 2;">
<label>Note</label>
<input id="dv_note" type="text"/>
</div>
</div>
<div class="form-actions">
<button class="btn-primary" type="submit">
                      Salva vendita device
                    </button>
</div>
</div>
</form>
</div>
</section>
<!-- RIPARAZIONI -->
<section class="section" id="sec-riparazioni">
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Nuova riparazione
                </div>
<div class="card-subtitle">
                  Gestione assistenze con stato e costi.
                </div>
</div>
<form id="formRiparazione">
<div class="section-body">
<div class="badge-soft">Dati cliente</div>
<div class="form-grid">
<div class="form-field">
<label>Codice fiscale *</label>
<input id="rp_cf_cliente" required="" type="text"/>
</div>
<div class="form-field">
<label>Nome</label>
<input id="rp_nome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Cognome</label>
<input id="rp_cognome_cliente" type="text"/>
</div>
<div class="form-field">
<label>Telefono</label>
<input id="rp_telefono_cliente" type="text"/>
</div>
<div class="form-field">
<label>Email</label>
<input id="rp_email_cliente" type="email"/>
</div>
</div>
<div class="badge-soft" style="margin-top:6px;">Dati riparazione</div>
<div class="form-grid">
<div class="form-field">
<label>Data apertura</label>
<input id="rp_data_apertura" type="date"/>
</div>
<div class="form-field">
<label>Marca</label>
<input id="rp_marca" type="text"/>
</div>
<div class="form-field">
<label>Modello</label>
<input id="rp_modello" type="text"/>
</div>
<div class="form-field">
<label>IMEI</label>
<input id="rp_imei" type="text"/>
</div>
<div class="form-field">
<label>Tipo guasto</label>
<input id="rp_tipo_guasto" type="text"/>
</div>
<div class="form-field">
<label>Stato</label>
<select id="rp_stato">
<option value="">Seleziona</option>
<option value="Aperta">Aperta</option>
<option value="In lavorazione">In lavorazione</option>
<option value="Chiusa">Chiusa</option>
</select>
</div>
<div class="form-field">
<label>Costo previsto ‚Ç¨</label>
<input id="rp_costo_previsto" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Costo effettivo ‚Ç¨</label>
<input id="rp_costo_effettivo" step="0.01" type="number"/>
</div>
<div class="form-field">
<label>Data chiusura</label>
<input id="rp_data_chiusura" type="date"/>
</div>
<div class="form-field" style="grid-column: span 2;">
<label>Note</label>
<input id="rp_note" type="text"/>
</div>
</div>
<div class="form-actions">
<button class="btn-primary" type="submit">
                      Salva riparazione
                    </button>
</div>
</div>
</form>
</div>
</section>
<!-- IMPORT CSV -->
<section class="section" id="sec-import">
    <!-- ====== MAPPING CSV COMPLETO ====== -->
<div id="csv-mapping" class="card" style="margin-top:20px; display:none;">
  
  <div class="card-header">
    <div class="card-title">
      Mappatura colonne CSV
    </div>
    <div class="card-subtitle">
      Associa ogni campo del CRM alla colonna corretta del tuo CSV.
    </div>
  </div>

  <div class="card-body">

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Campo CRM</th>
          <th>Colonna CSV</th>
        </tr>
      </thead>
      <tbody id="mapping-container"></tbody>
    </table>

    <button class="btn-primary" style="margin-top:10px;" onclick="confirmCsvMapping()">
      Salva Mappatura
    </button>

  </div>
</div>

<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Import CSV clienti + contratti
                </div>
<div class="card-subtitle">
                  Incolla i dati con intestazioni come:
                  Nome, Cognome, Telefono, Email, Codice fiscale, Data nascita, Note,
                  Data contratto, Tipo cliente, Tipo attivazione, Tecnologia, Compagnia,
                  Convergenza, MNP, ICCID vecchio, ICCID nuovo, Data attivazione,
                  Data portabilit√†, Numero lavorato, Nome offerta, Costo offerta,
                  Vincolo offerta (mesi), Telefono incluso, IMEI, Modello, Tipo pagamento,
                  Mesi vincolo telefono, Data fine vincolo offerta, Data fine vincolo telefono.
                </div><div class="file-upload-block" style="margin-top:10px;"><label for="importFile">Carica file CSV:</label><input accept=".csv" id="importFile" onchange="importCsvFile(event)" type="file"/></div>
</div>
<div class="section-body">
<div class="form-field">
<label>Dati CSV (incolla qui, inclusa la riga di intestazione)</label>
<textarea id="csvRaw" placeholder="Incolla qui..." rows="6"></textarea>
</div>
<div class="form-actions">
<button class="btn-outline" onclick="previewImport()" type="button">
                    Anteprima
                  </button>
<button class="btn-primary" onclick="runImport()" type="button">
                    Importa
                  </button>
</div>
<div id="importSummary" style="font-size:12px;color:var(--text-soft);margin-top:4px;">
                  Nessuna importazione eseguita.
                </div>
<div class="progress-bar-container">
<div class="progress-bar" id="importProgress"></div>
</div>
<div class="table-wrapper" style="max-height:200px;margin-top:8px;">
<table>
<thead>
<tr>
<th>#</th>
<th>Nome</th>
<th>Cognome</th>
<th>Telefono</th>
<th>Codice fiscale</th>
<th>Data contratto</th>
<th>Compagnia</th>
<th>Tecnologia</th>
<th>Numero</th>
<th>Offerta</th>
</tr>
</thead>
<tbody id="csvPreviewBody"></tbody>
</table>
</div>
</div>
</div>
</section>
<!-- REPORT & SCADENZE -->
<section class="section" id="sec-report">
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                  Report &amp; Scadenze
                </div>
<div class="card-subtitle">
                  Compleanni, contratti per compagnia/tecnologia e scadenze vincoli.
                </div>
</div>
<div class="section-body">
<!-- COMPLEANNI OGGI -->
<div class="badge-soft">Compleanni di oggi</div>
<div class="table-wrapper" style="max-height:110px;">
<table>
<thead>
<tr>
<th>Nome</th>
<th>Telefono</th>
<th>Codice fiscale</th>
<th>Data nascita</th>
</tr>
</thead>
<tbody id="tabCompleanni"></tbody>
</table>
</div>
<!-- FILTRO CONTRATTI -->
<div class="badge-soft" style="margin-top:6px;">
                  Contratti per compagnia / tecnologia
                </div>
<div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
<div class="form-field">
<label>Compagnia</label>
<select id="rep_compagnia">
<option value="">Tutte</option>
</select>
</div>
<div class="form-field">
<label>Tecnologia</label>
<select id="rep_tecnologia">
<option value="">Tutte</option>
</select>
</div>
<div class="form-field">
<label>¬†</label>
<button class="btn-outline" onclick="applyContrattiFiltro()" type="button">
                      Applica filtro
                    </button>
</div>
</div>
<div class="table-wrapper" style="max-height:120px;">
<table>
<thead>
<tr>
<th>Cliente</th>
<th>CF</th>
<th>Compagnia</th>
<th>Tecnologia</th>
<th>Numero</th>
</tr>
</thead>
<tbody id="tabContrattiFiltro"></tbody>
</table>
</div>
<!-- SCADENZE VINCOLI -->
<div class="badge-soft" style="margin-top:6px;">
                  Scadenze vincoli offerta (mese/anno)
                </div>
<div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
<div class="form-field">
<label>Mese</label>
<select id="rep_mese">
<option value="">Seleziona</option>
<option value="01">01</option>
<option value="02">02</option>
<option value="03">03</option>
<option value="04">04</option>
<option value="05">05</option>
<option value="06">06</option>
<option value="07">07</option>
<option value="08">08</option>
<option value="09">09</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
</select>
</div>
<div class="form-field">
<label>Anno</label>
<select id="rep_anno">
<option value="">Seleziona</option>
<option value="2023">2023</option>
<option value="2024">2024</option>
<option value="2025">2025</option>
<option value="2026">2026</option>
<option value="2027">2027</option>
</select>
</div>
<div class="form-field">
<label>¬†</label>
<button class="btn-outline" onclick="applyScadenzeFiltro()" type="button">
                      Mostra scadenze
                    </button>
</div>
</div>
<div class="table-wrapper" style="max-height:140px;">
<table>
<thead>
<tr>
<th>Cliente</th>
<th>CF</th>
<th>Compagnia</th>
<th>Offerta</th>
<th>Fine vincolo</th>
</tr>
</thead>
<tbody id="tabScadenze"></tbody>
</table>
</div>
<!-- ESPORTA CSV PER PERIODO -->
<div class="badge-soft" style="margin-top:6px;">
                  Esporta CSV contratti per periodo (Data contratto)
                </div>
<div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
<div class="form-field">
<label>Dal</label>
<input id="rep_exp_da" type="date"/>
</div>
<div class="form-field">
<label>Al</label>
<input id="rep_exp_a" type="date"/>
</div>
<div class="form-field">
<label>¬†</label>
<button class="btn-outline" onclick="exportContrattiPeriodo()" type="button">
                      Esporta CSV
                    </button>
</div>
</div>
</div>
</div>
</section>
</div> <!-- fine left-column -->
<!-- COLONNA DESTRA: CLIENTI & NEWS -->
<div class="right-column">
<section class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                Clienti &amp; storico
              </div>
<div class="card-subtitle">
                Seleziona un cliente per vedere contratti, device e riparazioni.
              </div>
</div>
<div class="form-field" style="margin-bottom:6px;">
<label>Ricerca cliente</label>
<input id="searchClienteTerm" placeholder="Nome, cognome, CF o telefono" type="text"/>
</div>
<div class="table-wrapper" style="max-height:170px;margin-bottom:6px;">
<table>
<thead>
<tr>
<th>Nome</th>
<th>Cognome</th>
<th>Telefono</th>
<th>CF</th>
</tr>
</thead>
<tbody id="tabClienti"></tbody>
</table>
</div>
<div id="noClienteSelezionato" style="font-size:12px;color:var(--text-soft);">
              Seleziona un cliente per vedere i dettagli.
            </div>
<div class="card hidden" id="clienteCard" style="margin-top:6px;padding:8px;">
<div class="card-header" style="margin-bottom:4px;">
<div class="card-title">
<span class="card-title-dot"></span> Anagrafica cliente
                </div>
</div>
<div class="cliente-summary">
<div class="cliente-summary-row">
<div class="cliente-summary-label">Nome</div>
<div id="detNome"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Cognome</div>
<div id="detCognome"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Telefono</div>
<div id="detTelefono"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Email</div>
<div id="detEmail"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Cod. fiscale</div>
<div id="detCF"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Data nascita</div>
<div id="detNascita"></div>
</div>
<div class="cliente-summary-row">
<div class="cliente-summary-label">Note</div>
<div id="detNote"></div>
</div>
</div>
<div class="form-actions" style="justify-content:flex-start;margin-top:6px;">
<button class="btn-outline" onclick="openEditCliente()" type="button">
                  Modifica cliente
                </button>
<button class="btn-outline" onclick="openWhatsappForSelected()" type="button">
                  Apri WhatsApp
                </button>
<button class="btn-outline" onclick="exportClientePDF()" type="button">
                  Esporta PDF
                </button>
</div>
<div class="section-body hidden" id="editClienteForm" style="margin-top:4px;">
<div class="form-grid">
<div class="form-field">
<label>Nome</label>
<input id="ec_nome" type="text"/>
</div>
<div class="form-field">
<label>Cognome</label>
<input id="ec_cognome" type="text"/>
</div>
<div class="form-field">
<label>Telefono</label>
<input id="ec_telefono" type="text"/>
</div>
<div class="form-field">
<label>Email</label>
<input id="ec_email" type="email"/>
</div>
<div class="form-field">
<label>Codice fiscale</label>
<input id="ec_cf" type="text"/>
</div>
<div class="form-field">
<label>Data nascita</label>
<input id="ec_data_nascita" type="date"/>
</div>
<div class="form-field" style="grid-column: span 2;">
<label>Note</label>
<input id="ec_note" type="text"/>
</div>
</div>
<div class="form-actions" style="margin-top:4px;">
<button class="btn-outline" onclick="cancelEditCliente()" type="button">
                    Annulla
                  </button>
<button class="btn-primary" onclick="saveEditCliente()" type="button">
                    Salva modifiche
                  </button>
</div>
</div>
<!-- STORICO CONTRATTI -->
<div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico contratti (clicca per modificare)
              </div>
<div class="table-wrapper" style="max-height:100px;margin-top:2px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>Compagnia</th>
<th>Tecnologia</th>
<th>Numero</th>
</tr>
</thead>
<tbody id="tabContrattiCliente"></tbody>
</table>
</div>
<!-- STORICO DEVICE -->
<div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico device
              </div>
<div class="table-wrapper" style="max-height:80px;margin-top:2px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>Modello</th>
<th>IMEI</th>
</tr>
</thead>
<tbody id="tabDeviceCliente"></tbody>
</table>
</div>
<!-- STORICO RIPARAZIONI -->
<div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico riparazioni
              </div>
<div class="table-wrapper" style="max-height:80px;margin-top:2px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>Modello</th>
<th>Guasto</th>
</tr>
</thead>
<tbody id="tabRiparazioniCliente"></tbody>
</table>
</div>
</div>
</section>
<section class="card">
<div class="card-header">
<div class="card-title">
<span class="card-title-dot"></span>
                News TELCO
              </div>
<div class="card-subtitle">
                Notizie da MondoMobileWeb
              </div>
</div>
<div class="news-frame">
<iframe src="https://www.mondomobileweb.it/"></iframe>
</div>
</section>
</div> <!-- right-column -->
</div> <!-- content -->
</main>
</div> <!-- layout -->
<div id="toastContainer"></div>
<script>
    // URL Web App (Apps Script)
    const API_BASE =
      'https://script.google.com/macros/s/AKfycbwwZN7PpcPVjemEF9e7iU607Z3yHZgDWj-UYbv5yfsRg4rudlcZdNAEDh4suKNj0SfX/exec';

    let clientiCache = [];
    let contrattiCache = [];
    let deviceCache = [];
    let riparazioniCache = [];
    let selectedCliente = null;
    let importRows = [];
    let editingContratto = null; // se non null -> stai modificando un contratto

    async function apiGet(action) {
      const url = API_BASE + '?action=' + encodeURIComponent(action);
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error('Errore rete GET ' + action + ' (status ' + res.status + ')');
      }
      const json = await res.json();
      if (!json.success) {
        throw new Error(json.error || 'Errore logico GET ' + action);
      }
      return json;
    }

    async function apiPost(action, payload) {
      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(Object.assign({ action: action }, payload))
        });
        if (!res.ok) {
          throw new Error(
            'Errore rete POST ' + action + ' (status ' + res.status + ')'
          );
        }
        const json = await res.json();
        if (!json.success) {
          throw new Error(json.error || 'Errore logico POST ' + action);
        }
        return json;
      } catch (err) {
        throw new Error(
          'Network error POST ' + action + ': ' + (err.message || String(err))
        );
      }
    }

    function showToast(message, type) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const div = document.createElement('div');
      div.className = 'toast ' + (type || 'info');
      div.textContent = message;
      container.appendChild(div);
      setTimeout(function () {
        if (div.parentNode) div.parentNode.removeChild(div);
      }, 4000);
    }

    function switchSection(sectionId) {
      document.querySelectorAll('.section').forEach(function (sec) {
        sec.classList.remove('active');
      });
      const target = document.getElementById(sectionId);
      if (target) target.classList.add('active');

      document.querySelectorAll('.nav-btn').forEach(function (btn) {
        btn.classList.remove('active');
        const dt = btn.getAttribute('data-target');
        if (dt === sectionId) {
          btn.classList.add('active');
        }
      });
    }

    function normalizeDate(value) {
      if (!value) return '';
      let d = value;
      if (!(d instanceof Date)) {
        d = new Date(value);
      }
      if (isNaN(d.getTime())) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }

    function formatDateDisplay(value) {
      const norm = normalizeDate(value);
      if (!norm) return '';
      const parts = norm.split('-');
      return parts[2] + '/' + parts[1] + '/' + parts[0];
    }

    function birthDateFromCF(cf) {
      if (!cf) return '';
      cf = String(cf).toUpperCase();
      if (cf.length < 11) return '';
      const yearPart = cf.slice(6, 8);
      const monthCode = cf.charAt(8);
      const dayPart = cf.slice(9, 11);

      const months = {
        A: 1,
        B: 2,
        C: 3,
        D: 4,
        E: 5,
        H: 6,
        L: 7,
        M: 8,
        P: 9,
        R: 10,
        S: 11,
        T: 12
      };
      const m = months[monthCode] || null;
      if (!m) return '';

      let day = parseInt(dayPart, 10);
      if (isNaN(day)) return '';
      if (day > 40) day -= 40;

      const nowYear = new Date().getFullYear();
      let y = parseInt(yearPart, 10);
      if (isNaN(y)) return '';
      let fullYear = 1900 + y;
      if (fullYear + 100 <= nowYear) {
        fullYear += 100;
      }

      const mm = String(m).padStart(2, '0');
      const dd = String(day).padStart(2, '0');
      return fullYear + '-' + mm + '-' + dd;
    }

    function addMonthsToDate(startValue, months) {
      if (!startValue || !months) return '';
      let d = startValue instanceof Date ? new Date(startValue) : new Date(startValue);
      if (isNaN(d.getTime())) return '';
      const m = d.getMonth() + months;
      d.setMonth(m);
      return normalizeDate(d);
    }

    function openWhatsappForSelected() {
      if (!selectedCliente) {
        showToast('Nessun cliente selezionato', 'error');
        return;
      }
      const cf = selectedCliente.codice_fiscale || '';
      openWhatsappByCF(cf, 'Ciao ' + (selectedCliente.nome || '') + ', ');
    }

    function openWhatsappByCF(cf, message) {
      if (!cf) {
        showToast('Codice fiscale non disponibile', 'error');
        return;
      }
      const cfUp = String(cf).toUpperCase();
      const cli = clientiCache.find(function (c) {
        return String(c.codice_fiscale || '').toUpperCase() === cfUp;
      });
      if (!cli) {
        showToast('Cliente non trovato per WhatsApp', 'error');
        return;
      }
      const telRaw = cli.telefono ? String(cli.telefono) : '';
      const tel = telRaw.replace(/[^0-9]/g, '');
      if (!tel) {
        showToast('Telefono non disponibile', 'error');
        return;
      }
      const msg = message || 'Ciao ' + (cli.nome || '') + ', ';
      const url = 'https://wa.me/39' + tel + '?text=' + encodeURIComponent(msg);
      window.open(url, '_blank');
    }

    function exportClientePDF() {
      if (!selectedCliente) {
        showToast('Nessun cliente selezionato', 'error');
        return;
      }

      const cfCliente = String(selectedCliente.codice_fiscale || '').toUpperCase();

      const contratti = contrattiCache.filter(function (ct) {
        return String(ct.codice_fiscale || '').toUpperCase() === cfCliente;
      });
      const device = deviceCache.filter(function (dv) {
        return String(dv.codice_fiscale || '').toUpperCase() === cfCliente;
      });
      const riparazioni = riparazioniCache.filter(function (rp) {
        return String(rp.codice_fiscale || '').toUpperCase() === cfCliente;
      });

      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8" />
          <title>Riepilogo cliente ${selectedCliente.nome || ''} ${selectedCliente.cognome || ''}</title>
          <style>
            body { font-family: system-ui, sans-serif; font-size: 12px; margin: 16px; }
            h1 { font-size: 18px; margin-bottom: 4px; }
            h2 { font-size: 14px; margin-top: 12px; margin-bottom: 4px; }
            table { border-collapse: collapse; width: 100%; margin-top: 4px; }
            th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
            th { background: #f3f4f6; }
          </style>
        </head>
        <body>
          <h1>Riepilogo cliente</h1>
          <p><strong>Nome:</strong> ${selectedCliente.nome || ''}</p>
          <p><strong>Cognome:</strong> ${selectedCliente.cognome || ''}</p>
          <p><strong>Telefono:</strong> ${selectedCliente.telefono || ''}</p>
          <p><strong>Email:</strong> ${selectedCliente.email || ''}</p>
          <p><strong>Codice fiscale:</strong> ${selectedCliente.codice_fiscale || ''}</p>
          <p><strong>Data nascita:</strong> ${document.getElementById('detNascita').textContent || ''}</p>
          <p><strong>Note:</strong> ${selectedCliente.note || ''}</p>

          <h2>Contratti</h2>
          <table>
            <thead>
              <tr>
                <th>Data contratto</th>
                <th>Compagnia</th>
                <th>Tecnologia</th>
                <th>Numero</th>
                <th>Offerta</th>
                <th>Fine vincolo</th>
              </tr>
            </thead>
            <tbody>`;

      contratti.forEach(function (ct) {
        html += `
          <tr>
            <td>${formatDateDisplay(ct.data_contratto)}</td>
            <td>${ct.compagnia || ''}</td>
            <td>${ct.tecnologia || ''}</td>
            <td>${ct.numero_lavorato || ''}</td>
            <td>${ct.nome_offerta || ''}</td>
            <td>${formatDateDisplay(ct.data_fine_vincolo_offerta)}</td>
          </tr>`;
      });

      html += `
            </tbody>
          </table>

          <h2>Device</h2>
          <table>
            <thead>
              <tr>
                <th>Data vendita</th>
                <th>Modello</th>
                <th>IMEI</th>
                <th>Prezzo</th>
              </tr>
            </thead>
            <tbody>`;

      device.forEach(function (dv) {
        html += `
          <tr>
            <td>${formatDateDisplay(dv.data_vendita)}</td>
            <td>${dv.modello || ''}</td>
            <td>${dv.imei || ''}</td>
            <td>${dv.prezzo || ''}</td>
          </tr>`;
      });

      html += `
            </tbody>
          </table>

          <h2>Riparazioni</h2>
          <table>
            <thead>
              <tr>
                <th>Data apertura</th>
                <th>Modello</th>
                <th>Guasto</th>
                <th>Stato</th>
              </tr>
            </thead>
            <tbody>`;

      riparazioni.forEach(function (rp) {
        html += `
          <tr>
            <td>${formatDateDisplay(rp.data_apertura)}</td>
            <td>${rp.modello || ''}</td>
            <td>${rp.tipo_guasto || ''}</td>
            <td>${rp.stato || ''}</td>
          </tr>`;
      });

      html += `
            </tbody>
          </table>
        </body>
        </html>
      `;

      const win = window.open('', '_blank');
      win.document.write(html);
      win.document.close();
      win.focus();
      win.print();
    }

    function openEditCliente() {
      if (!selectedCliente) {
        showToast('Nessun cliente selezionato', 'error');
        return;
      }
      const form = document.getElementById('editClienteForm');
      if (!form) return;
      form.classList.remove('hidden');

      document.getElementById('ec_nome').value = selectedCliente.nome || '';
      document.getElementById('ec_cognome').value = selectedCliente.cognome || '';
      document.getElementById('ec_telefono').value = selectedCliente.telefono || '';
      document.getElementById('ec_email').value = selectedCliente.email || '';
      document.getElementById('ec_cf').value = (selectedCliente.codice_fiscale || '').toUpperCase();

      let nascita = '';
      if (selectedCliente.data_nascita) {
        nascita = normalizeDate(selectedCliente.data_nascita);
      } else {
        nascita = birthDateFromCF(selectedCliente.codice_fiscale) || '';
      }
      document.getElementById('ec_data_nascita').value = nascita || '';
      document.getElementById('ec_note').value = selectedCliente.note || '';
    }

    function cancelEditCliente() {
      const form = document.getElementById('editClienteForm');
      if (form) form.classList.add('hidden');
    }

    async function saveEditCliente() {
      try {
        if (!selectedCliente) {
          showToast('Nessun cliente selezionato', 'error');
          return;
        }
        const payload = {
          id_cliente: selectedCliente.id_cliente,
          nome: document.getElementById('ec_nome').value.trim(),
          cognome: document.getElementById('ec_cognome').value.trim(),
          telefono: document.getElementById('ec_telefono').value.trim(),
          email: document.getElementById('ec_email').value.trim(),
          codice_fiscale: document
            .getElementById('ec_cf')
            .value.trim()
            .toUpperCase(),
          data_nascita: document.getElementById('ec_data_nascita').value,
          note: document.getElementById('ec_note').value.trim()
        };

        await apiPost('updateCliente', payload);
        showToast('Cliente aggiornato correttamente', 'success');

        const idx = clientiCache.findIndex(function (c) {
          return c.id_cliente === selectedCliente.id_cliente;
        });
        if (idx !== -1) {
          clientiCache[idx] = Object.assign({}, clientiCache[idx], payload);
          selectedCliente = clientiCache[idx];
        }
        selectCliente(selectedCliente);
        renderListaClienti(
          document.getElementById('searchClienteTerm').value || ''
        );
        cancelEditCliente();
      } catch (err) {
        console.error(err);
        const msg = err && err.message ? err.message : String(err);
        showToast('Errore aggiornamento cliente: ' + msg, 'error');
      }
    }

    function renderListaClienti(term) {
      term = (term || '').toLowerCase();
      const tbody = document.getElementById('tabClienti');
      if (!tbody) return;
      tbody.innerHTML = '';

      clientiCache.forEach(function (c) {
        const chiave =
          (c.nome || '') +
          ' ' +
          (c.cognome || '') +
          ' ' +
          (c.codice_fiscale || '') +
          ' ' +
          (c.telefono || '');
        if (term && chiave.toLowerCase().indexOf(term) === -1) return;

        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          (c.nome || '') +
          '</td>' +
          '<td>' +
          (c.cognome || '') +
          '</td>' +
          '<td>' +
          (c.telefono || '') +
          '</td>' +
          '<td>' +
          (c.codice_fiscale || '') +
          '</td>';
        tr.addEventListener('click', function () {
          selectCliente(c);
        });
        tbody.appendChild(tr);
      });
    }

    function selectCliente(c) {
      selectedCliente = c;
      const noSel = document.getElementById('noClienteSelezionato');
      if (noSel) noSel.style.display = 'none';
      const card = document.getElementById('clienteCard');
      if (card) card.classList.remove('hidden');

      document.getElementById('detNome').textContent = c.nome || '';
      document.getElementById('detCognome').textContent = c.cognome || '';
      document.getElementById('detTelefono').textContent = c.telefono || '';
      document.getElementById('detEmail').textContent = c.email || '';
      document.getElementById('detCF').textContent = c.codice_fiscale || '';

      let nasc = '';
      if (c.data_nascita) {
        nasc = formatDateDisplay(c.data_nascita);
      } else {
        const fromCF = birthDateFromCF(c.codice_fiscale);
        nasc = fromCF ? formatDateDisplay(fromCF) : '';
      }
      document.getElementById('detNascita').textContent = nasc;
      document.getElementById('detNote').textContent = c.note || '';

      const editForm = document.getElementById('editClienteForm');
      if (editForm) editForm.classList.add('hidden');

      renderStoricoCliente(c);
    }

    function renderStoricoCliente(c) {
      const cfCliente = String(c.codice_fiscale || '').toUpperCase();
      const tabCt = document.getElementById('tabContrattiCliente');
      const tabDv = document.getElementById('tabDeviceCliente');
      const tabRp = document.getElementById('tabRiparazioniCliente');
      if (tabCt) tabCt.innerHTML = '';
      if (tabDv) tabDv.innerHTML = '';
      if (tabRp) tabRp.innerHTML = '';

      // Contratti
      contrattiCache.forEach(function (ct) {
        const cfCt = String(ct.codice_fiscale || '').toUpperCase();
        if (!cfCt || cfCt !== cfCliente) return;
        const data =
          ct.data_contratto ||
          ct.data_attivazione ||
          ct.data_fine_vincolo_offerta ||
          '';
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          formatDateDisplay(data) +
          '</td>' +
          '<td>' +
          (ct.compagnia || '') +
          '</td>' +
          '<td>' +
          (ct.tecnologia || '') +
          '</td>' +
          '<td>' +
          (ct.numero_lavorato || '') +
          '</td>';

        tr.addEventListener('click', function () {
          startEditContratto(ct);
        });

        if (tabCt) tabCt.appendChild(tr);
      });

      // Device
      deviceCache.forEach(function (dv) {
        const cfDv = String(dv.codice_fiscale || '').toUpperCase();
        if (!cfDv || cfDv !== cfCliente) return;
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          formatDateDisplay(dv.data_vendita) +
          '</td>' +
          '<td>' +
          (dv.modello || '') +
          '</td>' +
          '<td>' +
          (dv.imei || '') +
          '</td>';
        if (tabDv) tabDv.appendChild(tr);
      });

      // Riparazioni
      riparazioniCache.forEach(function (rp) {
        const cfRp = String(rp.codice_fiscale || '').toUpperCase();
        if (!cfRp || cfRp !== cfCliente) return;
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          formatDateDisplay(rp.data_apertura) +
          '</td>' +
          '<td>' +
          (rp.modello || '') +
          '</td>' +
          '<td>' +
          (rp.tipo_guasto || '') +
          '</td>';
        if (tabRp) tabRp.appendChild(tr);
      });
    }

    function startEditContratto(ct) {
      editingContratto = ct;

      switchSection('sec-nuovo');
      showToast('Modalit√† modifica contratto attiva', 'info');

      const cf = String(ct.codice_fiscale || '').toUpperCase();
      const cli = clientiCache.find(function (c) {
        return String(c.codice_fiscale || '').toUpperCase() === cf;
      });

      document.getElementById('nc_nome_cliente').value = cli ? cli.nome || '' : '';
      document.getElementById('nc_cognome_cliente').value = cli
        ? cli.cognome || ''
        : '';
      document.getElementById('nc_telefono_cliente').value = cli
        ? cli.telefono || ''
        : '';
      document.getElementById('nc_email_cliente').value = cli
        ? cli.email || ''
        : '';
      document.getElementById('nc_cf_cliente').value = cf;

      let nascita = '';
      if (cli && cli.data_nascita) {
        nascita = normalizeDate(cli.data_nascita);
      } else if (cli && cli.codice_fiscale) {
        nascita = birthDateFromCF(cli.codice_fiscale) || '';
      }
      document.getElementById('nc_data_nascita_cliente').value = nascita || '';
      document.getElementById('nc_note_cliente').value = cli ? cli.note || '' : '';

      document.getElementById('nc_data_contratto').value = normalizeDate(
        ct.data_contratto
      );
      document.getElementById('nc_tipo_cliente').value = ct.tipo_cliente || '';
      document.getElementById('nc_tipo_attivazione').value =
        ct.tipo_attivazione || '';
      document.getElementById('nc_tecnologia').value = ct.tecnologia || '';
      document.getElementById('nc_compagnia').value = ct.compagnia || '';
      document.getElementById('nc_convergenza').value = ct.convergenza || '';
      document.getElementById('nc_mnp').value = ct.mnp || '';
      document.getElementById('nc_iccid_vecchio').value = ct.iccid_vecchio || '';
      document.getElementById('nc_iccid_nuovo').value = ct.iccid_nuovo || '';
      document.getElementById('nc_data_attivazione').value = normalizeDate(
        ct.data_attivazione
      );
      document.getElementById('nc_data_portabilita').value = normalizeDate(
        ct.data_portabilita
      );
      document.getElementById('nc_numero_lavorato').value =
        ct.numero_lavorato || '';
      document.getElementById('nc_nome_offerta').value = ct.nome_offerta || '';
      document.getElementById('nc_costo_offerta').value = ct.costo_offerta || '';
      document.getElementById('nc_vincolo_offerta_mesi').value =
        ct.vincolo_offerta_mesi || '';
      document.getElementById('nc_telefono_incluso').value =
        ct.telefono_incluso || '';
      document.getElementById('nc_imei').value = ct.imei || '';
      document.getElementById('nc_modello').value = ct.modello || '';
      document.getElementById('nc_tipo_pagamento').value = ct.tipo_pagamento || '';
      document.getElementById('nc_mesi_vincolo_telefono').value =
        ct.mesi_vincolo_telefono || '';
      document.getElementById('nc_data_fine_vincolo_offerta').value = normalizeDate(
        ct.data_fine_vincolo_offerta
      );
      document.getElementById('nc_data_fine_vincolo_telefono').value =
        normalizeDate(ct.data_fine_vincolo_telefono);

      const lbl = document.getElementById('nc_submit_label');
      if (lbl) lbl.textContent = 'Salva modifiche contratto';
    }

    function updateDashboardKpis() {
      const elCli = document.getElementById('kpiTotClienti');
      const elCt = document.getElementById('kpiTotContratti');
      const elDv = document.getElementById('kpiTotDevice');
      const elRp = document.getElementById('kpiTotRiparazioni');
      const elCompl = document.getElementById('kpiCompleanniOggi');
      const elScad = document.getElementById('kpiScadenzeMese');

      if (elCli) elCli.textContent = clientiCache.length;
      if (elCt) elCt.textContent = contrattiCache.length;
      if (elDv) elDv.textContent = deviceCache.length;
      if (elRp) elRp.textContent = riparazioniCache.length;

      const today = normalizeDate(new Date());
      const todayMD = today ? today.slice(5) : '';
      let countBday = 0;
      clientiCache.forEach(function (c) {
        let dn = '';
        if (c.data_nascita) {
          dn = normalizeDate(c.data_nascita);
        } else {
          dn = birthDateFromCF(c.codice_fiscale);
        }
        if (!dn) return;
        if (dn.slice(5) === todayMD) countBday++;
      });
      if (elCompl) elCompl.textContent = countBday;

      const meseCorr = today ? today.slice(0, 7) : '';
      let countScad = 0;
      contrattiCache.forEach(function (ct) {
        const df = normalizeDate(ct.data_fine_vincolo_offerta);
        if (!df) return;
        if (df.slice(0, 7) === meseCorr) countScad++;
      });
      if (elScad) elScad.textContent = countScad;
    }

    function renderCompleanniOggi() {
      const tbody = document.getElementById('tabCompleanni');
      if (!tbody) return;
      tbody.innerHTML = '';
      const today = normalizeDate(new Date());
      const todayMD = today ? today.slice(5) : '';

      clientiCache.forEach(function (c) {
        let dn = '';
        if (c.data_nascita) {
          dn = normalizeDate(c.data_nascita);
        } else {
          dn = birthDateFromCF(c.codice_fiscale);
        }
        if (!dn) return;
        if (dn.slice(5) !== todayMD) return;
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          (c.nome || '') +
          ' ' +
          (c.cognome || '') +
          '</td>' +
          '<td>' +
          (c.telefono || '') +
          '</td>' +
          '<td>' +
          (c.codice_fiscale || '') +
          '</td>' +
          '<td>' +
          formatDateDisplay(dn) +
          '</td>';
        tbody.appendChild(tr);
      });
    }

    function updateReportFilters() {
      const selComp = document.getElementById('rep_compagnia');
      const selTec = document.getElementById('rep_tecnologia');
      if (!selComp || !selTec) return;

      const compSet = new Set();
      const tecSet = new Set();

      contrattiCache.forEach(function (ct) {
        if (ct.compagnia) compSet.add(String(ct.compagnia));
        if (ct.tecnologia) tecSet.add(String(ct.tecnologia));
      });

      selComp.innerHTML = '<option value="">Tutte</option>';
      Array.from(compSet)
        .sort()
        .forEach(function (v) {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          selComp.appendChild(opt);
        });

      selTec.innerHTML = '<option value="">Tutte</option>';
      Array.from(tecSet)
        .sort()
        .forEach(function (v) {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          selTec.appendChild(opt);
        });
    }

    function renderContrattiFiltro(compagnia, tecnologia) {
      const tbody = document.getElementById('tabContrattiFiltro');
      if (!tbody) return;
      tbody.innerHTML = '';

      const clientiByCF = {};
      clientiCache.forEach(function (c) {
        if (c.codice_fiscale) {
          clientiByCF[String(c.codice_fiscale).toUpperCase()] = c;
        }
      });

      contrattiCache.forEach(function (ct) {
        const comp =
          (ct.compagnia || '').toString().trim().toUpperCase();
        const tec =
          (ct.tecnologia || '').toString().trim().toUpperCase();
        if (compagnia && comp !== compagnia.toUpperCase()) return;
        if (tecnologia && tec !== tecnologia.toUpperCase()) return;

        const cf = String(ct.codice_fiscale || '').toUpperCase();
        const cli = clientiByCF[cf];
        const nomeCli = cli ? (cli.nome || '') + ' ' + (cli.cognome || '') : '';

        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          nomeCli +
          '</td>' +
          '<td>' +
          cf +
          '</td>' +
          '<td>' +
          (ct.compagnia || '') +
          '</td>' +
          '<td>' +
          (ct.tecnologia || '') +
          '</td>' +
          '<td>' +
          (ct.numero_lavorato || '') +
          '</td>';

        tr.addEventListener('click', function () {
          if (cli) {
            selectCliente(cli);
          } else {
            showToast('Cliente non trovato in anagrafica', 'error');
          }
        });

        tbody.appendChild(tr);
      });
    }

    function renderScadenze(meseStr) {
      const tbody = document.getElementById('tabScadenze');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!meseStr) return;

      const clientiByCF = {};
      clientiCache.forEach(function (c) {
        if (c.codice_fiscale) {
          clientiByCF[String(c.codice_fiscale).toUpperCase()] = c;
        }
      });

      contrattiCache.forEach(function (ct) {
        const df = normalizeDate(ct.data_fine_vincolo_offerta);
        if (!df) return;
        if (df.slice(0, 7) !== meseStr) return;

        const cf = String(ct.codice_fiscale || '').toUpperCase();
        const cli = clientiByCF[cf];
        const nomeCli = cli ? (cli.nome || '') + ' ' + (cli.cognome || '') : '';

        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          nomeCli +
          '</td>' +
          '<td>' +
          cf +
          '</td>' +
          '<td>' +
          (ct.compagnia || '') +
          '</td>' +
          '<td>' +
          (ct.nome_offerta || '') +
          '</td>' +
          '<td>' +
          formatDateDisplay(df) +
          '</td>';

        tr.addEventListener('click', function () {
          if (cli) {
            selectCliente(cli);
          } else {
            showToast('Cliente non trovato in anagrafica', 'error');
          }
        });

        tbody.appendChild(tr);
      });
    }

    function applyContrattiFiltro() {
      const compSel = document.getElementById('rep_compagnia').value || '';
      const tecSel = document.getElementById('rep_tecnologia').value || '';
      renderContrattiFiltro(compSel, tecSel);
    }

    function applyScadenzeFiltro() {
      const m = document.getElementById('rep_mese').value;
      const y = document.getElementById('rep_anno').value;
      if (!m || !y) {
        showToast('Seleziona mese e anno', 'error');
        return;
      }
      const meseStr = y + '-' + m;
      renderScadenze(meseStr);
    }

    function exportContrattiPeriodo() {
      const da = document.getElementById('rep_exp_da').value;
      const a = document.getElementById('rep_exp_a').value;
      if (!da || !a) {
        showToast('Seleziona data iniziale e finale', 'error');
        return;
      }

      const daNorm = normalizeDate(da);
      const aNorm = normalizeDate(a);
      if (!daNorm || !aNorm) {
        showToast('Date non valide', 'error');
        return;
      }

      const clientiByCF = {};
      clientiCache.forEach(function (c) {
        if (c.codice_fiscale) {
          clientiByCF[String(c.codice_fiscale).toUpperCase()] = c;
        }
      });

      const header = [
        'Nome',
        'Cognome',
        'Telefono',
        'Email',
        'Codice fiscale',
        'Data nascita',
        'Note',
        'Data contratto',
        'Tipo cliente',
        'Tipo attivazione',
        'Tecnologia',
        'Compagnia',
        'Convergenza',
        'MNP',
        'ICCID vecchio',
        'ICCID nuovo',
        'Data attivazione',
        'Data portabilit√†',
        'Numero lavorato',
        'Nome offerta',
        'Costo offerta',
        'Vincolo offerta (mesi)',
        'Telefono incluso',
        'IMEI',
        'Modello',
        'Tipo pagamento',
        'Mesi vincolo telefono',
        'Data fine vincolo offerta',
        'Data fine vincolo telefono'
      ];

      const lines = [];
      lines.push(header.join(';'));

      contrattiCache.forEach(function (ct) {
        const dc = normalizeDate(ct.data_contratto);
        if (!dc) return;
        if (dc < daNorm || dc > aNorm) return;

        const cf = String(ct.codice_fiscale || '').toUpperCase();
        const cli = clientiByCF[cf];

        let dn = '';
        if (cli && cli.data_nascita) {
          dn = normalizeDate(cli.data_nascita);
        } else if (cli && cli.codice_fiscale) {
          const cfDn = birthDateFromCF(cli.codice_fiscale);
          dn = cfDn || '';
        }

        const row = [
          cli ? cli.nome || '' : '',
          cli ? cli.cognome || '' : '',
          cli ? cli.telefono || '' : '',
          cli ? cli.email || '' : '',
          cf,
          dn,
          cli ? cli.note || '' : '',
          dc,
          ct.tipo_cliente || '',
          ct.tipo_attivazione || '',
          ct.tecnologia || '',
          ct.compagnia || '',
          ct.convergenza || '',
          ct.mnp || '',
          ct.iccid_vecchio || '',
          ct.iccid_nuovo || '',
          normalizeDate(ct.data_attivazione),
          normalizeDate(ct.data_portabilita),
          ct.numero_lavorato || '',
          ct.nome_offerta || '',
          ct.costo_offerta || '',
          ct.vincolo_offerta_mesi || '',
          ct.telefono_incluso || '',
          ct.imei || '',
          ct.modello || '',
          ct.tipo_pagamento || '',
          ct.mesi_vincolo_telefono || '',
          normalizeDate(ct.data_fine_vincolo_offerta),
          normalizeDate(ct.data_fine_vincolo_telefono)
        ];

        lines.push(
          row
            .map(function (v) {
              const s = v == null ? '' : String(v);
              return s.replace(/;/g, ',');
            })
            .join(';')
        );
      });

      if (lines.length <= 1) {
        showToast('Nessun contratto trovato nel periodo selezionato', 'info');
        return;
      }

      const csvContent = lines.join('\n');
      const blob = new Blob([csvContent], {
        type: 'text/csv;charset=utf-8;'
      });
      const url = URL.createObjectURL(blob);
      const aEl = document.createElement('a');
      aEl.href = url;
      aEl.download = 'contratti_' + daNorm + '_al_' + aNorm + '.csv';
      document.body.appendChild(aEl);
      aEl.click();
      setTimeout(function () {
        URL.revokeObjectURL(url);
        aEl.remove();
      }, 0);

      showToast('CSV contratti esportato', 'success');
    }
    function ensureClienteByCF(cf, dati) {
      cf = (cf || '').toUpperCase();
      if (!cf) throw new Error('Codice fiscale mancante');
      const existing = clientiCache.find(function (c) {
        return String(c.codice_fiscale || '').toUpperCase() === cf;
      });
      if (existing) return Promise.resolve(existing.id_cliente);

      const payload = {
        nome: dati.nome || '',
        cognome: dati.cognome || '',
        telefono: dati.telefono || '',
        email: dati.email || '',
        codice_fiscale: cf,
        data_nascita: dati.data_nascita || '',
        note: dati.note || ''
      };
      return apiPost('createCliente', payload).then(function (res) {
        const id = res.id_cliente;
        clientiCache.push(
          Object.assign(
            {
              id_cliente: id
            },
            payload
          )
        );
        return id;
      });
    }

    function recalcContrattoFields() {
      recalcFineVincoli();
      recalcPortabilita();
    }

    function recalcFineVincoli() {
      const dataAtt = document.getElementById('nc_data_attivazione').value;
      const mesiOff = parseInt(
        document.getElementById('nc_vincolo_offerta_mesi').value || '0',
        10
      );
      const mesiTel = parseInt(
        document.getElementById('nc_mesi_vincolo_telefono').value || '0',
        10
      );

      if (dataAtt && mesiOff > 0) {
        const fineOff = addMonthsToDate(dataAtt, mesiOff);
        if (fineOff)
          document.getElementById('nc_data_fine_vincolo_offerta').value = fineOff;
      }
      if (dataAtt && mesiTel > 0) {
        const fineTel = addMonthsToDate(dataAtt, mesiTel);
        if (fineTel)
          document.getElementById('nc_data_fine_vincolo_telefono').value = fineTel;
      }
    }

    function recalcPortabilita() {
      const mnp = document.getElementById('nc_mnp').value || '';
      const dataAtt = document.getElementById('nc_data_attivazione').value || '';
      if (mnp === 'SI' && dataAtt) {
        document.getElementById('nc_data_portabilita').value = dataAtt;
      }
    }

    function parseImportText() {
      const raw = document.getElementById('csvRaw').value || '';
      const lines = raw
        .split(/\r?\n/)
        .map(function (l) {
          return l.trim();
        })
        .filter(function (l) {
          return l.length > 0;
        });
      if (lines.length < 2) return [];

      function splitLine(line) {
        if (line.indexOf('\t') !== -1) return line.split('\t');
        if (line.indexOf(';') !== -1) return line.split(';');
        return line.split(',');
      }

      const header = splitLine(lines[0]);
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = splitLine(lines[i]);
        const obj = {};
        header.forEach(function (h, idx) {
          obj[h.trim()] = cols[idx] || '';
        });
        rows.push(obj);
      }
      return rows;
    }

    function previewImport() {
      const rows = parseImportText();
      importRows = rows;
      const tbody = document.getElementById('csvPreviewBody');
      const summary = document.getElementById('importSummary');
      const bar = document.getElementById('importProgress');
      if (tbody) tbody.innerHTML = '';
      if (bar) bar.style.width = '0%';

      if (!rows.length) {
        if (summary)
          summary.textContent = 'Nessuna riga da importare (controlla il testo).';
        return;
      }

      rows.forEach(function (r, idx) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          (idx + 1) +
          '</td>' +
          '<td>' +
          (r['Nome'] || '') +
          '</td>' +
          '<td>' +
          (r['Cognome'] || '') +
          '</td>' +
          '<td>' +
          (r['Telefono'] || '') +
          '</td>' +
          '<td>' +
          (r['Codice fiscale'] || '') +
          '</td>' +
          '<td>' +
          (r['Data contratto'] || '') +
          '</td>' +
          '<td>' +
          (r['Compagnia'] || '') +
          '</td>' +
          '<td>' +
          (r['Tecnologia'] || '') +
          '</td>' +
          '<td>' +
          (r['Numero lavorato'] || '') +
          '</td>' +
          '<td>' +
          (r['Nome offerta'] || '') +
          '</td>';
        if (tbody) tbody.appendChild(tr);
      });

      if (summary)
        summary.textContent =
          'Anteprima: ' + rows.length + ' righe pronte per l\'import.';
    }

    async function runImport() {
      if (!importRows.length) {
        showToast('Fai prima l\'anteprima dell\'import', 'error');
        return;
      }
      const summary = document.getElementById('importSummary');
      const bar = document.getElementById('importProgress');
      let ok = 0;
      let err = 0;

      for (let i = 0; i < importRows.length; i++) {
        const r = importRows[i];
        try {
          const cf = (r['Codice fiscale'] || '').trim().toUpperCase();
          if (!cf) throw new Error('Codice fiscale vuoto alla riga ' + (i + 2));

          const idCli = await ensureClienteByCF(cf, {
            nome: r['Nome'] || '',
            cognome: r['Cognome'] || '',
            telefono: r['Telefono'] || '',
            email: r['Email'] || '',
            data_nascita: r['Data nascita'] || '',
            note: r['Note'] || 'Import CSV'
          });

          const payloadContratto = {
            id_cliente: idCli,
            codice_fiscale: cf,
            data_contratto: r['Data contratto'] || '',
            tipo_cliente: r['Tipo cliente'] || '',
            tipo_attivazione: r['Tipo attivazione'] || '',
            tecnologia: r['Tecnologia'] || '',
            compagnia: r['Compagnia'] || '',
            convergenza: r['Convergenza'] || '',
            mnp: r['MNP'] || '',
            iccid_vecchio: r['ICCID vecchio'] || '',
            iccid_nuovo: r['ICCID nuovo'] || '',
            data_attivazione: r['Data attivazione'] || '',
            data_portabilita: r['Data portabilit√†'] || '',
            numero_lavorato: r['Numero lavorato'] || '',
            nome_offerta: r['Nome offerta'] || '',
            costo_offerta: r['Costo offerta'] || '',
            vincolo_offerta_mesi: r['Vincolo offerta (mesi)'] || '',
            telefono_incluso: r['Telefono incluso'] || '',
            imei: r['IMEI'] || '',
            modello: r['Modello'] || '',
            tipo_pagamento: r['Tipo pagamento'] || '',
            mesi_vincolo_telefono: r['Mesi vincolo telefono'] || '',
            data_fine_vincolo_offerta: r['Data fine vincolo offerta'] || '',
            data_fine_vincolo_telefono: r['Data fine vincolo telefono'] || ''
          };

          await apiPost('createContratto', payloadContratto);
          ok++;
        } catch (e) {
          console.error(e);
          err++;
        }

        if (bar) {
          bar.style.width =
            String(Math.round(((i + 1) / importRows.length) * 100)) + '%';
        }
      }

      if (summary) {
        summary.textContent =
          'Import finito. OK: ' +
          ok +
          ', Errori: ' +
          err +
          (err ? ' (controlla la console del browser per dettagli)' : '');
      }
      showToast(
        'Import terminato. OK: ' + ok + ', Errori: ' + err,
        err ? 'error' : 'success'
      );
      refreshAll();
    }

    async function loadClienti() {
      try {
        const json = await apiGet('listClienti');
        clientiCache = json.data || [];
        renderListaClienti(
          document.getElementById('searchClienteTerm').value || ''
        );
        renderCompleanniOggi();
        updateDashboardKpis();
      } catch (err) {
        console.error(err);
        showToast('Errore nel caricamento clienti', 'error');
      }
    }

    async function loadContratti() {
      try {
        const json = await apiGet('listContratti');
        contrattiCache = json.data || [];
        updateDashboardKpis();
        updateReportFilters();
      } catch (err) {
        console.error(err);
        showToast('Errore nel caricamento contratti', 'error');
      }
    }

    async function loadDevice() {
      try {
        const json = await apiGet('listDevice');
        deviceCache = json.data || [];
        updateDashboardKpis();
      } catch (err) {
        console.error(err);
        showToast('Errore nel caricamento device', 'error');
      }
    }

    async function loadRiparazioni() {
      try {
        const json = await apiGet('listRiparazioni');
        riparazioniCache = json.data || [];
        updateDashboardKpis();
      } catch (err) {
        console.error(err);
        showToast('Errore nel caricamento riparazioni', 'error');
      }
    }

    async function refreshAll() {
      await loadClienti();
      await loadContratti();
      await loadDevice();
      await loadRiparazioni();
    }

    function setupForms() {
      const searchInput = document.getElementById('searchClienteTerm');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          renderListaClienti(searchInput.value || '');
        });
      }

      const formNC = document.getElementById('formNewClienteContratto');
      if (formNC) {
        formNC.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            const nome = document.getElementById('nc_nome_cliente').value.trim();
            const cognome =
              document.getElementById('nc_cognome_cliente').value.trim();
            const telefono =
              document.getElementById('nc_telefono_cliente').value.trim();
            const email =
              document.getElementById('nc_email_cliente').value.trim();
            const cf = document
              .getElementById('nc_cf_cliente')
              .value.trim()
              .toUpperCase();
            const nascita =
              document.getElementById('nc_data_nascita_cliente').value;
            const noteCli =
              document.getElementById('nc_note_cliente').value.trim();

            if (!cf) {
              showToast('Codice fiscale obbligatorio', 'error');
              return;
            }

            recalcContrattoFields();

            const idCli = await ensureClienteByCF(cf, {
              nome: nome,
              cognome: cognome,
              telefono: telefono,
              email: email,
              data_nascita: nascita,
              note: noteCli
            });

            const payloadContratto = {
              id_cliente: idCli,
              codice_fiscale: cf,
              data_contratto:
                document.getElementById('nc_data_contratto').value || '',
              tipo_cliente:
                document.getElementById('nc_tipo_cliente').value || '',
              tipo_attivazione:
                document.getElementById('nc_tipo_attivazione').value || '',
              tecnologia:
                document.getElementById('nc_tecnologia').value || '',
              compagnia:
                document.getElementById('nc_compagnia').value.trim() || '',
              convergenza:
                document.getElementById('nc_convergenza').value || '',
              mnp: document.getElementById('nc_mnp').value || '',
              iccid_vecchio:
                document.getElementById('nc_iccid_vecchio').value.trim() || '',
              iccid_nuovo:
                document.getElementById('nc_iccid_nuovo').value.trim() || '',
              data_attivazione:
                document.getElementById('nc_data_attivazione').value || '',
              data_portabilita:
                document.getElementById('nc_data_portabilita').value || '',
              numero_lavorato:
                document.getElementById('nc_numero_lavorato').value.trim() || '',
              nome_offerta:
                document.getElementById('nc_nome_offerta').value.trim() || '',
              costo_offerta:
                document.getElementById('nc_costo_offerta').value || '',
              vincolo_offerta_mesi:
                document.getElementById('nc_vincolo_offerta_mesi').value || '',
              telefono_incluso:
                document.getElementById('nc_telefono_incluso').value || '',
              imei: document.getElementById('nc_imei').value.trim() || '',
              modello:
                document.getElementById('nc_modello').value.trim() || '',
              tipo_pagamento:
                document.getElementById('nc_tipo_pagamento').value || '',
              mesi_vincolo_telefono:
                document.getElementById('nc_mesi_vincolo_telefono').value || '',
              data_fine_vincolo_offerta:
                document.getElementById('nc_data_fine_vincolo_offerta').value ||
                '',
              data_fine_vincolo_telefono:
                document.getElementById('nc_data_fine_vincolo_telefono').value ||
                ''
            };

            if (editingContratto && editingContratto.id_contratto) {
              payloadContratto.id_contratto = editingContratto.id_contratto;
              await apiPost('updateContratto', payloadContratto);
              showToast('Contratto aggiornato correttamente', 'success');
            } else {
              await apiPost('createContratto', payloadContratto);
              showToast('Cliente/contratto salvati correttamente', 'success');
            }

            editingContratto = null;
            const lbl = document.getElementById('nc_submit_label');
            if (lbl) lbl.textContent = 'Salva cliente + contratto';

            formNC.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast(
              'Errore nel salvataggio cliente/contratto: ' + msg,
              'error'
            );
          }
        });

        ['nc_data_attivazione', 'nc_vincolo_offerta_mesi', 'nc_mesi_vincolo_telefono', 'nc_mnp'].forEach(
          function (id) {
            const el = document.getElementById(id);
            if (el) {
              el.addEventListener('change', recalcContrattoFields);
            }
          }
        );
      }

      const formDv = document.getElementById('formDevice');
      if (formDv) {
        formDv.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            const cf = document
              .getElementById('dv_cf_cliente')
              .value.trim()
              .toUpperCase();
            const nome = document.getElementById('dv_nome_cliente').value.trim();
            const cognome =
              document.getElementById('dv_cognome_cliente').value.trim();
            const telefono =
              document.getElementById('dv_telefono_cliente').value.trim();
            const email =
              document.getElementById('dv_email_cliente').value.trim();

            if (!cf) {
              showToast('Codice fiscale obbligatorio', 'error');
              return;
            }

            const dataVendita =
              document.getElementById('dv_data_vendita').value || '';
            const durataFin =
              parseInt(
                document.getElementById('dv_durata_finanziamento').value || '0',
                10
              ) || 0;
            const garanziaMesi =
              parseInt(
                document.getElementById('dv_garanzia_mesi').value || '0',
                10
              ) || 0;

            if (dataVendita && durataFin > 0) {
              const fineFin = addMonthsToDate(dataVendita, durataFin);
              if (fineFin)
                document.getElementById('dv_data_fine_finanziamento').value =
                  fineFin;
            }
            if (dataVendita && garanziaMesi > 0) {
              const fineGar = addMonthsToDate(dataVendita, garanziaMesi);
              if (fineGar)
                document.getElementById('dv_data_fine_garanzia').value =
                  fineGar;
            }

            const idCli = await ensureClienteByCF(cf, {
              nome: nome,
              cognome: cognome,
              telefono: telefono,
              email: email,
              data_nascita: '',
              note: 'Cliente da modulo device'
            });

            const payload = {
              id_cliente: idCli,
              codice_fiscale: cf,
              data_vendita: dataVendita,
              marca: document.getElementById('dv_marca').value.trim() || '',
              modello:
                document.getElementById('dv_modello').value.trim() || '',
              imei: document.getElementById('dv_imei').value.trim() || '',
              prezzo: document.getElementById('dv_prezzo').value || '',
              tipo_pagamento:
                document.getElementById('dv_tipo_pagamento').value || '',
              durata_finanziamento:
                document.getElementById('dv_durata_finanziamento').value || '',
              anticipo: document.getElementById('dv_anticipo').value || '',
              costo_rata: document.getElementById('dv_costo_rata').value || '',
              data_fine_finanziamento:
                document.getElementById('dv_data_fine_finanziamento').value ||
                '',
              garanzia_mesi:
                document.getElementById('dv_garanzia_mesi').value || '',
              data_fine_garanzia:
                document.getElementById('dv_data_fine_garanzia').value || '',
              id_contratto: '',
              note: document.getElementById('dv_note').value.trim() || ''
            };

            await apiPost('createVenditaDevice', payload);
            showToast('Vendita device salvata', 'success');
            formDv.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast('Errore salvataggio device: ' + msg, 'error');
          }
        });
      }

      const formRp = document.getElementById('formRiparazione');
      if (formRp) {
        formRp.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            const cf = document
              .getElementById('rp_cf_cliente')
              .value.trim()
              .toUpperCase();
            const nome = document.getElementById('rp_nome_cliente').value.trim();
            const cognome =
              document.getElementById('rp_cognome_cliente').value.trim();
            const telefono =
              document.getElementById('rp_telefono_cliente').value.trim();
            const email =
              document.getElementById('rp_email_cliente').value.trim();

            if (!cf) {
              showToast('Codice fiscale obbligatorio', 'error');
              return;
            }

            const idCli = await ensureClienteByCF(cf, {
              nome: nome,
              cognome: cognome,
              telefono: telefono,
              email: email,
              data_nascita: '',
              note: 'Cliente da modulo riparazioni'
            });

            const payload = {
              id_cliente: idCli,
              codice_fiscale: cf,
              data_apertura:
                document.getElementById('rp_data_apertura').value || '',
              marca: document.getElementById('rp_marca').value.trim() || '',
              modello:
                document.getElementById('rp_modello').value.trim() || '',
              imei: document.getElementById('rp_imei').value.trim() || '',
              tipo_guasto:
                document.getElementById('rp_tipo_guasto').value.trim() || '',
              stato: document.getElementById('rp_stato').value || '',
              costo_previsto:
                document.getElementById('rp_costo_previsto').value || '',
              costo_effettivo:
                document.getElementById('rp_costo_effettivo').value || '',
              data_chiusura:
                document.getElementById('rp_data_chiusura').value || '',
              note: document.getElementById('rp_note').value.trim() || ''
            };

            await apiPost('createRiparazione', payload);
            showToast('Riparazione salvata', 'success');
            formRp.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast('Errore salvataggio riparazione: ' + msg, 'error');
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      switchSection('sec-dashboard');
      setupForms();
      refreshAll();
    });
  
// ===============================
//   IMPORT CSV DA FILE
// ===============================
function importCsvFile(evt) {
    const file = evt.target.files[0];
    if (!file) {
        alert("Seleziona un file CSV.");
        return;
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {

            if (!results.data || results.data.length === 0) {
                alert("Il file CSV √® vuoto o non valido.");
                return;
            }

            const records = results.data.map(row => {
                return {
                    cliente: {
                        nome: row.Nome || "",
                        cognome: row.Cognome || "",
                        cf: row.CF || row.CodiceFiscale || "",
                        telefono: row.Telefono || "",
                        email: row.Email || "",
                        dataNascita: row.DataNascita || "",
                        tipoCliente: row.TipoCliente || "",
                        valore: row.Valore || "",
                        note: row.Note || ""
                    },
                    contratto: {
                        dataContratto: row.DataContratto || "",
                        compagnia: row.Compagnia || "",
                        tipoCliente: row.TipoCliente || "",
                        tipoContratto: row.TipoAttivazione || "",
                        mnp: row.MNP || "",
                        tariffa: row.NomeOfferta || "",
                        numero: row.NumeroLavorato || row.Numero || "",
                        costo: row.CostoOfferta || "",
                        vincolo: row.Vincolo || row.VincoloOfferta || "",
                        dataFineVincolo: row.DataFineVincoloOfferta || "",
                        dataPortabilita: row.DataPortabilita || "",
                        tecnologia: row.Tecnologia || "",
                        iccid: row.ICCIDnuovo || row.ICCID || "",
                        dataAttivazione: row.DataAttivazione || "",
                        valoreCliente: row.ValoreCliente || "",
                        note: row.NoteContratto || "",
                        idSori: row.IDSori || ""
                    }
                };
            });

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "bulkImport",
                    records: records
                })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    alert("Import CSV completato!");
                } else {
                    alert("Errore backend: " + res.error);
                }
            });
        }
    });
}


// ===============================
// EXPORT EXCEL
// ===============================
function exportExcel() {
    fetch(API_URL + "?action=exportContratti")
    .then(r => r.json())
    .then(res => {
        if (res.url) window.open(res.url, "_blank");
        else alert("Errore export");
    });
}

// ===============================
// FUZZY SEARCH
// ===============================
function fuzzySearch(query, items) {
    query = query.toLowerCase();
    return items.filter(item => {
        return JSON.stringify(item).toLowerCase().includes(query);
    });
}

function smartSearch() {
    let q = document.getElementById("searchInput").value;
    let results = fuzzySearch(q, contratti || []);
    renderContrattiList(results);
}

// ===============================
// EXPORT PDF PER PERIODO
// ===============================
function exportPDF() {
    const from = document.getElementById("fromDate").value;
    const to   = document.getElementById("toDate").value;

    fetch(API_URL + "?action=exportPDF&from=" + from + "&to=" + to)
    .then(r => r.json())
    .then(res => {
        if (res.pdfUrl) window.open(res.pdfUrl, "_blank");
        else alert("Errore PDF");
    });
}


// ===== FILTRI AVANZATI =====
function applyFilters(){
    const from = document.getElementById("fDataFrom").value;
    const to = document.getElementById("fDataTo").value;
    const comp = document.getElementById("fCompagnia").value.toLowerCase();
    const tech = document.getElementById("fTecnologia").value.toLowerCase();
    const num = document.getElementById("fNumero").value;
    const mnp = document.getElementById("fMnp").value;

    let filtered = contratti.filter(c=>{
        if (from && c.dataContratto < from) return false;
        if (to && c.dataContratto > to) return false;
        if (comp && !c.compagnia.toLowerCase().includes(comp)) return false;
        if (tech && !c.tecnologia.toLowerCase().includes(tech)) return false;
        if (num && c.numero !== num) return false;
        if (mnp && c.mnp !== mnp) return false;
        return true;
    });

    renderContrattiList(filtered);
}

function resetFilters(){
    document.getElementById("fDataFrom").value="";
    document.getElementById("fDataTo").value="";
    document.getElementById("fCompagnia").value="";
    document.getElementById("fTecnologia").value="";
    document.getElementById("fNumero").value="";
    document.getElementById("fMnp").value="";
    renderContrattiList(contratti);
}


// ===== RICERCA INTELLIGENTE PRO =====
function smartGlobalSearch(){
    let q = document.getElementById("smartSearchInput").value.toLowerCase();

    if(!q){
        renderContrattiList(contratti);
        return;
    }

    let results = contratti.filter(c=>{
        return JSON.stringify(c).toLowerCase().includes(q);
    });

    renderContrattiList(results);
}


// ===============================
//   TICKET ASSISTENZA - FRONTEND
// ===============================

function loadTicket() {
    fetch(API_URL + "?action=listTicket")
    .then(r=>r.json())
    .then(res=>{
        if(!res.success) return;
        let html="";
        res.rows.forEach(t=>{
            html+=`
            <tr>
              <td>${t.cf}</td>
              <td>${t.nome}</td>
              <td>${t.problema}</td>
              <td>${t.stato}</td>
              <td>${t.data}</td>
            </tr>`;
        });
        document.getElementById("tabTicket").innerHTML = html;
    });
}

function creaTicket(){
    let payload = {
        action:"createTicket",
        cf: document.getElementById("tk_cf").value,
        nome: document.getElementById("tk_nome").value,
        problema: document.getElementById("tk_problema").value,
        stato: document.getElementById("tk_stato").value
    };

    fetch(API_URL,{
        method:"POST",
        body:JSON.stringify(payload)
    })
    .then(r=>r.json())
    .then(res=>{
        if(res.success){
            alert("Ticket creato!");
            loadTicket();
        } else alert("Errore: "+res.error);
    });
}


// ===== WhatsApp Standard =====
function waSendCustomMessage(){
  let tel = document.getElementById("detTelefono").textContent.trim();
  if(!tel){ alert("Telefono mancante"); return; }
  let msg = prompt("Scrivi il messaggio da inviare:");
  if(!msg) return;
  window.open("https://wa.me/39"+tel+"?text="+encodeURIComponent(msg));
}

function waPortabilita(){
  alert("Funzione Portabilit√† pronta. Integrare dati contratto.");
}

function waScadenza(){
  alert("Funzione Scadenza pronta. Integrare dati contratto.");
}

function showTicket(){
  document.querySelectorAll('section.section').forEach(s=>s.style.display='none');
  document.getElementById('sec-ticket').style.display='block';
}

function waTicketUpdate(tel, msg){
  if(!tel){ alert("Telefono mancante"); return;}
  window.open("https://wa.me/39"+tel+"?text="+encodeURIComponent(msg));
}


// KPI show
function showKPI(){
 document.querySelectorAll('section.section').forEach(s=>s.style.display='none');
 document.getElementById('sec-kpi').style.display='block';
 loadKPI();
}

function loadKPI(){
 // placeholder: basic counters
 document.getElementById("kpi-contratti").textContent = contratti.length;
 document.getElementById("kpi-ricavi").textContent = contratti.reduce((a,c)=>a+(c.costo||0),0)+"‚Ç¨";
 document.getElementById("kpi-medio").textContent = 
   (contratti.reduce((a,c)=>a+(c.costo||0),0)/Math.max(1,contratti.length)).toFixed(2)+"‚Ç¨";
}

</script>

<section class="section" id="sec-dashboard" style="display:none;">
<div class="card">
<div class="card-header">
<div class="card-title"><span class="card-title-dot"></span>Dashboard PRO</div>
<div class="card-subtitle">Statistiche avanzate, KPI e grafici</div>
</div>
<div class="kpi-grid">
<div class="kpi-card"><div class="kpi-value" id="kpi-contratti-mese">0</div><div class="kpi-label">Contratti mese</div></div>
<div class="kpi-card"><div class="kpi-value" id="kpi-nuovi-clienti">0</div><div class="kpi-label">Nuovi clienti</div></div>
<div class="kpi-card"><div class="kpi-value" id="kpi-ricavi">0‚Ç¨</div><div class="kpi-label">Ricavi previsti</div></div>
<div class="kpi-card"><div class="kpi-value" id="kpi-mnp">0</div><div class="kpi-label">MNP attive</div></div>
</div>
<div class="charts-container">
<div class="chart-card"><h4>Contratti per mese</h4><canvas id="chartContrattiMese"></canvas></div>
<div class="chart-card"><h4>Compagnie</h4><canvas id="chartCompagnie"></canvas></div>
<div class="chart-card"><h4>Tecnologie</h4><canvas id="chartTecnologie"></canvas></div>
</div>
</div>
</section>
</body>
</html>
