<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VOLPEX CRM</title>
  <style>
    :root {
      --bg: #f3f4f8;
      --bg-alt: #e5e7f0;
      --card: #ffffff;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --text: #111827;
      --text-soft: #6b7280;
      --border: #d1d5db;
      --danger: #ef4444;
      --success: #22c55e;
      --sidebar-width: 240px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5e7f5 0, #f9fafb 40%, #eef2ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      font-size: 14px;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    .layout {
      display: flex;
      width: 100%;
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #e5e7f5, #f9fafb);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 16px 12px;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.25);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #fb923c, #fbbf24, #22c55e, #06b6d4, #6366f1, #fb923c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #ffffff;
      font-size: 14px;
      box-shadow: 0 0 0 2px #ffffff;
    }

    .logo-text-main {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 13px;
      color: #111827;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin: 10px 4px 4px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-btn {
      width: 100%;
      border: none;
      text-align: left;
      padding: 8px 10px;
      border-radius: 999px;
      background: transparent;
      color: var(--text-soft);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.15s;
    }

    .nav-btn span.icon {
      width: 18px;
      text-align: center;
      opacity: 0.85;
    }

    .nav-btn.active,
    .nav-btn:hover {
      background: rgba(249, 115, 22, 0.08);
      color: #111827;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-soft);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      font-size: 10px;
      margin-top: 4px;
      color: #111827;
    }

    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 18px;
      gap: 12px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .top-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 8px;
      color: #111827;
    }

    .top-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ffffff;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    .btn-primary {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(90deg, #fb923c, #f97316);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(249, 115, 22, 0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-outline {
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-soft);
      font-size: 12px;
      cursor: pointer;
    }

    .btn-outline:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: #fff7ed;
    }

    /* CONTENT */
    .content {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 0;
    }

    .left-column {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    .right-column {
      flex: 1.2;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 260px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.18);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .grid {
      display: grid;
      gap: 8px;
    }

    .grid-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .kpi-card {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .kpi-tag {
      font-size: 10px;
      color: var(--accent);
      margin-top: 2px;
    }

    .news-frame {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
      height: 280px;
      background: #ffffff;
    }

    .news-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* TABLES & SCROLL */
    .table-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 260px;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    th {
      text-align: left;
      font-weight: 500;
      color: var(--text-soft);
    }

    tbody tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-body {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* FORM */
    .form-grid {
      display: grid;
      gap: 6px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-field label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 7px;
      padding: 4px 6px;
      color: var(--text);
      font-size: 12px;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.3);
    }

    .form-field textarea {
      resize: vertical;
      min-height: 50px;
    }

    .form-actions {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .badge-soft {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .cliente-summary {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .cliente-summary-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .cliente-summary-label {
      color: var(--text-soft);
      min-width: 80px;
    }

    .hidden {
      display: none !important;
    }

    /* TOAST */
    #toastContainer {
      position: fixed;
      bottom: 16px;
      left: calc(var(--sidebar-width) + 16px);
      z-index: 9999;
    }

    .toast {
      background: #ffffff;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 8px 20px rgba(148, 163, 184, 0.4);
      margin-top: 6px;
    }

    .toast.info {
      border-color: var(--accent);
    }

    .toast.error {
      border-color: var(--danger);
      color: #b91c1c;
    }

    .toast.success {
      border-color: var(--success);
      color: #166534;
    }

    /* PROGRESS BAR */
    .progress-bar-container {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-top: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #f97316);
      transition: width 0.15s linear;
    }

    @media (max-width: 960px) {
      body {
        font-size: 13px;
      }
      .sidebar {
        display: none;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .content {
        flex-direction: column;
      }
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      #toastContainer {
        left: 16px;
        right: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">V</div>
        <div>
          <div class="logo-text-main">VOLPEX</div>
          <div class="logo-text-sub">CRM Google Sheets</div>
        </div>
      </div>

      <div class="sidebar-section-title">Navigazione</div>
      <div class="nav">
        <button
          class="nav-btn active"
          data-target="sec-dashboard"
          onclick="switchSection('sec-dashboard')"
        >
          <span class="icon">üè†</span>
          <span>Dashboard</span>
        </button>

        <button
          class="nav-btn"
          data-target="sec-nuovo"
          onclick="switchSection('sec-nuovo')"
        >
          <span class="icon">üìÑ</span>
          <span>Nuovo contratto</span>
        </button>

        <button
          class="nav-btn"
          data-target="sec-device"
          onclick="switchSection('sec-device')"
        >
          <span class="icon">üì±</span>
          <span>Vendita device</span>
        </button>

        <button
          class="nav-btn"
          data-target="sec-riparazioni"
          onclick="switchSection('sec-riparazioni')"
        >
          <span class="icon">üõ†Ô∏è</span>
          <span>Riparazioni</span>
        </button>

        <button
          class="nav-btn"
          data-target="sec-import"
          onclick="switchSection('sec-import')"
        >
          <span class="icon">‚¨ÜÔ∏è</span>
          <span>Import CSV</span>
        </button>

        <button
          class="nav-btn"
          data-target="sec-report"
          onclick="switchSection('sec-report')"
        >
          <span class="icon">üìä</span>
          <span>Report &amp; Scadenze</span>
        </button>
      </div>

      <div class="sidebar-section-title">Info</div>
      <div class="sidebar-footer">
        <div>VOLPEX CRM collegato a Google Sheets</div>
        <div class="badge">
          <span class="dot"></span>
          <span>Online</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="top-bar">
        <div>
          <div class="top-title">
            VOLPEX CRM
            <span class="top-sub">
              Gestione clienti, contratti, device &amp; riparazioni
            </span>
          </div>
        </div>
        <div class="top-actions">
          <div class="pill">Foglio: <strong>VOLPEX</strong></div>
          <button type="button" class="btn-outline" onclick="refreshAll()">
            Aggiorna dati
          </button>
        </div>
      </div>

      <div class="content">
        <div class="left-column">
          <!-- DASHBOARD -->
          <section id="sec-dashboard" class="section active">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Riepilogo veloce
                </div>
                <div class="card-subtitle">
                  Panoramica clienti, contratti e attivit√† oggi
                </div>
              </div>
              <div class="grid grid-3">
                <div class="kpi-card">
                  <div class="kpi-label">Clienti totali</div>
                  <div class="kpi-value" id="kpiTotClienti">-</div>
                  <div class="kpi-tag">Anagrafica</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Contratti totali</div>
                  <div class="kpi-value" id="kpiTotContratti">-</div>
                  <div class="kpi-tag">Mobile / Fisso</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Device venduti</div>
                  <div class="kpi-value" id="kpiTotDevice">-</div>
                  <div class="kpi-tag">Vendite terminali</div>
                </div>
              </div>
              <div class="grid grid-3" style="margin-top:8px;">
                <div class="kpi-card">
                  <div class="kpi-label">Riparazioni totali</div>
                  <div class="kpi-value" id="kpiTotRiparazioni">-</div>
                  <div class="kpi-tag">Assistenza tecnica</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Compleanni oggi</div>
                  <div class="kpi-value" id="kpiCompleanniOggi">-</div>
                  <div class="kpi-tag">Da contattare</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Scadenze mese</div>
                  <div class="kpi-value" id="kpiScadenzeMese">-</div>
                  <div class="kpi-tag">Fine vincoli offerte</div>
                </div>
              </div>
            </div>
          </section>

          <!-- NUOVO CLIENTE + CONTRATTO -->
          <section id="sec-nuovo" class="section">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Nuovo cliente + contratto
                </div>
                <div class="card-subtitle">
                  Se il cliente non esiste viene creato in automatico dal codice fiscale.
                </div>
              </div>

              <form id="formNewClienteContratto">
                <div class="section-body">
                  <div class="badge-soft">Dati cliente</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Nome</label>
                      <input id="nc_nome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Cognome</label>
                      <input id="nc_cognome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Telefono</label>
                      <input id="nc_telefono_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Email</label>
                      <input id="nc_email_cliente" type="email" />
                    </div>
                    <div class="form-field">
                      <label>Codice fiscale *</label>
                      <input id="nc_cf_cliente" type="text" required />
                    </div>
                    <div class="form-field">
                      <label>Data nascita</label>
                      <input id="nc_data_nascita_cliente" type="date" />
                    </div>
                    <div class="form-field" style="grid-column: span 2;">
                      <label>Note cliente</label>
                      <input id="nc_note_cliente" type="text" />
                    </div>
                  </div>

                  <div class="badge-soft" style="margin-top:6px;">Dati contratto</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Data contratto</label>
                      <input id="nc_data_contratto" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Tipo cliente</label>
                      <select id="nc_tipo_cliente">
                        <option value="">Seleziona</option>
                        <option value="Privato">Privato</option>
                        <option value="Azienda">Azienda</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Tipo attivazione</label>
                      <select id="nc_tipo_attivazione">
                        <option value="">Seleziona</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Fisso">Fisso</option>
                        <option value="Luce">Luce</option>
                        <option value="Gas">Gas</option>
                        <option value="TV">TV</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Tecnologia</label>
                      <select id="nc_tecnologia">
                        <option value="">Seleziona</option>
                        <option value="SIM">SIM</option>
                        <option value="FTTC">FTTC</option>
                        <option value="FTTH">FTTH</option>
                        <option value="ADSL">ADSL</option>
                        <option value="FWA">FWA</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Compagnia</label>
                      <input id="nc_compagnia" type="text" placeholder="es. Vodafone, TIM..." />
                    </div>
                    <div class="form-field">
                      <label>Convergenza</label>
                      <select id="nc_convergenza">
                        <option value="">Seleziona</option>
                        <option value="NO">No</option>
                        <option value="SI">S√¨</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>MNP</label>
                      <select id="nc_mnp">
                        <option value="">Seleziona</option>
                        <option value="NO">No</option>
                        <option value="SI">S√¨</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>ICCID vecchio</label>
                      <input id="nc_iccid_vecchio" type="text" />
                    </div>
                    <div class="form-field">
                      <label>ICCID nuovo</label>
                      <input id="nc_iccid_nuovo" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Data attivazione</label>
                      <input id="nc_data_attivazione" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Data portabilit√†</label>
                      <input id="nc_data_portabilita" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Numero lavorato</label>
                      <input id="nc_numero_lavorato" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Nome offerta</label>
                      <input id="nc_nome_offerta" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Costo offerta ‚Ç¨</label>
                      <input id="nc_costo_offerta" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Vincolo offerta (mesi)</label>
                      <input id="nc_vincolo_offerta_mesi" type="number" />
                    </div>
                    <div class="form-field">
                      <label>Telefono incluso</label>
                      <select id="nc_telefono_incluso">
                        <option value="">Seleziona</option>
                        <option value="NO">No</option>
                        <option value="SI">S√¨</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>IMEI telefono</label>
                      <input id="nc_imei" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Modello telefono</label>
                      <input id="nc_modello" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Tipo pagamento</label>
                      <select id="nc_tipo_pagamento">
                        <option value="">Seleziona</option>
                        <option value="Contanti">Contanti</option>
                        <option value="Carta">Carta</option>
                        <option value="Addebito in conto">Addebito in conto</option>
                        <option value="Finanziamento">Finanziamento</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Mesi vincolo telefono</label>
                      <input id="nc_mesi_vincolo_telefono" type="number" />
                    </div>
                    <div class="form-field">
                      <label>Fine vincolo offerta</label>
                      <input id="nc_data_fine_vincolo_offerta" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Fine vincolo telefono</label>
                      <input id="nc_data_fine_vincolo_telefono" type="date" />
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn-primary">
                      <span id="nc_submit_label">Salva cliente + contratto</span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </section>
          <!-- VENDITA DEVICE -->
          <section id="sec-device" class="section">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Vendita device
                </div>
                <div class="card-subtitle">
                  Il cliente viene creato in automatico se non esiste.
                </div>
              </div>

              <form id="formDevice">
                <div class="section-body">
                  <div class="badge-soft">Dati cliente</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Codice fiscale *</label>
                      <input id="dv_cf_cliente" type="text" required />
                    </div>
                    <div class="form-field">
                      <label>Nome</label>
                      <input id="dv_nome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Cognome</label>
                      <input id="dv_cognome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Telefono</label>
                      <input id="dv_telefono_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Email</label>
                      <input id="dv_email_cliente" type="email" />
                    </div>
                  </div>

                  <div class="badge-soft" style="margin-top:6px;">Dati device</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Data vendita</label>
                      <input id="dv_data_vendita" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Marca</label>
                      <input id="dv_marca" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Modello</label>
                      <input id="dv_modello" type="text" />
                    </div>
                    <div class="form-field">
                      <label>IMEI</label>
                      <input id="dv_imei" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Prezzo ‚Ç¨</label>
                      <input id="dv_prezzo" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Tipo pagamento</label>
                      <select id="dv_tipo_pagamento">
                        <option value="">Seleziona</option>
                        <option value="Contanti">Contanti</option>
                        <option value="Carta">Carta</option>
                        <option value="Finanziamento">Finanziamento</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Durata finanziamento (mesi)</label>
                      <input id="dv_durata_finanziamento" type="number" />
                    </div>
                    <div class="form-field">
                      <label>Anticipo ‚Ç¨</label>
                      <input id="dv_anticipo" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Costo rata ‚Ç¨</label>
                      <input id="dv_costo_rata" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Fine finanziamento</label>
                      <input id="dv_data_fine_finanziamento" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Garanzia (mesi)</label>
                      <input id="dv_garanzia_mesi" type="number" />
                    </div>
                    <div class="form-field">
                      <label>Fine garanzia</label>
                      <input id="dv_data_fine_garanzia" type="date" />
                    </div>
                    <div class="form-field" style="grid-column: span 2;">
                      <label>Note</label>
                      <input id="dv_note" type="text" />
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn-primary">
                      Salva vendita device
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </section>

          <!-- RIPARAZIONI -->
          <section id="sec-riparazioni" class="section">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Nuova riparazione
                </div>
                <div class="card-subtitle">
                  Gestione assistenze con stato e costi.
                </div>
              </div>

              <form id="formRiparazione">
                <div class="section-body">
                  <div class="badge-soft">Dati cliente</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Codice fiscale *</label>
                      <input id="rp_cf_cliente" type="text" required />
                    </div>
                    <div class="form-field">
                      <label>Nome</label>
                      <input id="rp_nome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Cognome</label>
                      <input id="rp_cognome_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Telefono</label>
                      <input id="rp_telefono_cliente" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Email</label>
                      <input id="rp_email_cliente" type="email" />
                    </div>
                  </div>

                  <div class="badge-soft" style="margin-top:6px;">Dati riparazione</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Data apertura</label>
                      <input id="rp_data_apertura" type="date" />
                    </div>
                    <div class="form-field">
                      <label>Marca</label>
                      <input id="rp_marca" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Modello</label>
                      <input id="rp_modello" type="text" />
                    </div>
                    <div class="form-field">
                      <label>IMEI</label>
                      <input id="rp_imei" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Tipo guasto</label>
                      <input id="rp_tipo_guasto" type="text" />
                    </div>
                    <div class="form-field">
                      <label>Stato</label>
                      <select id="rp_stato">
                        <option value="">Seleziona</option>
                        <option value="Aperta">Aperta</option>
                        <option value="In lavorazione">In lavorazione</option>
                        <option value="Chiusa">Chiusa</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label>Costo previsto ‚Ç¨</label>
                      <input id="rp_costo_previsto" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Costo effettivo ‚Ç¨</label>
                      <input id="rp_costo_effettivo" type="number" step="0.01" />
                    </div>
                    <div class="form-field">
                      <label>Data chiusura</label>
                      <input id="rp_data_chiusura" type="date" />
                    </div>
                    <div class="form-field" style="grid-column: span 2;">
                      <label>Note</label>
                      <input id="rp_note" type="text" />
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn-primary">
                      Salva riparazione
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </section>
          <!-- IMPORT CSV -->
          <section id="sec-import" class="section">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Import CSV clienti + contratti
                </div>
                <div class="card-subtitle">
                  Incolla i dati con intestazioni come:
                  Nome, Cognome, Telefono, Email, Codice fiscale, Data nascita, Note,
                  Data contratto, Tipo cliente, Tipo attivazione, Tecnologia, Compagnia,
                  Convergenza, MNP, ICCID vecchio, ICCID nuovo, Data attivazione,
                  Data portabilit√†, Numero lavorato, Nome offerta, Costo offerta,
                  Vincolo offerta (mesi), Telefono incluso, IMEI, Modello, Tipo pagamento,
                  Mesi vincolo telefono, Data fine vincolo offerta, Data fine vincolo telefono.
                </div>
              </div>

              <div class="section-body">
                <div class="form-field">
                  <label>Dati CSV (incolla qui, inclusa la riga di intestazione)</label>
                  <textarea id="csvRaw" rows="6" placeholder="Incolla qui..."></textarea>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn-outline" onclick="previewImport()">
                    Anteprima
                  </button>
                  <button type="button" class="btn-primary" onclick="runImport()">
                    Importa
                  </button>
                </div>

                <div id="importSummary" style="font-size:12px;color:var(--text-soft);margin-top:4px;">
                  Nessuna importazione eseguita.
                </div>
                <div class="progress-bar-container">
                  <div id="importProgress" class="progress-bar"></div>
                </div>

                <div class="table-wrapper" style="max-height:200px;margin-top:8px;">
                  <table>
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Telefono</th>
                        <th>Codice fiscale</th>
                        <th>Data contratto</th>
                        <th>Compagnia</th>
                        <th>Tecnologia</th>
                        <th>Numero</th>
                        <th>Offerta</th>
                      </tr>
                    </thead>
                    <tbody id="csvPreviewBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- REPORT & SCADENZE -->
          <section id="sec-report" class="section">
            <div class="card">
              <div class="card-header">
                <div class="card-title">
                  <span class="card-title-dot"></span>
                  Report &amp; Scadenze
                </div>
                <div class="card-subtitle">
                  Compleanni, contratti per compagnia/tecnologia e scadenze vincoli.
                </div>
              </div>

              <div class="section-body">
                <!-- COMPLEANNI OGGI -->
                <div class="badge-soft">Compleanni di oggi</div>
                <div class="table-wrapper" style="max-height:110px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Telefono</th>
                        <th>Codice fiscale</th>
                        <th>Data nascita</th>
                      </tr>
                    </thead>
                    <tbody id="tabCompleanni"></tbody>
                  </table>
                </div>

                <!-- FILTRO CONTRATTI -->
                <div class="badge-soft" style="margin-top:6px;">
                  Contratti per compagnia / tecnologia
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                  <div class="form-field">
                    <label>Compagnia</label>
                    <select id="rep_compagnia">
                      <option value="">Tutte</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label>Tecnologia</label>
                    <select id="rep_tecnologia">
                      <option value="">Tutte</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-outline" onclick="applyContrattiFiltro()">
                      Applica filtro
                    </button>
                  </div>
                </div>
                <div class="table-wrapper" style="max-height:120px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>CF</th>
                        <th>Compagnia</th>
                        <th>Tecnologia</th>
                        <th>Numero</th>
                      </tr>
                    </thead>
                    <tbody id="tabContrattiFiltro"></tbody>
                  </table>
                </div>

                <!-- SCADENZE VINCOLI -->
                <div class="badge-soft" style="margin-top:6px;">
                  Scadenze vincoli offerta (mese/anno)
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                  <div class="form-field">
                    <label>Mese</label>
                    <select id="rep_mese">
                      <option value="">Seleziona</option>
                      <option value="01">01</option>
                      <option value="02">02</option>
                      <option value="03">03</option>
                      <option value="04">04</option>
                      <option value="05">05</option>
                      <option value="06">06</option>
                      <option value="07">07</option>
                      <option value="08">08</option>
                      <option value="09">09</option>
                      <option value="10">10</option>
                      <option value="11">11</option>
                      <option value="12">12</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label>Anno</label>
                    <select id="rep_anno">
                      <option value="">Seleziona</option>
                      <option value="2023">2023</option>
                      <option value="2024">2024</option>
                      <option value="2025">2025</option>
                      <option value="2026">2026</option>
                      <option value="2027">2027</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-outline" onclick="applyScadenzeFiltro()">
                      Mostra scadenze
                    </button>
                  </div>
                </div>
                <div class="table-wrapper" style="max-height:140px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>CF</th>
                        <th>Compagnia</th>
                        <th>Offerta</th>
                        <th>Fine vincolo</th>
                      </tr>
                    </thead>
                    <tbody id="tabScadenze"></tbody>
                  </table>
                </div>

                <!-- ESPORTA CSV PER PERIODO -->
                <div class="badge-soft" style="margin-top:6px;">
                  Esporta CSV contratti per periodo (Data contratto)
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                  <div class="form-field">
                    <label>Dal</label>
                    <input id="rep_exp_da" type="date" />
                  </div>
                  <div class="form-field">
                    <label>Al</label>
                    <input id="rep_exp_a" type="date" />
                  </div>
                  <div class="form-field">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-outline" onclick="exportContrattiPeriodo()">
                      Esporta CSV
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div> <!-- fine left-column -->

        <!-- COLONNA DESTRA: CLIENTI & NEWS -->
        <div class="right-column">
          <section class="card">
            <div class="card-header">
              <div class="card-title">
                <span class="card-title-dot"></span>
                Clienti &amp; storico
              </div>
              <div class="card-subtitle">
                Seleziona un cliente per vedere contratti, device e riparazioni.
              </div>
            </div>

            <div class="form-field" style="margin-bottom:6px;">
              <label>Ricerca cliente</label>
              <input
                id="searchClienteTerm"
                type="text"
                placeholder="Nome, cognome, CF o telefono"
              />
            </div>

            <div class="table-wrapper" style="max-height:170px;margin-bottom:6px;">
              <table>
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Telefono</th>
                    <th>CF</th>
                  </tr>
                </thead>
                <tbody id="tabClienti"></tbody>
              </table>
            </div>

            <div
              id="noClienteSelezionato"
              style="font-size:12px;color:var(--text-soft);"
            >
              Seleziona un cliente per vedere i dettagli.
            </div>

            <div id="clienteCard" class="card hidden" style="margin-top:6px;padding:8px;">
              <div class="card-header" style="margin-bottom:4px;">
                <div class="card-title">
                  <span class="card-title-dot"></span> Anagrafica cliente
                </div>
              </div>

              <div class="cliente-summary">
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Nome</div>
                  <div id="detNome"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Cognome</div>
                  <div id="detCognome"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Telefono</div>
                  <div id="detTelefono"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Email</div>
                  <div id="detEmail"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Cod. fiscale</div>
                  <div id="detCF"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Data nascita</div>
                  <div id="detNascita"></div>
                </div>
                <div class="cliente-summary-row">
                  <div class="cliente-summary-label">Note</div>
                  <div id="detNote"></div>
                </div>
              </div>

              <div class="form-actions" style="justify-content:flex-start;margin-top:6px;">
                <button
                  type="button"
                  class="btn-outline"
                  onclick="openEditCliente()"
                >
                  Modifica cliente
                </button>
                <button
                  type="button"
                  class="btn-outline"
                  onclick="openWhatsappForSelected()"
                >
                  Apri WhatsApp
                </button>
                <button
                  type="button"
                  class="btn-outline"
                  onclick="exportClientePDF()"
                >
                  Esporta PDF
                </button>
              </div>

              <div
                id="editClienteForm"
                class="section-body hidden"
                style="margin-top:4px;"
              >
                <div class="form-grid">
                  <div class="form-field">
                    <label>Nome</label>
                    <input id="ec_nome" type="text" />
                  </div>
                  <div class="form-field">
                    <label>Cognome</label>
                    <input id="ec_cognome" type="text" />
                  </div>
                  <div class="form-field">
                    <label>Telefono</label>
                    <input id="ec_telefono" type="text" />
                  </div>
                  <div class="form-field">
                    <label>Email</label>
                    <input id="ec_email" type="email" />
                  </div>
                  <div class="form-field">
                    <label>Codice fiscale</label>
                    <input id="ec_cf" type="text" />
                  </div>
                  <div class="form-field">
                    <label>Data nascita</label>
                    <input id="ec_data_nascita" type="date" />
                  </div>
                  <div class="form-field" style="grid-column: span 2;">
                    <label>Note</label>
                    <input id="ec_note" type="text" />
                  </div>
                </div>
                <div class="form-actions" style="margin-top:4px;">
                  <button
                    type="button"
                    class="btn-outline"
                    onclick="cancelEditCliente()"
                  >
                    Annulla
                  </button>
                  <button
                    type="button"
                    class="btn-primary"
                    onclick="saveEditCliente()"
                  >
                    Salva modifiche
                  </button>
                </div>
              </div>

              <!-- STORICO CONTRATTI -->
              <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico contratti (clicca per modificare)
              </div>
              <div class="table-wrapper" style="max-height:100px;margin-top:2px;">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Compagnia</th>
                      <th>Tecnologia</th>
                      <th>Numero</th>
                    </tr>
                  </thead>
                  <tbody id="tabContrattiCliente"></tbody>
                </table>
              </div>

              <!-- STORICO DEVICE -->
              <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico device
              </div>
              <div class="table-wrapper" style="max-height:80px;margin-top:2px;">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Modello</th>
                      <th>IMEI</th>
                    </tr>
                  </thead>
                  <tbody id="tabDeviceCliente"></tbody>
                </table>
              </div>

              <!-- STORICO RIPARAZIONI -->
              <div style="margin-top:8px;font-size:11px;color:var(--text-soft);">
                Storico riparazioni
              </div>
              <div class="table-wrapper" style="max-height:80px;margin-top:2px;">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Modello</th>
                      <th>Guasto</th>
                    </tr>
                  </thead>
                  <tbody id="tabRiparazioniCliente"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="card-header">
              <div class="card-title">
                <span class="card-title-dot"></span>
                News TELCO
              </div>
              <div class="card-subtitle">
                Notizie da MondoMobileWeb
              </div>
            </div>
            <div class="news-frame">
              <iframe src="https://www.mondomobileweb.it/"></iframe>
            </div>
          </section>
        </div> <!-- right-column -->
      </div> <!-- content -->
    </main>
  </div> <!-- layout -->

  <div id="toastContainer"></div>
 <script>
   // URL Web App (Apps Script)
    const API_BASE =
      'https://script.google.com/macros/s/AKfycbwwZN7PpcPVjemEF9e7iU607Z3yHZgDWj-UYbv5yfsRg4rudlcZdNAEDh4suKNj0SfX/exec';


    let clientiCache = [];
    let contrattiCache = [];
    let deviceCache = [];
    let riparazioniCache = [];
    let selectedCliente = null;
    let importRows = [];
    let editingContratto = null; // se non null -> stai modificando un contratto

    async function apiGet(action) {
      const url = API_BASE + '?action=' + encodeURIComponent(action);
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP GET ' + res.status);
      const txt = await res.text();
      let json;
      try {
        json = JSON.parse(txt);
      } catch (err) {
        console.error('Risposta non JSON per ' + action, txt);
        throw new Error('Risposta non JSON: ' + err);
      }
      if (!json.success) {
        throw new Error(json.error || 'Errore generico GET ' + action);
      }
      return json;
    }

    async function apiPost(action, payload) {
      const url = API_BASE;
      const body = Object.assign({}, payload || {}, { action: action });
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json;charset=utf-8' },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error('HTTP POST ' + res.status);
        const txt = await res.text();
        let json;
        try {
          json = JSON.parse(txt);
        } catch (err2) {
          console.error('Risposta non JSON POST ' + action, txt);
          throw new Error('Risposta non JSON: ' + err2);
        }
        if (!json.success) {
          throw new Error(json.error || 'Errore generico POST ' + action);
        }
        return json;
      } catch (err) {
        console.error('Errore POST ' + action, err);
        throw new Error(
          'Network error POST ' + action + ': ' + (err.message || String(err))
        );
      }
    }

    function showToast(message, type) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const div = document.createElement('div');
      div.className = 'toast ' + (type || 'info');
      div.textContent = message;
      container.appendChild(div);
      setTimeout(function () {
        if (div.parentNode) {
          div.classList.add('hide');
          setTimeout(function () {
            if (div.parentNode) container.removeChild(div);
          }, 300);
        }
      }, 3500);
    }

    function switchSection(id) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(function (s) {
        if (s.id === id) s.classList.add('active');
        else s.classList.remove('active');
      });
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(function (n) {
        if (n.getAttribute('data-target') === id) n.classList.add('active');
        else n.classList.remove('active');
      });
    }

    function renderListaClienti(filterTerm) {
      filterTerm = (filterTerm || '').trim().toLowerCase();
      const tbody = document.getElementById('listaClientiBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      let list = clientiCache.slice();

      if (filterTerm) {
        list = list.filter(function (c) {
          const nome = (c.nome || '').toLowerCase();
          const cognome = (c.cognome || '').toLowerCase();
          const cf = (c.codice_fiscale || '').toLowerCase();
          const tel = (c.telefono || '').toLowerCase();
          return (
            nome.includes(filterTerm) ||
            cognome.includes(filterTerm) ||
            cf.includes(filterTerm) ||
            tel.includes(filterTerm)
          );
        });
      }

      list.sort(function (a, b) {
        const aCognome = (a.cognome || '').toLowerCase();
        const bCognome = (b.cognome || '').toLowerCase();
        if (aCognome < bCognome) return -1;
        if (aCognome > bCognome) return 1;
        const aNome = (a.nome || '').toLowerCase();
        const bNome = (b.nome || '').toLowerCase();
        if (aNome < bNome) return -1;
        if (aNome > bNome) return 1;
        return 0;
      });

      list.forEach(function (c) {
        const tr = document.createElement('tr');
        tr.className = 'clickable-row';
        tr.onclick = function () {
          selectCliente(c.id_cliente);
        };
        tr.innerHTML =
          '<td>' +
          (c.nome || '') +
          '</td><td>' +
          (c.cognome || '') +
          '</td><td>' +
          (c.telefono || '') +
          '</td><td>' +
          (c.codice_fiscale || '') +
          '</td>';
        tbody.appendChild(tr);
      });
    }

    function renderDettaglioCliente(cliente) {
      const box = document.getElementById('dettaglioClienteBox');
      if (!box) return;
      if (!cliente) {
        box.innerHTML =
          '<div class="card empty">Seleziona un cliente per vedere i dettagli.</div>';
        return;
      }

      const contrattiCliente = contrattiCache.filter(function (ct) {
        return ct.id_cliente === cliente.id_cliente;
      });
      const deviceCliente = deviceCache.filter(function (d) {
        return d.id_cliente === cliente.id_cliente;
      });
      const ripCliente = riparazioniCache.filter(function (r) {
        return r.id_cliente === cliente.id_cliente;
      });

      let html = '';
      html += '<div class="card">';
      html +=
        '<h3>' +
        (cliente.nome || '') +
        ' ' +
        (cliente.cognome || '') +
        '</h3>';
      html += '<p><strong>Telefono:</strong> ' + (cliente.telefono || '-') + '</p>';
      html += '<p><strong>Email:</strong> ' + (cliente.email || '-') + '</p>';
      html +=
        '<p><strong>Codice fiscale:</strong> ' +
        (cliente.codice_fiscale || '-') +
        '</p>';
      html +=
        '<p><strong>Data nascita:</strong> ' +
        (cliente.data_nascita || '-') +
        '</p>';
      html += '<p><strong>Note:</strong> ' + (cliente.note || '-') + '</p>';
      html += '</div>';

      html += '<div class="card">';
      html += '<h4>Contratti</h4>';
      if (!contrattiCliente.length) {
        html += '<p class="muted">Nessun contratto presente.</p>';
      } else {
        html += `
          <table>
            <thead>
              <tr>
                <th>Data contratto</th>
                <th>Compagnia</th>
                <th>Tecnologia</th>
                <th>Numero</th>
                <th>Offerta</th>
                <th>Fine vincolo</th>
              </tr>
            </thead>
            <tbody>`;

        contrattiCliente.forEach(function (ct) {
          html +=
            '<tr class="clickable-row" onclick="editContrattoFromCard(' +
            ct.id_contratto +
            ')">' +
            '<td>' +
            (ct.data_contratto || '') +
            '</td>' +
            '<td>' +
            (ct.compagnia || '') +
            '</td>' +
            '<td>' +
            (ct.tecnologia || '') +
            '</td>' +
            '<td>' +
            (ct.numero_lavorato || '') +
            '</td>' +
            '<td>' +
            (ct.nome_offerta || '') +
            '</td>' +
            '<td>' +
            (ct.data_fine_vincolo_offerta || '') +
            '</td>' +
            '</tr>';
        });

        html += '</tbody></table>';
      }
      html += '</div>';

      html += '<div class="card">';
      html += '<h4>Device venduti</h4>';
      if (!deviceCliente.length) {
        html += '<p class="muted">Nessun device venduto.</p>';
      } else {
        html += `
          <table>
            <thead>
              <tr>
                <th>Data vendita</th>
                <th>Device</th>
                <th>IMEI</th>
                <th>Pagamento</th>
              </tr>
            </thead>
            <tbody>`;
        deviceCliente.forEach(function (d) {
          html +=
            '<tr>' +
            '<td>' +
            (d.data_vendita || '') +
            '</td>' +
            '<td>' +
            (d.nome_device || '') +
            '</td>' +
            '<td>' +
            (d.imei || '') +
            '</td>' +
            '<td>' +
            (d.tipo_pagamento || '') +
            '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
      }
      html += '</div>';

      html += '<div class="card">';
      html += '<h4>Riparazioni</h4>';
      if (!ripCliente.length) {
        html += '<p class="muted">Nessuna riparazione presente.</p>';
      } else {
        html += `
          <table>
            <thead>
              <tr>
                <th>Data apertura</th>
                <th>Modello</th>
                <th>IMEI</th>
                <th>Guasto</th>
                <th>Stato</th>
              </tr>
            </thead>
            <tbody>`;
        ripCliente.forEach(function (r) {
          html +=
            '<tr>' +
            '<td>' +
            (r.data_apertura || '') +
            '</td>' +
            '<td>' +
            (r.modello || '') +
            '</td>' +
            '<td>' +
            (r.imei || '') +
            '</td>' +
            '<td>' +
            (r.guasto || '') +
            '</td>' +
            '<td>' +
            (r.stato || '') +
            '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
      }
      html += '</div>';

      box.innerHTML = html;
    }

    function selectCliente(id) {
      selectedCliente = clientiCache.find(function (c) {
        return c.id_cliente === id;
      });
      renderDettaglioCliente(selectedCliente);
    }

    function ensureClienteByCF(cf, dati) {
      cf = (cf || '').toUpperCase();
      if (!cf) throw new Error('Codice fiscale mancante');
      const existing = clientiCache.find(function (c) {
        return String(c.codice_fiscale || '').toUpperCase() === cf;
      });
      if (existing) return Promise.resolve(existing.id_cliente);

      const payload = {
        nome: dati.nome || '',
        cognome: dati.cognome || '',
        telefono: dati.telefono || '',
        email: dati.email || '',
        codice_fiscale: cf,
        data_nascita: dati.data_nascita || '',
        note: dati.note || ''
      };
      return apiPost('createCliente', payload).then(function (res) {
        const id = res.id_cliente;
        clientiCache.push(
          Object.assign(
            {
              id_cliente: id,
              codice_fiscale: cf
            },
            dati
          )
        );
        return id;
      });
    }

    function recalcContrattoFields() {
      recalcFineVincoli();
      recalcPortabilita();
    }

    function recalcFineVincoli() {
      const costoOffertaEl = document.getElementById('nc_costo_offerta');
      const vincoloOffertaEl = document.getElementById('nc_vincolo_offerta_mesi');
      const dataContrattoEl = document.getElementById('nc_data_contratto');
      const dataFineOffertaEl = document.getElementById(
        'nc_data_fine_vincolo_offerta'
      );

      if (!costoOffertaEl || !vincoloOffertaEl || !dataContrattoEl) return;
      const costo =
        parseFloat((costoOffertaEl.value || '').replace(',', '.')) || 0;
      const mesi = parseInt(vincoloOffertaEl.value || '0', 10) || 0;
      const dataContratto = dataContrattoEl.value;
      if (!dataContratto || !mesi) {
        if (dataFineOffertaEl) dataFineOffertaEl.value = '';
        return;
      }
      const dt = new Date(dataContratto);
      if (isNaN(dt.getTime())) {
        if (dataFineOffertaEl) dataFineOffertaEl.value = '';
        return;
      }
      dt.setMonth(dt.getMonth() + mesi);
      const yyyy = dt.getFullYear();
      let mm = dt.getMonth() + 1;
      let dd = dt.getDate();
      if (mm < 10) mm = '0' + mm;
      if (dd < 10) dd = '0' + dd;
      const str = yyyy + '-' + mm + '-' + dd;
      if (dataFineOffertaEl) dataFineOffertaEl.value = str;
    }

    function recalcPortabilita() {
      const dataContrattoEl = document.getElementById('nc_data_contratto');
      const dataPortabilitaEl = document.getElementById('nc_data_portabilita');
      if (!dataContrattoEl || !dataPortabilitaEl) return;
      const dt = new Date(dataContrattoEl.value || '');
      if (isNaN(dt.getTime())) {
        dataPortabilitaEl.value = '';
        return;
      }
      dt.setDate(dt.getDate() + 3);
      const yyyy = dt.getFullYear();
      let mm = dt.getMonth() + 1;
      let dd = dt.getDate();
      if (mm < 10) mm = '0' + mm;
      if (dd < 10) dd = '0' + dd;
      dataPortabilitaEl.value = yyyy + '-' + mm + '-' + dd;
    }

    function computeScadenzeContratti() {
      const rows = contrattiCache.map(function (ct) {
        return {
          id_contratto: ct.id_contratto,
          nome_cliente: ct.nome_cliente,
          compagnia: ct.compagnia,
          numero_lavorato: ct.numero_lavorato,
          data_fine_vincolo_offerta: ct.data_fine_vincolo_offerta,
          data_attivazione: ct.data_attivazione,
          tecnologia: ct.tecnologia,
          nome_offerta: ct.nome_offerta
        };
      });
      const now = new Date();
      rows.forEach(function (r) {
        let dt = null;
        if (r.data_fine_vincolo_offerta) {
          dt = new Date(r.data_fine_vincolo_offerta);
        } else if (r.data_attivazione) {
          dt = new Date(r.data_attivazione);
        }
        if (!dt || isNaN(dt.getTime())) {
          r.days_to_expiry = null;
          return;
        }
        const diff = dt.getTime() - now.getTime();
        r.days_to_expiry = Math.round(diff / (1000 * 60 * 60 * 24));
      });
      rows.sort(function (a, b) {
        if (a.days_to_expiry == null && b.days_to_expiry == null) return 0;
        if (a.days_to_expiry == null) return 1;
        if (b.days_to_expiry == null) return -1;
        return a.days_to_expiry - b.days_to_expiry;
      });
      return rows;
    }

    function renderScadenzeContratti() {
      const tbody = document.getElementById('scadenzeContrattiBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = computeScadenzeContratti();
      rows.forEach(function (r) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          (r.nome_cliente || '') +
          '</td>' +
          '<td>' +
          (r.compagnia || '') +
          '</td>' +
          '<td>' +
          (r.numero_lavorato || '') +
          '</td>' +
          '<td>' +
          (r.nome_offerta || '') +
          '</td>' +
          '<td>' +
          (r.data_fine_vincolo_offerta || r.data_attivazione || '-') +
          '</td>' +
          '<td>' +
          (r.days_to_expiry != null ? r.days_to_expiry : '-') +
          '</td>';
        tbody.appendChild(tr);
      });
    }

    function renderDashboardCards() {
      const elTotClienti = document.getElementById('cardTotClienti');
      const elTotContratti = document.getElementById('cardTotContratti');
      const elTotDevice = document.getElementById('cardTotDevice');
      const elTotRip = document.getElementById('cardTotRiparazioni');

      if (elTotClienti) elTotClienti.textContent = clientiCache.length;
      if (elTotContratti) elTotContratti.textContent = contrattiCache.length;
      if (elTotDevice) elTotDevice.textContent = deviceCache.length;
      if (elTotRip) elTotRip.textContent = riparazioniCache.length;
    }

    function renderReportCompagnie() {
      const tbody = document.getElementById('reportCompagnieBody');
      if (!tbody) return;
      const map = {};
      contrattiCache.forEach(function (ct) {
        const comp = ct.compagnia || 'N/D';
        if (!map[comp]) {
          map[comp] = { count: 0 };
        }
        map[comp].count++;
      });
      const entries = Object.keys(map).map(function (k) {
        return { compagnia: k, count: map[k].count };
      });
      entries.sort(function (a, b) {
        return b.count - a.count;
      });
      tbody.innerHTML = '';
      entries.forEach(function (e) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + e.compagnia + '</td><td>' + e.count + '</td>';
        tbody.appendChild(tr);
      });
    }

    function renderReportTecnologie() {
      const tbody = document.getElementById('reportTecnologieBody');
      if (!tbody) return;
      const map = {};
      contrattiCache.forEach(function (ct) {
        const tech = ct.tecnologia || 'N/D';
        if (!map[tech]) map[tech] = { count: 0 };
        map[tech].count++;
      });
      const entries = Object.keys(map).map(function (k) {
        return { tecnologia: k, count: map[k].count };
      });
      entries.sort(function (a, b) {
        return b.count - a.count;
      });
      tbody.innerHTML = '';
      entries.forEach(function (e) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + e.tecnologia + '</td><td>' + e.count + '</td>';
        tbody.appendChild(tr);
      });
    }

    async function refreshAll() {
      try {
        const [cli, con, dev, rip] = await Promise.all([
          apiGet('listClienti'),
          apiGet('listContratti'),
          apiGet('listDevice'),
          apiGet('listRiparazioni')
        ]);

        clientiCache = (cli.rows || []).map(function (c, idx) {
          return Object.assign(
            {
              id_cliente: idx + 1
            },
            c
          );
        });

        contrattiCache = (con.rows || []).map(function (ct, idx) {
          return Object.assign(
            {
              id_contratto: idx + 1
            },
            ct
          );
        });

        deviceCache = (dev.rows || []).map(function (d, idx) {
          return Object.assign(
            {
              id_device: idx + 1
            },
            d
          );
        });

        riparazioniCache = (rip.rows || []).map(function (r, idx) {
          return Object.assign(
            {
              id_riparazione: idx + 1
            },
            r
          );
        });

        renderListaClienti('');
        renderDashboardCards();
        renderReportCompagnie();
        renderReportTecnologie();
        renderDettaglioCliente(null);
        renderScadenzeContratti();
      } catch (err) {
        console.error('Errore refreshAll', err);
        showToast('Errore nel caricamento dati: ' + err.message, 'error');
      }
    }

    function setupForms() {
      const searchInput = document.getElementById('searchClienteTerm');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          renderListaClienti(searchInput.value || '');
        });
      }

      const formNC = document.getElementById('formNewClienteContratto');
      if (formNC) {
        formNC.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            const nome = document.getElementById('nc_nome_cliente').value.trim();
            const cognome =
              document.getElementById('nc_cognome_cliente').value.trim();
            const telefono =
              document.getElementById('nc_telefono_cliente').value.trim();
            const email =
              document.getElementById('nc_email_cliente').value.trim();
            const cf = document
              .getElementById('nc_cf_cliente')
              .value.trim()
              .toUpperCase();
            const nascita =
              document.getElementById('nc_data_nascita_cliente').value;
            const noteCli =
              document.getElementById('nc_note_cliente').value.trim();

            if (!cf) {
              showToast('Codice fiscale obbligatorio', 'error');
              return;
            }

            recalcContrattoFields();

            const idCli = await ensureClienteByCF(cf, {
              nome: nome,
              cognome: cognome,
              telefono: telefono,
              email: email,
              data_nascita: nascita,
              note: noteCli
            });

            const payloadContratto = {
              id_cliente: idCli,
              codice_fiscale: cf,
              data_contratto:
                document.getElementById('nc_data_contratto').value || '',
              tipo_cliente:
                document.getElementById('nc_tipo_cliente').value || '',
              tipo_attivazione:
                document.getElementById('nc_tipo_attivazione').value || '',
              tecnologia:
                document.getElementById('nc_tecnologia').value || '',
              compagnia:
                document.getElementById('nc_compagnia').value.trim() || '',
              convergenza:
                document.getElementById('nc_convergenza').value || '',
              mnp: document.getElementById('nc_mnp').value || '',
              iccid_vecchio:
                document.getElementById('nc_iccid_vecchio').value.trim() || '',
              iccid_nuovo:
                document.getElementById('nc_iccid_nuovo').value.trim() || '',
              data_attivazione:
                document.getElementById('nc_data_attivazione').value || '',
              data_portabilita:
                document.getElementById('nc_data_portabilita').value || '',
              numero_lavorato:
                document.getElementById('nc_numero_lavorato').value.trim() || '',
              nome_offerta:
                document.getElementById('nc_nome_offerta').value.trim() || '',
              costo_offerta:
                document.getElementById('nc_costo_offerta').value || '',
              vincolo_offerta_mesi:
                document.getElementById('nc_vincolo_offerta_mesi').value || '',
              telefono_incluso:
                document.getElementById('nc_telefono_incluso').value || '',
              imei: document.getElementById('nc_imei').value.trim() || '',
              modello:
                document.getElementById('nc_modello').value.trim() || '',
              tipo_pagamento:
                document.getElementById('nc_tipo_pagamento').value || '',
              mesi_vincolo_telefono:
                document.getElementById('nc_mesi_vincolo_telefono').value || '',
              data_fine_vincolo_offerta:
                document.getElementById('nc_data_fine_vincolo_offerta').value ||
                '',
              data_fine_vincolo_telefono:
                document.getElementById('nc_data_fine_vincolo_telefono').value ||
                ''
            };

            if (editingContratto && editingContratto.id_contratto) {
              payloadContratto.id_contratto = editingContratto.id_contratto;
              await apiPost('updateContratto', payloadContratto);
              showToast('Contratto aggiornato correttamente', 'success');
            } else {
              await apiPost('createContratto', payloadContratto);
              showToast('Cliente/contratto salvati correttamente', 'success');
            }

            editingContratto = null;
            const lbl = document.getElementById('nc_submit_label');
            if (lbl) lbl.textContent = 'Salva cliente + contratto';

            formNC.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast(
              'Errore nel salvataggio cliente/contratto: ' + msg,
              'error'
            );
          }
        });
      }

      const formDevice = document.getElementById('formVenditaDevice');
      if (formDevice) {
        formDevice.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            if (!selectedCliente || !selectedCliente.id_cliente) {
              showToast(
                'Seleziona prima un cliente sulla destra per associare il device',
                'error'
              );
              return;
            }
            const payload = {
              id_cliente: selectedCliente.id_cliente,
              data_vendita:
                document.getElementById('vd_data_vendita').value || '',
              nome_device:
                document.getElementById('vd_nome_device').value.trim() || '',
              tipo_device:
                document.getElementById('vd_tipo_device').value || '',
              imei: document.getElementById('vd_imei').value.trim() || '',
              tipo_pagamento:
                document.getElementById('vd_tipo_pagamento').value || '',
              durata_pagamento_mesi:
                document.getElementById('vd_durata_pagamento').value || '',
              fornitore:
                document.getElementById('vd_fornitore').value.trim() || '',
              valore_cliente: 0,
              note: document.getElementById('vd_note').value.trim() || ''
            };
            await apiPost('createVenditaDevice', payload);
            showToast('Vendita device salvata correttamente', 'success');
            formDevice.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast(
              'Errore nel salvataggio vendita device: ' + msg,
              'error'
            );
          }
        });
      }

      const formRip = document.getElementById('formRiparazione');
      if (formRip) {
        formRip.addEventListener('submit', async function (e) {
          e.preventDefault();
          try {
            if (!selectedCliente || !selectedCliente.id_cliente) {
              showToast(
                'Seleziona prima un cliente sulla destra per associare la riparazione',
                'error'
              );
              return;
            }
            const payload = {
              id_cliente: selectedCliente.id_cliente,
              data_apertura:
                document.getElementById('rp_data_apertura').value || '',
              modello:
                document.getElementById('rp_modello').value.trim() || '',
              imei: document.getElementById('rp_imei').value.trim() || '',
              guasto:
                document.getElementById('rp_guasto').value.trim() || '',
              stato: document.getElementById('rp_stato').value || '',
              note: document.getElementById('rp_note').value.trim() || ''
            };
            await apiPost('createRiparazione', payload);
            showToast('Riparazione salvata correttamente', 'success');
            formRip.reset();
            refreshAll();
          } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : String(err);
            showToast(
              'Errore nel salvataggio riparazione: ' + msg,
              'error'
            );
          }
        });
      }
    }

    // Ritorna il primo campo non vuoto tra una lista di nomi possibili
    function getField(r, names) {
      for (var i = 0; i < names.length; i++) {
        var v = r[names[i]];
        if (v !== undefined && v !== null && String(v).trim() !== '') {
          return v;
        }
      }
      return '';
    }

    // Verifica se nella riga ci sono dati "da contratto"
    // (se non ce ne sono, importiamo solo il cliente)
    function hasContrattoData(r) {
      var keys = [
        'Data contratto',
        'Compagnia',
        'Tecnologia',
        'Numero lavorato',
        'Nome offerta',
        'Costo offerta',
        'Vincolo offerta (mesi)',
        'Telefono incluso'
      ];
      for (var i = 0; i < keys.length; i++) {
        var v = r[keys[i]];
        if (v && String(v).trim() !== '') return true;
      }
      return false;
    }

    function parseImportText() {
      const raw = document.getElementById('csvRaw').value || '';
      const lines = raw
        .split(/\r?\n/)
        .map(function (l) {
          return l.trim();
        })
        .filter(function (l) {
          return l.length > 0;
        });
      if (lines.length < 2) return [];

      function splitLine(line) {
        if (line.indexOf('\t') !== -1) return line.split('\t');
        if (line.indexOf(';') !== -1) return line.split(';');
        return line.split(',');
      }

      const header = splitLine(lines[0]);
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = splitLine(lines[i]);
        const obj = {};
        header.forEach(function (h, idx) {
          obj[h.trim()] = cols[idx] || '';
        });
        rows.push(obj);
      }
      return rows;
    }

    function previewImport() {
      const rows = parseImportText();
      importRows = rows;
      const tbody = document.getElementById('csvPreviewBody');
      const summary = document.getElementById('importSummary');
      const bar = document.getElementById('importProgress');
      if (tbody) tbody.innerHTML = '';
      if (bar) bar.style.width = '0%';

      if (!rows.length) {
        if (summary)
          summary.textContent = 'Nessuna riga da importare (controlla il testo).';
        return;
      }

      rows.forEach(function (r, idx) {
        // Mappiamo i campi dalle varie intestazioni possibili
        const nome = getField(r, ['Nome', 'NOME_RAG_SOC']);
        const cognome = getField(r, ['Cognome', 'COGNOME']);
        const telefono = getField(r, ['Telefono', 'cont_cel']);
        const cf = getField(r, ['Codice fiscale', 'COD_FISC_P_IVA']);
        const dataContratto = r['Data contratto'] || '';
        const compagnia = r['Compagnia'] || '';
        const tecnologia = r['Tecnologia'] || '';
        const numero = r['Numero lavorato'] || '';
        const offerta = r['Nome offerta'] || '';

        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
          (idx + 1) +
          '</td>' +
          '<td>' +
          (nome || '') +
          '</td>' +
          '<td>' +
          (cognome || '') +
          '</td>' +
          '<td>' +
          (telefono || '') +
          '</td>' +
          '<td>' +
          (cf || '') +
          '</td>' +
          '<td>' +
          (dataContratto || '') +
          '</td>' +
          '<td>' +
          (compagnia || '') +
          '</td>' +
          '<td>' +
          (tecnologia || '') +
          '</td>' +
          '<td>' +
          (numero || '') +
          '</td>' +
          '<td>' +
          (offerta || '') +
          '</td>';
        if (tbody) tbody.appendChild(tr);
      });

      if (summary)
        summary.textContent =
          'Anteprima: ' + rows.length + ' righe pronte per l\'import.';
    }

    async function runImport() {
      if (!importRows.length) {
        showToast('Fai prima l\'anteprima dell\'import', 'error');
        return;
      }
      const summary = document.getElementById('importSummary');
      const bar = document.getElementById('importProgress');
      let ok = 0;
      let err = 0;

      for (let i = 0; i < importRows.length; i++) {
        const r = importRows[i];
        try {
          const cf = (getField(r, ['Codice fiscale', 'COD_FISC_P_IVA']) || '')
            .trim()
            .toUpperCase();
          if (!cf) throw new Error('Codice fiscale vuoto alla riga ' + (i + 2));

          const idCli = await ensureClienteByCF(cf, {
            nome: getField(r, ['Nome', 'NOME_RAG_SOC']),
            cognome: getField(r, ['Cognome', 'COGNOME']),
            telefono: getField(r, ['Telefono', 'cont_cel']),
            email: getField(r, ['Email', 'cont_email']),
            data_nascita: r['Data nascita'] || '',
            note: r['Note'] || 'Import CSV'
          });

          // Se NON ci sono dati di contratto, importiamo solo il cliente
          if (!hasContrattoData(r)) {
            ok++;
            if (bar) {
              bar.style.width =
                String(Math.round(((i + 1) / importRows.length) * 100)) + '%';
            }
            continue;
          }

          const payloadContratto = {
            id_cliente: idCli,
            codice_fiscale: cf,
            data_contratto: r['Data contratto'] || '',
            tipo_cliente: r['Tipo cliente'] || '',
            tipo_attivazione: r['Tipo attivazione'] || '',
            tecnologia: r['Tecnologia'] || '',
            compagnia: r['Compagnia'] || '',
            convergenza: r['Convergenza'] || '',
            mnp: r['MNP'] || '',
            iccid_vecchio: r['ICCID vecchio'] || '',
            iccid_nuovo: r['ICCID nuovo'] || '',
            data_attivazione: r['Data attivazione'] || '',
            data_portabilita: r['Data portabilit√†'] || '',
            numero_lavorato: r['Numero lavorato'] || '',
            nome_offerta: r['Nome offerta'] || '',
            costo_offerta: r['Costo offerta'] || '',
            vincolo_offerta_mesi: r['Vincolo offerta (mesi)'] || '',
            telefono_incluso: r['Telefono incluso'] || '',
            imei: r['IMEI'] || '',
            modello: r['Modello'] || '',
            tipo_pagamento: r['Tipo pagamento'] || '',
            mesi_vincolo_telefono: r['Mesi vincolo telefono'] || '',
            data_fine_vincolo_offerta: r['Data fine vincolo offerta'] || '',
            data_fine_vincolo_telefono: r['Data fine vincolo telefono'] || ''
          };

          await apiPost('createContratto', payloadContratto);
          ok++;
        } catch (e) {
          console.error(e);
          err++;
        }

        if (bar) {
          bar.style.width =
            String(Math.round(((i + 1) / importRows.length) * 100)) + '%';
        }
      }

      if (summary) {
        summary.textContent =
          'Import finito. OK: ' +
          ok +
          ', Errori: ' +
          err +
          (err ? ' (controlla la console del browser per dettagli)' : '');
      }
      showToast(
        'Import terminato. OK: ' + ok + ', Errori: ' + err,
        err ? 'error' : 'success'
      );
      refreshAll();
    }

    function editContrattoFromCard(idContratto) {
      const ct = contrattiCache.find(function (c) {
        return c.id_contratto === idContratto;
      });
      if (!ct) {
        showToast('Contratto non trovato', 'error');
        return;
      }
      editingContratto = ct;

      switchSection('sec-nuovo-contratto');
      const lbl = document.getElementById('nc_submit_label');
      if (lbl) lbl.textContent = 'Aggiorna contratto';

      document.getElementById('nc_nome_cliente').value =
        (ct.nome_cliente || '').split(' ')[0] || '';
      document.getElementById('nc_cognome_cliente').value =
        (ct.nome_cliente || '').split(' ')[1] || '';
      document.getElementById('nc_telefono_cliente').value = '';
      document.getElementById('nc_email_cliente').value = '';
      document.getElementById('nc_cf_cliente').value = ct.codice_fiscale || '';
      document.getElementById('nc_data_nascita_cliente').value = '';

      document.getElementById('nc_data_contratto').value =
        ct.data_contratto || '';
      document.getElementById('nc_tipo_cliente').value = ct.tipo_cliente || '';
      document.getElementById('nc_tipo_attivazione').value =
        ct.tipo_attivazione || '';
      document.getElementById('nc_tecnologia').value = ct.tecnologia || '';
      document.getElementById('nc_compagnia').value = ct.compagnia || '';
      document.getElementById('nc_convergenza').value = ct.convergenza || '';
      document.getElementById('nc_mnp').value = ct.mnp || '';
      document.getElementById('nc_iccid_vecchio').value =
        ct.iccid_vecchio || '';
      document.getElementById('nc_iccid_nuovo').value = ct.iccid_nuovo || '';
      document.getElementById('nc_data_attivazione').value =
        ct.data_attivazione || '';
      document.getElementById('nc_data_portabilita').value =
        ct.data_portabilita || '';
      document.getElementById('nc_numero_lavorato').value =
        ct.numero_lavorato || '';
      document.getElementById('nc_nome_offerta').value =
        ct.nome_offerta || '';
      document.getElementById('nc_costo_offerta').value =
        ct.costo_offerta || '';
      document.getElementById('nc_vincolo_offerta_mesi').value =
        ct.vincolo_offerta_mesi || '';
      document.getElementById('nc_telefono_incluso').value =
        ct.telefono_incluso || '';
      document.getElementById('nc_imei').value = ct.imei || '';
      document.getElementById('nc_modello').value = ct.modello || '';
      document.getElementById('nc_tipo_pagamento').value =
        ct.tipo_pagamento || '';
      document.getElementById('nc_mesi_vincolo_telefono').value =
        ct.mesi_vincolo_telefono || '';
      document.getElementById('nc_data_fine_vincolo_offerta').value =
        ct.data_fine_vincolo_offerta || '';
      document.getElementById('nc_data_fine_vincolo_telefono').value =
        ct.data_fine_vincolo_telefono || '';
    }

    function formatDateForInput(dateString) {
      if (!dateString) return '';
      const parts = dateString.split('/');
      if (parts.length !== 3) return dateString;
      const day = parts[0].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
      return `${year}-${month}-${day}`;
    }

    function normalizeDateString(dateString) {
      if (!dateString) return '';
      let parts;
      if (dateString.includes('/')) {
        parts = dateString.split('/');
        if (parts.length === 3) {
          const day = parts[0].padStart(2, '0');
          const month = parts[1].padStart(2, '0');
          let year = parts[2];
          if (year.length === 2) {
            year = '20' + year;
          }
          const isoDate = `${year}-${month}-${day}`;
          return isoDate;
        }
      } else if (dateString.includes('-')) {
        parts = dateString.split('-');
        if (parts.length === 3) {
          const year = parts[0].padStart(4, '0');
          const month = parts[1].padStart(2, '0');
          const day = parts[2].padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
      }

      const parsedDate = new Date(dateString);
      if (!isNaN(parsedDate)) {
        const year = parsedDate.getFullYear();
        const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
        const day = String(parsedDate.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      return dateString;
    }

    function parseBirthDateFromCF(cf) {
      if (!cf || cf.length < 11) return '';
      const yearPart = cf.substring(6, 8);
      const monthPart = cf.substring(8, 9);
      const dayPart = cf.substring(9, 11);

      const mesi = {
        A: 1,
        B: 2,
        C: 3,
        D: 4,
        E: 5,
        H: 6,
        L: 7,
        M: 8,
        P: 9,
        R: 10,
        S: 11,
        T: 12
      };

      const month = mesi[monthPart];
      if (!month) return '';

      let day = parseInt(dayPart, 10);
      if (isNaN(day)) return '';

      const isFemale = day > 40;
      if (isFemale) day -= 40;

      const nowYear = new Date().getFullYear();
      let year = parseInt(yearPart, 10);
      if (isNaN(year)) return '';

      const currentYearTwoDigits = nowYear % 100;
      let fullYear;
      if (year <= currentYearTwoDigits) {
        fullYear = 2000 + year;
      } else {
        fullYear = 1900 + year;
      }
      if (fullYear + 100 <= nowYear) {
        fullYear += 100;
      }

      const dateObj = new Date(fullYear, month - 1, day);
      if (isNaN(dateObj.getTime())) return '';

      const yyyy = dateObj.getFullYear();
      let mm = dateObj.getMonth() + 1;
      let dd = dateObj.getDate();
      if (mm < 10) mm = '0' + mm;
      if (dd < 10) dd = '0' + dd;
      return yyyy + '-' + mm + '-' + dd;
    }

    function autopopulateBirthDate() {
      const cfInput = document.getElementById('nc_cf_cliente');
      const birthDateInput = document.getElementById('nc_data_nascita_cliente');

      if (!cfInput || !birthDateInput) return;

      cfInput.addEventListener('blur', function () {
        const cf = cfInput.value.trim().toUpperCase();
        const birthDate = parseBirthDateFromCF(cf);

        if (birthDate) {
          birthDateInput.value = birthDate;
        }
      });
    }

    function validateAndNormalizeDateInputs() {
      const dateInputs = document.querySelectorAll('input[type="date"]');

      dateInputs.forEach((input) => {
        input.addEventListener('blur', function () {
          let value = input.value.trim();

          if (!value) return;

          const normalized = normalizeDateString(value);

          if (normalized) {
            input.value = normalized;
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      autopopulateBirthDate();
      validateAndNormalizeDateInputs();
    });

    // Fine funzioni extra date / CF
    // (qui non c'√® altro codice nuovo, solo chiusure e setup generale)

    document.addEventListener('DOMContentLoaded', function () {
      // Questo listener √® gi√† presente nel file originale,
      // rimane per fare il setup del CRM
      switchSection('sec-dashboard');
      setupForms();
      refreshAll();
    });
  </script>
</body>
</html>
